---
layout: default
title: 25. Postgresql indexing ν™μ„±ν™”
parent: π“ μ‹¤μ‹κ°„ μ±„ν…μ„λ²„ ν”„λ΅μ νΈ
nav_order: 25
---
created at 2023-03-16
{: .label .label-yellow }

#### INDEX
1. μΈλ±μ‹±λ user_id, κ·Έλ¬λ‚ Sequential...
2. κ·Έλ ‡λ‹¤λ©΄ μ–΄λ–»κ² μ‚¬μ©ν•λ„λ΅ ν•  μ μμ„κΉμ”?
3. μκµ¬μ μΈ μΈλ±μ‹± ν™μ© μΏΌλ¦¬μ„¤μ •(feat. AWS RDS)
   1. νλΌλ―Έν„° κ·Έλ£Ή μƒμ„±
   2. enable_seqscan νλΌλ―Έν„° μμ •
   3. RDS μΈμ¤ν„΄μ¤μ νλΌλ―Έν„° κ·Έλ£Ή λ³€κ²½
   4. κ²°κ³Ό ν™•μΈ

μ΄μ „κΉμ§€ select λ¬Έλ¥Ό ν¨κ³Όμ μΌλ΅ μ‚¬μ©ν•κ³  μλ‹¤κ³  μƒκ°ν–λ”λ° μ‚¬μ‹¤ indexingμ„ μ „ν€ ν™μ©ν•κ³  μμ§€ μ•μ•μ—μµλ‹λ‹¤.
> Sequential ν•κ² μ²μλ¶€ν„° λκΉμ§€ ν™•μΈν•κ³  μλ”λΌκµ¬μ” γ…γ…. μλ¥Ό λ“¤μ–΄μ„ μ €λ” 400λ§κ±΄μ rowλ¥Ό κ°€μ§€λ” ν…μ΄λΈ” λ‚΄ user_idκ°€ 'A'μΈ μ μ €λ¥Ό μΏΌλ¦¬ν•λ” λ©”μ†λ“κ°€ μμ–΄μ”. κ·Έλ¦¬κ³  μ΄ A μ μ €κ°€ row λ§¨ λμ— μλ‹¤κ³  ν–μ„ λ•, 400λ§κ±΄ μ „μ²΄λ¥Ό linear ν•κ² μ½μ–΄μ„ μ²λ¦¬ν•λ‹¤λ” λ»μ΄μ£ ! λ§¤μ°λ§¤μ°λ§¤μ° cost κ°€ λ§μ΄ λ“¤μ–΄κ°€λ” λ°©λ²•μ…λ‹λ‹¤.

**μ™ μ‚¬μ©ν•κ³  μμ§€ μ•μ•μ„κΉμ”?** λ¶„λ… index μ •λ³΄λ¥Ό λ³΄λ©΄, btree μ•κ³ λ¦¬μ¦μΌλ΅ μ λ‹ν¬ν• user_idμ— λ€ν•΄ μΈλ±μ¤κ°€ λ§λ“¤μ–΄μ΅λ”λ° λ§μ΄μ£ !
> μ°Έκ³ λ΅ `Row Exclusive Lock`μ€ μΈλ±μ¤μ— λ¨Όμ € κ±Έκ³  κ·Έ λ‹¤μ ν…μ΄λΈ”μ— Lockμ„ κ²λ‹λ‹¤.   

## 1. μΈλ±μ‹±λ user_id, κ·Έλ¬λ‚ Sequential...

![img](../../../assets/img/performance/3.png)

μ„μ κ·Έλ¦Όμ—μ„ ν™•μΈν•  μ μλ“―μ΄, Postgresql μ΄ user_table_pkey λΌλ” μΈλ±μ¤λ¥Ό μλ™μΌλ΅ λ§λ“¤μ–΄λ†“μ£ ?(λ¬Όλ΅  PK λ¥Ό μ„¤μ •ν•΄μ„ λ§λ“¤μ–΄ λ†“λ” κ²ƒμ…λ‹λ‹¤) κ·Έλ ‡μ§€λ§, **μΈλ±μ‹±λ user_idμ™€ κ·Έλ ‡μ§€ μ•μ€ user_pw μ „λ¶€ `Seq Scan`** ν•κ³  μλ” κ²ƒμ„ ν™•μΈν•  μ μμ–΄μ”.

μ΄λ° μ΄μ λ” **κΈ°λ³Έμ μΌλ΅ postgresλ” μ „λ¶€ λ¦¬λ‹μ–΄ν•κ² μ½λ„λ΅ μ„¤μ •**λκΈ° λ•λ¬Έμ…λ‹λ‹¤.

## 2. κ·Έλ ‡λ‹¤λ©΄ μ–΄λ–»κ² μ‚¬μ©ν•λ„λ΅ ν•  μ μμ„κΉμ”?

**μΌμ‹μ μΈ λ°©λ²•**μΌλ΅λ” `set enable_seqscan = off` μΏΌλ¦¬λ΅ λ™μΌ νΈλμ μ… λ‚΄ μΏΌλ¦¬κ°€ μΈλ±μ‹±μ„ ν™μ©ν•  μ μλ„λ΅ μ„¤μ •ν•  μ μμ–΄μ”!

![img](../../../assets/img/performance/2.png)

## 3. μκµ¬μ μΈ μΈλ±μ‹± μΏΌλ¦¬μ„¤μ •(feat. AWS RDS)

μκµ¬μ μΈ λ°©λ²•μΌλ΅λ” `postgres.conf` νμΌμ enable_seqscanμ„ offλ΅ μμ •ν•λ”κ±°μ—μ”!

μ €λ” AWS RDSλ¥Ό μ‚¬μ©ν•κΈ°μ— ν•΄λ‹Ή νλΌλ―Έν„°λ¥Ό κ°„λ‹¨ν•κ² μμ •ν•  μ μμ–΄μ”.
### 3-1. **νλΌλ―Έν„° κ·Έλ£Ή μƒμ„±**
**κΈ°λ³Έμ„¤μ •κ·Έλ£Ήμ—μ„λ” ν•΄λ‹Ή νλΌλ―Έν„°λ¥Ό μμ •ν•  μ μ—†μµλ‹λ‹¤**. λ”°λΌμ„ μ°λ¦¬λ” μƒλ΅­κ² νλΌλ―Έν„° κ·Έλ£Ήμ„ μƒμ„±ν• κ±°μ—μ”.
![img](../../../assets/img/performance/5.png)
![img](../../../assets/img/performance/4.png)
### 3-2. **νλΌλ―Έν„° μμ •**
![img](../../../assets/img/performance/6.png)
### 3-3. **RDS μΈμ¤ν„΄μ¤μ νλΌλ―Έν„° κ·Έλ£Ή λ³€κ²½**
![img](../../../assets/img/performance/7.png)
![img](../../../assets/img/performance/8.png)
### 3-4. **κ²°κ³Ό ν™•μΈ**
κµ³μ΄ `set enable_seqscan = off` λ¥Ό λ§¤ νΈλμ μ… μ•μ— λ‘μ§€ μ•κ³ λ„ λ‹¤μκ³Ό κ°™μ΄ μΈλ±μ‹±μ„ ν™μ©ν•λ” κ²ƒμ„ λ³Ό μ μμ–΄μ”.
![img](../../../assets/img/performance/9.png)
μ•„μ°Έ. `enable_seqscan` μ„ off λ΅ μ„¤μ •ν•λ‹¤κ³  ν•λ”λΌλ„ μ—¬μ „ν μ‹ν€€μ…λ΅ μ¤μΊλ‹ ν•  μ μλ‹µλ‹λ‹¤!(indexing λμ§€ μ•λ” μ»¬λΌ μ΅°ν μ‹)
### 3-5. **max_connection λν• λ³€κ²½ κ°€λ¥**
νλΌλ―Έν„° κ·Έλ£Ήμ—μ„ DBμ connection κ°μλ„ μ§μ ‘ λ³€κ²½ν•  μ μμ–΄μ”. μ €κ°™μ€ κ²½μ°μ—λ” 83κ°λ΅ μ„¤μ •λμ–΄ μμµλ‹λ‹¤.
![img](../../../assets/img/performance/10.png)
