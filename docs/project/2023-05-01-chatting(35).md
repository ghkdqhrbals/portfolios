---
layout: default
title: 35. Spring Cloud ê¸°ë°˜ MSA ë³€í™˜ ì‹œìž‘-9(ì„±ëŠ¥ì´ìŠˆ í•´ê²° ê³¼ì •)
parent: ðŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 35
---

MSA ë²„ì „ê³¼ ì´ì „ ëª¨ë…¸ ë²„ì „ì—ì„œì˜ **ë³€ê²½ëœ ì **ê³¼ **ì„±ëŠ¥ ë¬¸ì œì ** ë° **í•´ê²° ê³¼ì •**ì„ ì„¤ëª…í•˜ë ¤ í•©ë‹ˆë‹¤.

ì¼ë‹¨ ë¨¼ì € ë³€ê²½ì ì„ ì•„ëž˜ì™€ ê°™ì´ ì •ë¦¬í•´ë³´ì•˜ì–´ìš”.

# 1. ë³€ê²½ëœ ì 

| ë³€ê²½ì                                  | ê¸°ì¡´                                                             | ë³€ê²½                                                                                                                                                                                                                 |
|-------------------------------------|----------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Tomcat -> Netty -> Undertow**     | Tomcat ì„ ì‚¬ìš©í•˜ë©´ì„œ max connection = 10000 ì„ í†µí•´ ë™ì‹œì„± ì¦ëŒ€ ë° timeout ì„¤ì • | [Netty ìž¥ì  í¬ìŠ¤íŒ…](https://ghkdqhrbals.github.io/portfolios/docs/Java/6/) Non-blocking ì— ìµœì í™”ë¨. í•˜ì§€ë§Œ Netty ì˜ ì„¤ì •ë“¤ì„ Spring boot ì—ì„œ ë³€ê²½í•˜ê¸°ê°€ ê¹Œë‹¤ë¡œì›€. yaml íŒŒì¼ë¡œ configuration í•  ìˆ˜ ìžˆëŠ” ë©”ì†Œë“œë“¤ì´ ë³„ë¡œ ì—†ê¸°ë•Œë¬¸. ê·¸ëž˜ì„œ Netty based Undertow ë¥¼ ì‚¬ìš©. |
| **ì„œë¹„ìŠ¤ ë³„ RDB ë¶„í• **                    | RDS 1ëŒ€ë¥¼ ìœ ì € ì„œë¹„ìŠ¤/ì±„íŒ… ì„œë¹„ìŠ¤/ê³ ê° ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•¨                              | AWS RDS 1ëŒ€ë¥¼ ìœ ì € ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•˜ê³ , ì±„íŒ…ê³¼ ê³ ê°ì„œë¹„ìŠ¤ëŠ” ê°ê° local RDB ë¥¼ ì‚¬ìš©í•¨                                                                                                                                                            |
| **ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ ìºì‹± ê´€ë¦¬**                  | ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ ê°œë…ì´ ì—†ì—ˆìŒ                                               | ì´ë²¤íŠ¸ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëžœì ì…˜ìœ¼ë¡œ ì¼ê´€ë˜ë„ë¡ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸”ì„ ì¶”ê°€í•¨. update:O, event-sourcing:X. Sagaì˜ Orchestration íŒ¨í„´! í•´ë‹¹ ë¶€ë¶„ì„ RDBë¡œ ì²˜ë¦¬í•˜ê¸°ì—” ìƒë‹¹í•œ ë¦¬ì†ŒìŠ¤ê°€ ì†Œëª¨ë¨. ë”°ë¼ì„œ Redis ë¡œ ê´€ë¦¬.                                                                           |
| **ë©”ì„¸ì§€ í ìƒì„¸ ì„¤ì •**                     | MQ ì‚¬ìš©ì„ í–ˆì§€ë§Œ, ì‘ë‹µê³¼ ë¡¤ë°±ì„ ë°›ì§€ ì•Šì•˜ìŒ                                     | Kafka ì„¤ì • ë° [ìœ ì € ê´€ë¦¬ ìš”ì²­, ìœ ì € ê´€ë¦¬ ì‘ë‹µ, ì±„íŒ…ìœ ì € ë³´ìƒ ì´ë²¤íŠ¸, ê³ ê°ìœ ì € ë³´ìƒ ì´ë²¤íŠ¸] ì´ 4ê°€ì§€ í† í”½ê³¼ íŒŒí‹°ì…˜ ì¶”ê°€                                                                                                                                         |
| **Spring-cloud configuration ì¶”ê°€**   | ê°ê°ì˜ configuration íŒŒì¼ì„ ë”°ë¡œ ê´€ë¦¬í•˜ì˜€ìŒ                                 | config-server ì™€ rabbitmq ë¥¼ í†µí•´ gitì—ì„œ ì„¤ì • íŒŒì¼ì„ í´ë¡ í•˜ê³  ì´ë¥¼ ëª¨ë“  ì„œë²„ê°€ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ í•¨. ë˜í•œ ëª¨ë‘ ëª¨ë“ˆí™”í•˜ì—¬ í†µí•© gradle ê´€ë¦¬ ì„¤ì •                                                                                                                 |
| **Spring-cloud eureka, gateway ì¶”ê°€** | nginx ë¡œ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ endpoint ë¥¼ **ì§ì ‘** ì—®ì–´ì£¼ì—ˆìŒ                       | eureka ì„œë²„ì— ë“±ë¡í•˜ê³  gateway ëŠ” ì´ë¥¼ ìžì²´ì ìœ¼ë¡œ load-balancing í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìŒ                                                                                                                                                        |
| **Spring-security, JWT ì¸ì¦/ì¸ê°€ ì¶”ê°€**   | ì¸ì¦ê³¼ ì¸ê°€ë¥¼ ì„¸ì…˜ìœ¼ë¡œ ê´€ë¦¬í•¨                                               | ì„¸ì…˜ ê´€ë¦¬ + JWT í† í°ì˜ payload ì— ì €ìž¥ëœ permission ì •ë³´, ìœ ì €ID ë¥¼ í†µí•´ ì¸ì¦ê³¼ ì¸ê°€ë¥¼ êµ¬í˜„í•¨. íŠ¹ížˆ Reactor ì„¤ì •ì„ ë”°ë¡œ í•˜ì˜€ìŒ                                                                                                                          |


# 2. ì„±ëŠ¥ë¹„êµ ë° ë¬¸ì œì 

![img](../../../assets/img/msa/113.svg)

ìƒê°ë³´ë‹¤ ìƒë‹¹ížˆ ë‚®ì€ ì„±ëŠ¥ ìˆ˜ì¹˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. í˜„ìž¬ ìƒê°í•˜ëŠ” ë¬¸ì œì ì€ ìœ ì € ì„œë¹„ìŠ¤ì—ì„œ Kafkaê¹Œì§€ ë©”ì„¸ì§€ê°€ ì „ì†¡ë˜ëŠ” ë¹„ìœ¨ì´ ìƒë‹¹ížˆ ë‚®ë‹¤ëŠ” ì ìž…ë‹ˆë‹¤. ì•„ëž˜ì˜ ê·¸ë¦¼ì„ ë³´ë©´ ì´í•´ê°€ ë ê±°ì—ìš”(ì•„ëž˜ì˜ ê·¸ë¦¼ì€ **ë™ì‹œì— 100ê°œì˜ API ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ Kafka í† í”½ ë‚´ ìƒˆë¡œìš´ record ê°œìˆ˜**ìž…ë‹ˆë‹¤).

![img](../../../assets/img/msa/115.png)
![img](../../../assets/img/msa/116.png)

ë³´ì‹œë‹¤ì‹œí”¼ ìœ ì € ì„œë¹„ìŠ¤ì—ì„œ Kafka ì— ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ëŠ” rateê°€ ì´ˆë‹¹ **í‰ê· ì ìœ¼ë¡œ 10ê°œ** ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ê³ ê° ì„œë¹„ìŠ¤ë‚˜ ì±„íŒ… ì„œë¹„ìŠ¤ì—ì„œ ì´ë¥¼ ì†Œë¹„í•˜ëŠ” ë¶€ë¶„ì—ì„œëŠ” ë¬¸ì œê°€ ì—†ì£ . ì• ì´ˆì— ì ì€ ìˆ˜ì˜ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ ë°›ì•˜ìœ¼ë‹ˆê¹Œìš”!

ê·¸ëž˜ì„œ ì´ ë¶€ë¶„ì„ ì•„ëž˜ì˜ ëª‡ê°€ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì§€ê³  ê°œì„ í•˜ë ¤ê³  í•©ë‹ˆë‹¤(ì ë‹¤ë³´ë‹ˆ ë§Žë„¤ìš”ã…Žã…Ž...).

1. Undertow ì˜ ì ì€ parellel thread
2. Spring Security ì˜ í† í° í™•ì¸ ì ˆì°¨ì—ì„œ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ë”œë ˆì´ ë¬¸ì œ
3. ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ì„ ê´€ë¦¬í•˜ëŠ” Redis ì €ìž¥ ì„±ëŠ¥ ë¬¸ì œ
4. ì ì€ Kafka Producer ìŠ¤ë ˆë“œ ê°œìˆ˜
5. linger.ms ì™€ batch_size ë¬¸ì œ
6. ìž¦ì€ ìŠ¤ë ˆë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë†’ì€ Context Switch ë¹„ìš©
7. CPU/Memory ë¶€ì¡±


# 3. ì„±ëŠ¥ ì´ìŠˆ í•´ê²°
## 3.1 (Step1)ê³¼ì •

| ë¬¸ì œì  | ì„¤ëª…                                                                                                                                                                                                                                                                                                                                                                    |  ë¬¸ì œì˜€ë‚˜?   |
|------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------:|
|Undertow ì˜ ì ì€ parellel thread|| â³                                                                                                                                                                                                                                                                                                                                                                     |
|Spring Security ì˜ í† í° í™•ì¸ ì ˆì°¨ì—ì„œ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ë”œë ˆì´ ë¬¸ì œ|| â³                                                                                                                                                                                                                                                                                                                                                                     |
|ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ì„ ê´€ë¦¬í•˜ëŠ” Redis ì €ìž¥ ì„±ëŠ¥ ë¬¸ì œ| ì‹¤ì¸¡ ê²°ê³¼, ì¸ìƒì ì´ì˜€ìŠµë‹ˆë‹¤. ë™ì‹œì— 100ê°œì˜ ìš”ì²­ ì‹œ, 258ms ì†Œìš”. ë™ì‹œì—                                                                                                                                                                                                                                                                                                                        |    âŒ     |
|ì ì€ Kafka Producer ìŠ¤ë ˆë“œ ê°œìˆ˜| Producer ìŠ¤ë ˆë“œë¥¼ ëŠ˜ë ¤ë„ ë˜‘ê°™ì„ ê±°ì—ìš”. ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•¨ì— ìžˆì–´ í•„ìš”í•œ ê²ƒì€ 1. ì¶©ë¶„í•œ CPU ë¦¬ì†ŒìŠ¤, 2. ì¶©ë¶„í•œ ë„¤íŠ¸ì›Œí¬ ìž…ë‹ˆë‹¤. ì¶©ë¶„í•œ ë„¤íŠ¸ì›Œí¬ëŠ” ì•„ëž˜ì˜ `linger.ms ì™€ batch_size ë¬¸ì œ`ì—ì„œ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ì¶©ë¶„í•œ CPU ë¦¬ì†ŒìŠ¤ëŠ” ë¬¸ì œê°€ ë˜ì§€ ì•Šë‹¤ê³  ë³´ì—¬ì§‘ë‹ˆë‹¤. ì™œëƒí•˜ë©´, ê¸°ì¡´ì— Mono ì„œë²„ì—ì„œë„ ì‹±ê¸€ Producer ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ì˜€ì„ ë•Œ ë†’ì€ ì„±ëŠ¥ì´ ë‚˜ì™”ê¸° ë•Œë¬¸ì´ì£ . ì¦‰, ìŠ¤ë ˆë“œë¥¼ ëŠë¦°ë‹¤ê³  í•˜ë”ë¼ë„ ì„±ëŠ¥ì´ ì¦ê°€í•˜ì§€ ì•Šì„ê±°ì—ìš”. ì‹¤ì¸¡ ê²°ê³¼, ì „ì†¡ ì†ë„ëŠ” ë™ì‹œì— 100ê°œì˜ ìš”ì²­ì„ ë°›ì•˜ì„ ë•Œ, 493ms ê°€ ê±¸ë¦½ë‹ˆë‹¤.                              | âŒ|
|linger.ms ì™€ batch_size ë¬¸ì œ| linger.ms ëŠ” ì´ë²¤íŠ¸ ì „ì†¡ ëŒ€ê¸° ì‹œê°„, batch_sizeëŠ” ì´ë²¤íŠ¸ë¥¼ ë¬¶ì–´ì„œ ë³´ë‚´ëŠ” í¬ê¸° ìž…ë‹ˆë‹¤.ê¸°ì¡´ì—ëŠ” ì´ë²¤íŠ¸ ì „ì†¡ ì „ê¹Œì§€ 50ms ê¸°ë‹¤ë¦¬ê³  ìµœëŒ€í•œ 50ê°œë¥¼ ë¬¶ì–´ì„œ ë³´ë‚´ë„ë¡ ì„¤ì •í–ˆì–´ìš”. í•˜ì§€ë§Œ, ë³´ë‹¤ì‹œí”¼ í‰ê· ì ìœ¼ë¡œ 10ê°œë§Œ ë³´ë‚´ëŠ” ê²ƒì„ ì´ë¯¸ ìš°ë¦¬ê°€ í™•ì¸í–ˆì£ . ì¦‰, **ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ë¡œë“œëŠ” ë‚®ë‹¤, ë•Œë¬¸ì— ë¬¸ì œê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤**. ë¼ë„ íŒë‹¨ë©ë‹ˆë‹¤.                                                                                                                                                   |âŒ|
|ìž¦ì€ ìŠ¤ë ˆë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë†’ì€ Context Switch ë¹„ìš©|| â³                                                                                                                                                                                                                                                                                                                                                                     |
|CPU/Memory ë¶€ì¡±| 18ê°œ ì»¨í…Œì´ë„ˆì˜ CPU ì ìœ  ëª©ë¡ ![img](../../../assets/img/msa/117.png) ![img](../../../assets/img/msa/118.png) ë„ì»¤ê°€ ë§Žì€ CPU ë¥¼ ì†Œëª¨í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ê·¸ ì¤‘ íŠ¹ížˆ **ìœ ì € ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ**ì— CPU usage : **821%** ë¡œ ë§Žì€ ê³¼ë¶€í•˜ê°€ ê±¸ë¦¬ê³  ìžˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìžˆì–´ìš”. ì´ëŠ” ì§ì ‘ì ì¸ ê°œì„ ì ì´ ì•„ë‹Œ ê°„ì ‘ì ì¸ ê°œì„ ì ì´ê² ì£ ? ë˜í•œ, **ì‹¤ì œ í…ŒìŠ¤íŠ¸ê°€ ëë‚œ ì´í›„ì—ë„ ê³„ì† CPUë¥¼ ìž¡ì•„ë¨¹ê³  ìžˆìŠµë‹ˆë‹¤**... ì™œ ì´ëŸ°ê±¸ê¹Œìš”ã…œã…œ. ë­”ê°€ í°ì¼ì´ ë‚¬ìŠµë‹ˆë‹¤. Kafka ë©”ì„¸ì§€ì—ì„œ ë°œìƒí•œ ì˜¤ë¥˜ì²˜ë¦¬ë¥¼ ê³„ì† ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì¼ê¹Œìš”? offsetìœ¼ë¡œ ë³´ë©´ ë¬¸ì œê°€ ì—†ëŠ”ë° ë§ì´ì£ . | âœ…                                                                                                                                                                                                                                                                                       |


## 3.2 (Step2)ê³¼ì •



1. Undertow ì˜ ì ì€ parellel thread
2. Spring Security ì˜ í† í° í™•ì¸ ì ˆì°¨ì—ì„œ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ë”œë ˆì´ ë¬¸ì œ
3. ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ì„ ê´€ë¦¬í•˜ëŠ” Redis ì €ìž¥ ì„±ëŠ¥ ë¬¸ì œ
4. ì ì€ Kafka Producer ìŠ¤ë ˆë“œ ê°œìˆ˜
5. linger.ms ì™€ batch_size ë¬¸ì œ
6. ìž¦ì€ ìŠ¤ë ˆë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë†’ì€ Context Switch ë¹„ìš©
7. CPU/Memory ë¶€ì¡±
8. SSE ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ Flux ìŠ¤ë ˆë“œì˜ ì§€ì†ì ì¸ ì‚¬ìš©
9. Kafka ì´ë²¤íŠ¸ ì „ì†¡/ìˆ˜ì‹  ì‹œ, ìŠ¤ë ˆë“œ ë°ë“œë½
10. (metadata.max.age.ms) ì¹´í”„ì¹´ ì´ˆê¸° í† í”½ìœ¼ë¡œë¶€í„° ë©”íƒ€ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê¸° ìœ„í•œ ë”œë ˆì´ íƒ€ìž„ì•„ì›ƒ ë¯¸ì„¤ì • default:5min
11. 

linger.ms = 50ms
kafka batch = 10
service max thread = 10 
Redis Save Time : 146, time:24, counts:100,
Kafka Sender Time : 363, time:418, counts:100

**ì‹œê°„ì´ ì§€ì†ë  ìˆ˜ë¡ Kafka Sender Time ì´ ì¦ê°€í•˜ëŠ” í˜„ìƒì„ ë°œê²¬!**
Kafka ì „ì†¡ íŠ¸ëž˜í”½ì´ ìŒ“ì´ëŠ” ê²ƒ.

* Producer ì—ì„œ ìž¬ì „ì†¡ í•˜ëŠ” ë¶€ë¶„ì—ì„œ íŠ¸ëž˜í”½ì´ ë°œìƒí•œ ê²ƒìœ¼ë¡œ ë³´ìž„!
> ë©±ë“±ì„± off ë¡œ ì œê±°.
* 

request.timeout.ms = 30000
**retries = 2147483647**