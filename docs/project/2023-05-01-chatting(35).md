---
layout: default
title: 35. Spring Cloud ê¸°ë°˜ MSA ë³€í™˜ ì‹œìž‘-9(ì„±ëŠ¥ì´ìŠˆ í•´ê²° ê³¼ì •)
parent: ðŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 35
---

MSA ë²„ì „ê³¼ ì´ì „ ëª¨ë…¸ ë²„ì „ì—ì„œì˜ **ë³€ê²½ëœ ì **ê³¼ **ì„±ëŠ¥ ë¬¸ì œì ** ë° **í•´ê²° ê³¼ì •**ì„ ì„¤ëª…í•˜ë ¤ í•©ë‹ˆë‹¤.

ì¼ë‹¨ ë¨¼ì € ë³€ê²½ì ì„ ì•„ëž˜ì™€ ê°™ì´ ì •ë¦¬í•´ë³´ì•˜ì–´ìš”.

# 1. ë³€ê²½ëœ ì 

| ë³€ê²½ì                                  | ê¸°ì¡´                                                             | ë³€ê²½                                                                                                                                                                                                                 |
|-------------------------------------|----------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Tomcat -> Netty -> Undertow**     | Tomcat ì„ ì‚¬ìš©í•˜ë©´ì„œ max connection = 10000 ì„ í†µí•´ ë™ì‹œì„± ì¦ëŒ€ ë° timeout ì„¤ì • | [Netty ìž¥ì  í¬ìŠ¤íŒ…](https://ghkdqhrbals.github.io/portfolios/docs/Java/6/) Non-blocking ì— ìµœì í™”ë¨. í•˜ì§€ë§Œ Netty ì˜ ì„¤ì •ë“¤ì„ Spring boot ì—ì„œ ë³€ê²½í•˜ê¸°ê°€ ê¹Œë‹¤ë¡œì›€. yaml íŒŒì¼ë¡œ configuration í•  ìˆ˜ ìžˆëŠ” ë©”ì†Œë“œë“¤ì´ ë³„ë¡œ ì—†ê¸°ë•Œë¬¸. ê·¸ëž˜ì„œ Netty based Undertow ë¥¼ ì‚¬ìš©. |
| **ì„œë¹„ìŠ¤ ë³„ RDB ë¶„í• **                    | RDS 1ëŒ€ë¥¼ ìœ ì € ì„œë¹„ìŠ¤/ì±„íŒ… ì„œë¹„ìŠ¤/ê³ ê° ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•¨                              | AWS RDS 1ëŒ€ë¥¼ ìœ ì € ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©í•˜ê³ , ì±„íŒ…ê³¼ ê³ ê°ì„œë¹„ìŠ¤ëŠ” ê°ê° local RDB ë¥¼ ì‚¬ìš©í•¨                                                                                                                                                            |
| **ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ ìºì‹± ê´€ë¦¬**                  | ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ ê°œë…ì´ ì—†ì—ˆìŒ                                               | ì´ë²¤íŠ¸ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëžœì ì…˜ìœ¼ë¡œ ì¼ê´€ë˜ë„ë¡ ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸”ì„ ì¶”ê°€í•¨. update:O, event-sourcing:X. Sagaì˜ Orchestration íŒ¨í„´! í•´ë‹¹ ë¶€ë¶„ì„ RDBë¡œ ì²˜ë¦¬í•˜ê¸°ì—” ìƒë‹¹í•œ ë¦¬ì†ŒìŠ¤ê°€ ì†Œëª¨ë¨. ë”°ë¼ì„œ Redis ë¡œ ê´€ë¦¬.                                                                           |
| **ë©”ì„¸ì§€ í ìƒì„¸ ì„¤ì •**                     | MQ ì‚¬ìš©ì„ í–ˆì§€ë§Œ, ì‘ë‹µê³¼ ë¡¤ë°±ì„ ë°›ì§€ ì•Šì•˜ìŒ                                     | Kafka ì„¤ì • ë° [ìœ ì € ê´€ë¦¬ ìš”ì²­, ìœ ì € ê´€ë¦¬ ì‘ë‹µ, ì±„íŒ…ìœ ì € ë³´ìƒ ì´ë²¤íŠ¸, ê³ ê°ìœ ì € ë³´ìƒ ì´ë²¤íŠ¸] ì´ 4ê°€ì§€ í† í”½ê³¼ íŒŒí‹°ì…˜ ì¶”ê°€                                                                                                                                         |
| **Spring-cloud configuration ì¶”ê°€**   | ê°ê°ì˜ configuration íŒŒì¼ì„ ë”°ë¡œ ê´€ë¦¬í•˜ì˜€ìŒ                                 | config-server ì™€ rabbitmq ë¥¼ í†µí•´ gitì—ì„œ ì„¤ì • íŒŒì¼ì„ í´ë¡ í•˜ê³  ì´ë¥¼ ëª¨ë“  ì„œë²„ê°€ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ í•¨. ë˜í•œ ëª¨ë‘ ëª¨ë“ˆí™”í•˜ì—¬ í†µí•© gradle ê´€ë¦¬ ì„¤ì •                                                                                                                 |
| **Spring-cloud eureka, gateway ì¶”ê°€** | nginx ë¡œ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ endpoint ë¥¼ **ì§ì ‘** ì—®ì–´ì£¼ì—ˆìŒ                       | eureka ì„œë²„ì— ë“±ë¡í•˜ê³  gateway ëŠ” ì´ë¥¼ ìžì²´ì ìœ¼ë¡œ load-balancing í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìŒ                                                                                                                                                        |
| **Spring-security, JWT ì¸ì¦/ì¸ê°€ ì¶”ê°€**   | ì¸ì¦ê³¼ ì¸ê°€ë¥¼ ì„¸ì…˜ìœ¼ë¡œ ê´€ë¦¬í•¨                                               | ì„¸ì…˜ ê´€ë¦¬ + JWT í† í°ì˜ payload ì— ì €ìž¥ëœ permission ì •ë³´, ìœ ì €ID ë¥¼ í†µí•´ ì¸ì¦ê³¼ ì¸ê°€ë¥¼ êµ¬í˜„í•¨. íŠ¹ížˆ Reactor ì„¤ì •ì„ ë”°ë¡œ í•˜ì˜€ìŒ                                                                                                                          |


# 2. ì„±ëŠ¥ë¹„êµ ë° ë¬¸ì œì 

![img](../../../assets/img/msa/113.svg)

ìƒê°ë³´ë‹¤ ìƒë‹¹ížˆ ë‚®ì€ ì„±ëŠ¥ ìˆ˜ì¹˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. í˜„ìž¬ ìƒê°í•˜ëŠ” ë¬¸ì œì ì€ ìœ ì € ì„œë¹„ìŠ¤ì—ì„œ Kafkaê¹Œì§€ ë©”ì„¸ì§€ê°€ ì „ì†¡ë˜ëŠ” ë¹„ìœ¨ì´ ìƒë‹¹ížˆ ë‚®ë‹¤ëŠ” ì ìž…ë‹ˆë‹¤. ì•„ëž˜ì˜ ê·¸ë¦¼ì„ ë³´ë©´ ì´í•´ê°€ ë ê±°ì—ìš”(ì•„ëž˜ì˜ ê·¸ë¦¼ì€ **ë™ì‹œì— 100ê°œì˜ API ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ Kafka í† í”½ ë‚´ ìƒˆë¡œìš´ record ê°œìˆ˜**ìž…ë‹ˆë‹¤).

![img](../../../assets/img/msa/115.png)
![img](../../../assets/img/msa/116.png)

ë³´ì‹œë‹¤ì‹œí”¼ ìœ ì € ì„œë¹„ìŠ¤ì—ì„œ Kafka ì— ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ëŠ” rateê°€ ì´ˆë‹¹ **í‰ê· ì ìœ¼ë¡œ 10ê°œ** ì¸ê²ƒì„ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ê³ ê° ì„œë¹„ìŠ¤ë‚˜ ì±„íŒ… ì„œë¹„ìŠ¤ì—ì„œ ì´ë¥¼ ì†Œë¹„í•˜ëŠ” ë¶€ë¶„ì—ì„œëŠ” ë¬¸ì œê°€ ì—†ì£ . ì• ì´ˆì— ì ì€ ìˆ˜ì˜ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ ë°›ì•˜ìœ¼ë‹ˆê¹Œìš”!

ê·¸ëž˜ì„œ ì´ ë¶€ë¶„ì„ ì•„ëž˜ì˜ ëª‡ê°€ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì§€ê³  ê°œì„ í•˜ë ¤ê³  í•©ë‹ˆë‹¤(ì ë‹¤ë³´ë‹ˆ ë§Žë„¤ìš”ã…Žã…Ž...).

1. Undertow ì˜ ì ì€ parellel thread
2. Spring Security ì˜ í† í° í™•ì¸ ì ˆì°¨ì—ì„œ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ë”œë ˆì´ ë¬¸ì œ
3. ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ì„ ê´€ë¦¬í•˜ëŠ” Redis ì €ìž¥ ì„±ëŠ¥ ë¬¸ì œ
4. ì ì€ Kafka Producer ìŠ¤ë ˆë“œ ê°œìˆ˜
5. linger.ms ì™€ batch_size ë¬¸ì œ
6. ìž¦ì€ ìŠ¤ë ˆë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë†’ì€ Context Switch ë¹„ìš©
7. CPU/Memory ë¶€ì¡±
8. SSE ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ Flux ìŠ¤ë ˆë“œì˜ ì§€ì†ì ì¸ ì‚¬ìš©
9. Kafka ì´ë²¤íŠ¸ ì „ì†¡/ìˆ˜ì‹  ì‹œ, ìŠ¤ë ˆë“œ ë°ë“œë½

# 3. ì„±ëŠ¥ ì´ìŠˆ í•´ê²° ì¤‘

| ë¬¸ì œì  | ì„¤ëª…                                                                                                                                                                                                                                                                                                                                                                      |  ë¬¸ì œì˜€ë‚˜?   |
|------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------:|
|Undertow ì˜ ì ì€ parellel thread|| â³                                                                                                                                                                                                                                                                                                                                                                       |
|Spring Security ì˜ í† í° í™•ì¸ ì ˆì°¨ì—ì„œ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ë”œë ˆì´ ë¬¸ì œ|| â³                                                                                                                                                                                                                                                                                                                                                                       |
|ì´ë²¤íŠ¸ íŠ¸ëžœì ì…˜ì„ ê´€ë¦¬í•˜ëŠ” Redis ì €ìž¥ ì„±ëŠ¥ ë¬¸ì œ| ì‹¤ì¸¡ ê²°ê³¼, í‰ê·  23ms ë¡œ ë¹ ë¥´ê²Œ ì €ìž¥í•˜ê¸°ë•Œë¬¸ì— ë¬¸ì œê°€ ë˜ì§€ ì•Šë‹¤ê³  ë³´ì—¬ì§‘ë‹ˆë‹¤                                                                                                                                                                                                                                                                                                                           |    âŒ     |
|ì ì€ Kafka Producer ìŠ¤ë ˆë“œ ê°œìˆ˜| Producer ìŠ¤ë ˆë“œë¥¼ ëŠ˜ë ¤ë„ ë˜‘ê°™ì„ ê±°ì—ìš”. ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•¨ì— ìžˆì–´ í•„ìš”í•œ ê²ƒì€ 1. ì¶©ë¶„í•œ CPU ë¦¬ì†ŒìŠ¤, 2. ì¶©ë¶„í•œ ë„¤íŠ¸ì›Œí¬ ìž…ë‹ˆë‹¤. ì¶©ë¶„í•œ ë„¤íŠ¸ì›Œí¬ëŠ” ì•„ëž˜ì˜ `linger.ms ì™€ batch_size ë¬¸ì œ`ì—ì„œ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ì¶©ë¶„í•œ CPU ë¦¬ì†ŒìŠ¤ëŠ” ë¬¸ì œê°€ ë˜ì§€ ì•Šë‹¤ê³  ë³´ì—¬ì§‘ë‹ˆë‹¤. ì™œëƒí•˜ë©´, ê¸°ì¡´ì— Mono ì„œë²„ì—ì„œë„ ì‹±ê¸€ Producer ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ì˜€ì„ ë•Œ ë†’ì€ ì„±ëŠ¥ì´ ë‚˜ì™”ê¸° ë•Œë¬¸ì´ì£ . ì¦‰, ìŠ¤ë ˆë“œë¥¼ ëŠë¦°ë‹¤ê³  í•˜ë”ë¼ë„ ì„±ëŠ¥ì´ ì¦ê°€í•˜ì§€ ì•Šì„ê±°ì—ìš”.                                                                                 | âŒ|
|linger.ms ì™€ batch_size ë¬¸ì œ| linger.ms ëŠ” ì´ë²¤íŠ¸ ì „ì†¡ ëŒ€ê¸° ì‹œê°„, batch_sizeëŠ” ì´ë²¤íŠ¸ë¥¼ ë¬¶ì–´ì„œ ë³´ë‚´ëŠ” í¬ê¸° ìž…ë‹ˆë‹¤.ê¸°ì¡´ì—ëŠ” ì´ë²¤íŠ¸ ì „ì†¡ ì „ê¹Œì§€ 50ms ê¸°ë‹¤ë¦¬ê³  ìµœëŒ€í•œ 50ê°œë¥¼ ë¬¶ì–´ì„œ ë³´ë‚´ë„ë¡ ì„¤ì •í–ˆì–´ìš”. í•˜ì§€ë§Œ, ë³´ë‹¤ì‹œí”¼ í‰ê· ì ìœ¼ë¡œ 10ê°œë§Œ ë³´ë‚´ëŠ” ê²ƒì„ ì´ë¯¸ ìš°ë¦¬ê°€ í™•ì¸í–ˆì£ . ì¦‰, **ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ë¡œë“œëŠ” ë‚®ë‹¤, ë•Œë¬¸ì— ë¬¸ì œê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤**. ë¼ë„ íŒë‹¨ë©ë‹ˆë‹¤.                                                                                                                                                     |âŒ|
|ìž¦ì€ ìŠ¤ë ˆë“œ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë†’ì€ Context Switch ë¹„ìš©|| â³                                                                                                                                                                                                                                                                                                                                                                       |
|CPU/Memory ë¶€ì¡±| 18ê°œ ì»¨í…Œì´ë„ˆì˜ CPU ì ìœ  ëª©ë¡ ![img](../../../assets/img/msa/117.png) ![img](../../../assets/img/msa/118.png) ë„ì»¤ê°€ ë§Žì€ CPU ë¥¼ ì†Œëª¨í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ê·¸ ì¤‘ íŠ¹ížˆ **ìœ ì € ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ**ì— CPU usage : **821%** ë¡œ ë§Žì€ ê³¼ë¶€í•˜ê°€ ê±¸ë¦¬ê³  ìžˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìžˆì–´ìš”. ì´ëŠ” ì§ì ‘ì ì¸ ê°œì„ ì ì´ ì•„ë‹Œ ê°„ì ‘ì ì¸ ê°œì„ ì ì´ê² ì£ ? ë˜í•œ, **ì‹¤ì œ í…ŒìŠ¤íŠ¸ê°€ ëë‚œ ì´í›„ì—ë„ ê³„ì† CPUë¥¼ ìž¡ì•„ë¨¹ê³  ìžˆìŠµë‹ˆë‹¤**... ì™œ ì´ëŸ°ê±¸ê¹Œìš”ã…œã…œ. ë­”ê°€ í°ì¼ì´ ë‚¬ìŠµë‹ˆë‹¤. Kafka ë©”ì„¸ì§€ì—ì„œ ë°œìƒí•œ ì˜¤ë¥˜ì²˜ë¦¬ë¥¼ ê³„ì† ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì¼ê¹Œìš”? offsetìœ¼ë¡œ ë³´ë©´ ë¬¸ì œê°€ ì—†ëŠ”ë° ë§ì´ì£ . | âœ…                                                                                                                                                                                                                                                                                       |

#### ë„ì»¤ ì‚¬ìš© ëª©ë¡

```
cfd416579eba   spring-chatting-server_user-server            "/bin/sh -c 'java -jâ€¦"   27 minutes ago   Up 27 minutes      0.0.0.0:8010->8010/tcp                                                                                        user-server
c8cbcc6b3288   docker-elk_logstash                           "/usr/local/bin/dockâ€¦"   2 hours ago      Up 2 hours         0.0.0.0:5044->5044/tcp, 0.0.0.0:9600->9600/tcp, 0.0.0.0:50000->50000/tcp, 0.0.0.0:50000->50000/udp            docker-elk-logstash-1
7d8651886639   docker-elk_kibana                             "/bin/tini -- /usr/lâ€¦"   2 hours ago      Up 2 hours         0.0.0.0:5601->5601/tcp                                                                                        docker-elk-kibana-1
a566b373e77e   docker-elk_elasticsearch                      "/bin/tini -- /usr/lâ€¦"   2 hours ago      Up 2 hours         0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp                                                                docker-elk-elasticsearch-1
ba57b305e233   spring-chatting-server_api-server             "/bin/sh -c 'java -jâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:8000->8000/tcp                                                                                        api-server
b1cf2581d55e   spring-chatting-server_chatting-server        "/bin/sh -c 'java -jâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:8030->8030/tcp                                                                                        chatting-server
64395b9a496f   spring-chatting-server_customer-server        "/bin/sh -c 'java -jâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:8020->8020/tcp                                                                                        customer-server
1df0dfb35082   obsidiandynamics/kafdrop                      "/kafdrop.sh"            4 hours ago      Up 4 hours         0.0.0.0:9010->9000/tcp                                                                                        spring-chatting-server_kafdrop_1
1ddc741d930b   spring-chatting-server_configuration-server   "/bin/sh -c 'java -jâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:8888->8888/tcp                                                                                        configuration-server
0cd7b6b7431c   spring-chatting-server_discovery-server       "/bin/sh -c 'java -jâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:8761->8761/tcp                                                                                        discovery-server
014b0ed8d56b   confluentinc/cp-kafka:7.2.1                   "/etc/confluent/dockâ€¦"   4 hours ago      Up About an hour   0.0.0.0:8099->8099/tcp, 9092/tcp                                                                              kafka3
ce9e7479910d   confluentinc/cp-kafka:7.2.1                   "/etc/confluent/dockâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:8097->8097/tcp, 9092/tcp                                                                              kafka1
626847914a84   confluentinc/cp-kafka:7.2.1                   "/etc/confluent/dockâ€¦"   4 hours ago      Up 22 minutes      0.0.0.0:8098->8098/tcp, 9092/tcp                                                                              kafka2
a52d660f98e1   redis:latest                                  "docker-entrypoint.sâ€¦"   4 hours ago      Up 4 hours         0.0.0.0:6379->6379/tcp                                                                                        user-redis
3235ac9566de   postgres:12-alpine                            "docker-entrypoint.sâ€¦"   4 hours ago      Up 4 hours         5432/tcp, 0.0.0.0:5433->5433/tcp                                                                              chat-db
713a850e8935   rabbitmq:3-management-alpine                  "docker-entrypoint.sâ€¦"   4 hours ago      Up 4 hours         4369/tcp, 5671/tcp, 0.0.0.0:5672->5672/tcp, 15671/tcp, 15691-15692/tcp, 25672/tcp, 0.0.0.0:15672->15672/tcp   rabbitmq
eb43a67cb6f4   confluentinc/cp-zookeeper:7.2.1               "/etc/confluent/dockâ€¦"   4 hours ago      Up 4 hours         2181/tcp, 2888/tcp, 3888/tcp                                                                                  zookeeper
e23c5b432814   postgres:12-alpine                            "docker-entrypoint.sâ€¦"   4 hours ago      Up 4 hours         5432/tcp, 0.0.0.0:5434->5434/tcp                                                                              customer-db
```
