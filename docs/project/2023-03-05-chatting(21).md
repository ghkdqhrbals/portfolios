---
layout: default
title: 21. Postgresql Locks ë° RDS ì§€í‘œ ê´€ì°°, ì„±ëŠ¥í–¥ìƒ!
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 21
---
created at 2023-03-05
{: .label .label-yellow }

#### INDEX
1. AWS RDS ê·¸ë˜í”„ ì§€í‘œ ê´€ì°°
2. Postgresql Locks
   1. Lock ê´€ì°° ì¿¼ë¦¬
   2. Lock íƒ€ì… ì„¤ëª…
   3. íƒ€ì…ì— ë”°ë¥¸ Conflict ë°œìƒ ê°€ëŠ¥ ì—¬ë¶€
   4. Conflict ì˜ˆì‹œ
   5. Conflictë¡œ ì¸í•´ ë¸”ë¡ëœ ì¿¼ë¦¬ í™•ì¸
3. ê·¸ë˜ì„œ AWS RDSë¡œ í™•ì¸í•œ ì§€í‘œì—ì„œ ì–´ë–¤ ë¶€ë¶„ì„ ê°œì„ í•  ìˆ˜ ìˆì„ê¹Œ? (feat. pgAdmin4)

ê¸°ì¡´ì— ì €ëŠ” Postgresì˜ pg_stat_activityì˜ wait event íƒ€ì… ë³„ í†µê³„ë¥¼ ì¼ì¼ì´ ì°ì–´ì„œ ê´€ì°°í–ˆì—ˆëŠ”ë°ìš”, AWS RDSë¥¼ ì‚¬ìš©í•˜ë©´ ê·¸ë˜í”„í™” í•˜ì—¬ ì†ì‰½ê²Œ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ë˜ì„œ AWSê°€ ì œê³µí•´ì£¼ëŠ” DB ë§¤ë‹ˆì§€ë¨¼íŠ¸ íˆ´ì„ ì‚¬ìš©í•˜ê³ ì **auth-DBë§Œ Localì—ì„œ AWS RDS(Postgres)ë¡œ ì´ì „**í•˜ì˜€ìŠµë‹ˆë‹¤.
> ë˜í•œ ìë™ìœ¼ë¡œ ë°±ì—… ìŠ¤ëƒ…ìƒ·ê¹Œì§€ íˆ´ë¡œ ì œê³µí•´ì£¼ë‹ˆ, ì •ë§ ë„ˆë¬´ í¸ë¦¬í–ˆìŠµë‹ˆë‹¤ã…œã…œ... ì§„ì‘ì— AWS RDS ë¥¼ ì¨ë³¼ê»„ ê·¸ë¬ë„¤ìš”.

# 1. AWS RDS ê·¸ë˜í”„ ì§€í‘œ ê´€ì°°

![img](../../../assets/img/rds/1.PNG)
![img](../../../assets/img/rds/2.PNG)
![img](../../../assets/img/rds/3.png)

* Splice ì§€í‘œ ì„¤ëª…
  * **LWLock:WALInsert** : Checkpointer í”„ë¡œì„¸ìŠ¤ëŠ” WAL ë²„í¼ì— WAL ë ˆì½”ë“œë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ì´ ë•Œ ê±¸ë¦¬ëŠ” Lock ì…ë‹ˆë‹¤.
  * **LWLock:WALWrite** : WAL Writer ëŠ” WAL ë²„í¼ê°€ ê°€ë“ ì°¼ì„ ë•Œ, WAL ë²„í¼ë¥¼ WAL íŒŒì¼ì— ì˜®ê¹ë‹ˆë‹¤. ì´ ë–„ ê±¸ë¦¬ëŠ” Lock ì…ë‹ˆë‹¤.
  > LWLock ì€ SharedMemory ì— ì ‘ê·¼í•  ë•Œ ê±¸ë¦¬ëŠ” Lockì…ë‹ˆë‹¤. WALì€ ë³€ê²½ê¸°ë¡ì…ë‹ˆë‹¤. tx_logì…ë‹ˆë‹¤.
  * **IO:WALSync** : WAL íŒŒì¼ì„ Archive íŒŒì¼ì— ì˜®ê¸°ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.
  * **Client:ClientWrite** : í´ë¼ì´ì–¸íŠ¸ê°€ í˜ë“¤ ë•Œ ClientWrite ì´ë²¤íŠ¸ê°€ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤. ì¦‰, DB í´ëŸ¬ìŠ¤í„°ëŠ” ì¤€ë¹„ê°€ ë˜ì–´ìˆì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ê°€ ì œ ë•Œ ë°›ì§€ ëª»í•  ë•Œ ì´ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.
    * ë°œìƒì´ìœ 
      * PostgreSQL DB í´ëŸ¬ìŠ¤í„°ì™€ í´ë¼ì´ì–¸íŠ¸ ê°„ì˜ ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬ëŸ‰ì´ ê°ì†Œí•˜ë©´ ì´ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      * í´ë¼ì´ì–¸íŠ¸ì— ëŒ€í•œ CPU ì••ë ¥ ë° ë„¤íŠ¸ì›Œí¬ í¬í™” ìƒíƒœì‹œì—ë„ ì´ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

ë” ìì„¸í•œ ì„¤ëª…ë“¤ì€ [https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Reference.Waitevents.html](https://docs.aws.amazon.com/ko_kr/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Reference.Waitevents.html)ë¥¼ ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.


# 2. Postgresql Locks
## 2-1. Lock ê´€ì°° ì¿¼ë¦¬

pg_catalog ëŠ” ì •ë§ ìˆ˜ë§ì€ ë©”íƒ€ë°ì´í„° ì •ë³´ë¥¼ ì—¬ëŸ¬ê°€ì§€ viewë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. ê·¸ ì¤‘ ì €ëŠ” [pg ëª¨ë‹ˆí„°ë§](https://www.postgresql.org/docs/14/monitoring-stats.html)ì˜ pg_stat_activityì™€, pg_locksì„ ì•„ë˜ì™€ ê°™ì´ pidë¡œ joiní•´ì„œ í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ íŠ¸ëœì ì…˜ì˜ ì¿¼ë¦¬/lock ì •ë³´ë“¤ì„ í™•ì¸ í•  ê±°ì—ìš”.

```sql
SELECT
	locktype,
	relation::regclass,
	mode,
	transactionid tid,
	virtualtransaction AS vtid,
	l.pid,
	query,
	granted
FROM
	pg_catalog.pg_locks l
	LEFT JOIN pg_catalog.pg_stat_activity db ON db.pid = l.pid
WHERE
	NOT l.pid = pg_backend_pid();
```

![img](../../../assets/img/rds/5.png)

## 2-2. [íƒ€ì… ì„¤ëª…](https://www.postgresql.org/docs/current/explicit-locking.html)
* Row ExclusiveLock : UPDATE, DELETE, INSERT ì‹œì— í•´ë‹¹ í…Œì´ë¸”ì™€ pkeyì— Lockì„ ê±¸ì–´ë†“ìŠµë‹ˆë‹¤.
* ExclusiveLock : ëª¨ë“  íŠ¸ëœì ì…˜ì€ ìì‹ ì˜ idì— ëŒ€í•´ ExclusiveLockì„ ê±¸ì–´ë†“ìŠµë‹ˆë‹¤.
* ShareLock : ë™ì‹œ ë°ì´í„°ë¥¼ ë³€ê²½í•  ë•Œ ìƒê¸°ëŠ” ë¬¸ì œë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•˜ì—¬ ë¨¼ì € Lockì„ ì¡ì€ Transactionidì— ê³µìœ ë¥¼ ìš”ì²­í•˜ëŠ” Lockì…ë‹ˆë‹¤.

## 2-3. íƒ€ì…ì— ë”°ë¥¸ Conflict ë°œìƒ ê°€ëŠ¥ ì—¬ë¶€
![img](../../../assets/img/rds/4.png)
from [https://postgrespro.com/blog/pgsql/5967999](https://postgrespro.com/blog/pgsql/5967999)

## 2-4. Conflict ì˜ˆì‹œ

ìœ ë‹ˆí¬í•œ user_idë¥¼ ê°€ì§€ëŠ” í…Œì´ë¸”ì— ë™ì¼ user_id='A1' insert ë¬¸ ë‘ ê°œë¥¼ ë™ì‹œì— ë‚ ë ¤ë³¼ê±°ì—ìš”. ê·¸ëŸ¬ë©´ ì•„ë˜ì™€ ê°™ì´ `PID:21789` íŠ¸ëœì ì…˜ê³¼ `PID:21516` íŠ¸ëœì ì…˜ì€ Conflict ê°€ ë°œìƒí•©ë‹ˆë‹¤. ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. `PID:21789`ëŠ” user_id='A1' ì¸ë±ìŠ¤ì— Row ExclusiveLock ì„ ë¨¼ì € ê±¸ì–´ë†“ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ìì‹ ì˜ TXIDì— **ExclusiveLock**ì„ ê±¸ì–´ë†“ìŠµë‹ˆë‹¤.
2. `PID:21516`ëŠ” user_id='A1'ì— Row ExclusiveLock ì„ ë§ˆì°¬ê°€ì§€ë¡œ ê±¸ì–´ë†“ìŠµë‹ˆë‹¤. í•´ë‹¹ ì¸ë±ìŠ¤ê°€ ì‚¬ìš©ë˜ëŠ” íŠ¸ëœì ì…˜ì— ê³µìœ  ìš”ì²­ì„ ì‹ ì²­í•´ì•¼í•©ë‹ˆë‹¤.
3. `PID:21516`ëŠ” ShareLockìœ¼ë¡œ `PID:21789` íŠ¸ëœì ì…˜ ê³µìœ ë¥¼ ìš”ì²­í•˜ì§€ë§Œ **ShareLockê³¼ íŠ¸ëœì ì…˜ì— ê±¸ë¦° ExclusiveLockì€ ìœ„ì˜ í‘œì™€ ê°™ì´ Conflictê°€ ë°œìƒ**í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê¶Œí•œíšë“ì— ì‹¤íŒ¨í•˜ê³  blockë©ë‹ˆë‹¤(granted=`False`).

![img](../../../assets/img/rds/6.png)

## 2-5. Conflictë¡œ ì¸í•´ ë¸”ë¡ëœ ì¿¼ë¦¬ í™•ì¸
```sql
select pid, 
       usename, 
       pg_blocking_pids(pid) as blocked_by, 
       query as blocked_query
from pg_stat_activity
where cardinality(pg_blocking_pids(pid)) > 0;
```
![img](../../../assets/img/rds/7.png)

# 3. ê·¸ë˜ì„œ AWS RDSë¡œ í™•ì¸í•œ ì§€í‘œì—ì„œ ì–´ë–¤ ë¶€ë¶„ì„ ê°œì„ í•  ìˆ˜ ìˆì„ê¹Œ? + pgAdmin4

ìì„¸íˆ ë³´ë‹¤ë³´ë‹ˆ, ì•„ë˜ì²˜ëŸ¼ ì¿¼ë¦¬ ì´ì™¸ì— **DB connection ì´ 20ìœ¼ë¡œ ê³ ì •í• ë‹¹ë˜ì–´ìˆëŠ”ê²ƒì„ í™•ì¸**í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

![img](../../../assets/img/rds/8.png)

ë¯¸ì³ ìƒê°í•˜ì§€ ëª»í–ˆë˜ ë¶€ë¶„ì´ì˜€ì–´ìš”ã…œã…œ. ì¼ë‹¨ í˜„ì¬ ì¸ì¦ì„œë²„ì— 100ì˜ ìŠ¤ë ˆë“œê°€ í• ë‹¹ë˜ì–´ ìˆê¸°ë•Œë¬¸ì—, ê° ìŠ¤ë ˆë“œ ë³„ë¡œ í•˜ë‚˜ì˜ DBì»¤ë„¥ì…˜ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. DB ì´ì™¸, Kafkaì— ë©”ì„¸ì§€ë¥¼ ì „ë‹¬í•˜ëŠ” ìŠ¤ë ˆë“œë˜í•œ í•„ìš”í•˜ê¸°ë•Œë¬¸ì— DBì˜ max conenctionì„ ì ë‹¹íˆ 70ìœ¼ë¡œ ë§ì¶”ì—ˆìŠµë‹ˆë‹¤(ì ì ˆí•œ ê°œìˆ˜ëŠ” 40~50ì´ë¼ê³  í•˜ë„¤ìš”).

ê·¸ë¦¬ê³  AWS RDSì— ë°ì´í„°ë² ì´ìŠ¤ íŒŒë¼ë¯¸í„° êµ°ì„ í™•ì¸í•˜ë©´ ìµœëŒ€ 800ë§Œê°œì˜ connectionì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.

![img](../../../assets/img/rds/9.png)
* t3micro ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ê°€ëŠ¥í•œ RDS max conenction

    ```sql
    SHOW max_connections;
    ```
    
    ![img](../../../assets/img/rds/14.png)
ì œê°€ ì‚¬ìš©í•˜ëŠ” í˜„ì¬ì˜ t3micro ì¸ìŠ¤í„´ìŠ¤ì—ì„œëŠ” **83ê°œ** ê¹Œì§€ë§Œ ê°€ì§ˆ ìˆ˜ ìˆë„¤ìš”! ì´ ì¤‘ ì—¬ëŸ¬ ì‹¤í—˜ì— í•„ìš”í•œ 13ê°œë¥¼ ë‹¤ë¥¸ ì»¤ë„¥ì…˜ìœ¼ë¡œ ë¹¼ê³  ë‚˜ë¨¸ì§€ 70ê°œë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.

![img](../../../assets/img/rds/10.png)

* ì¼ë‹¨ DB Idle conenctionì´ ì˜¬ë¼ê°”ì£ !

```bash
test-multiple-http-request  | Request url: http://127.0.0.1:8060/auth/user
test-multiple-http-request  | The number of HTTP Requests: 10000
test-multiple-http-request  | The number of threads: 1000
test-multiple-http-request  | Proceeding! Please wait until getting all the responses
test-multiple-http-request  | Elapsed Time: 26.283325464 <- 51.3ì´ˆì—ì„œ 200% ê°œì„ ë˜ì—ˆì–´ìš”! 
test-multiple-http-request  | Response status code:  200 , How many?:  10000
test-multiple-http-request exited with code 0
```

* **RDS ì´ì „ í›„, 10K RTTì— 51.3ì´ˆê°€ ê±¸ë ¸ì§€ë§Œ 200% í–¥ìƒë˜ì„œ 26.2ì´ˆë¡œ ì¤„ì—ˆìŠµë‹ˆë‹¤!**

ë‹¤ì‹œ RDS ì§€í‘œë¥¼ ê´€ì°°í•´ë³¼ê¹Œìš”?

![img](../../../assets/img/rds/11.png)
![img](../../../assets/img/rds/12.png)

- í™œì„± ì„¸ì…˜ ìˆ˜ëŠ” ë‹¤ì†Œ ì˜¬ë¼ê°”ìŠµë‹ˆë‹¤.
- ë†’ì€ LWLock:WALInsert. ì´ì œ ì´ ë¶€ë¶„ì„ ê°œì„ í•´ì•¼ê² ì£ ?

ì¶”ê°€ì ìœ¼ë¡œ CPU ì‚¬ìš©ë¥ ì€ í¬ê²Œ ë³€í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„ë§ˆ Postgres í•¨ìˆ˜ì™€ Select/Join ì™€ ê°™ì€ CPU ì‚¬ìš©ë¥ ì„ ë†’ì´ëŠ” ì¿¼ë¦¬ê°€ ì—†ì—ˆê¸° ë•Œë¬¸ì´ê² ì£ ?
![img](../../../assets/img/rds/13.png)









# reference
* [https://www.educba.com/postgresql-wal/](https://www.educba.com/postgresql-wal/) 
* [https://postgrespro.com/blog/pgsql/5967951](https://postgrespro.com/blog/pgsql/5967951)
* Postgres ì •ë³´ : [https://blog.ex-em.com/1657](https://blog.ex-em.com/1657)
* [https://www.postgresql.org/docs/current/explicit-locking.html](https://www.postgresql.org/docs/current/explicit-locking.html)
