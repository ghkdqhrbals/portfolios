---
layout: default
title: 11. ëŒ€ëŸ‰ Rest api test ì½”ë“œ
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 11
---
í˜„ì¬ê¹Œì§€ auth/chat Server ë° ì—¬ëŸ¬ ì¥ì• ëŒ€ì‘ê³¼ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ë¥¼ êµ¬ì¶•í–ˆë‹¤.
ì„œë¹„ìŠ¤ê´€ë ¨ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì´ë¯¸ ìƒì„±í•˜ì˜€ìœ¼ë©°, ì´ì œëŠ” **ë‹¤ëŸ‰ì˜ Rest api íŠ¸ë˜í”½ì„ í…ŒìŠ¤íŠ¸**ë¥¼ ìœ„í•œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì œì‘í•´ ë³¼ ì°¨ë¡€ì´ë‹¤.
> ì•„ë˜ì˜ ì½”ë“œëŠ” Golangìœ¼ë¡œ ì œì‘í•˜ì˜€ë‹¤. ì˜ˆìƒë˜ëŠ” ì•„ë˜ì˜ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ ì¤€ë¹„í•´ë´¤ë‹¤.
>
> Question : **ì™œ Javaê°€ ì•„ë‹Œ Golangìœ¼ë¡œ ì œì‘í–ˆë‚˜ìš”?**
>
> * Answer 1 : ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ JVMê¹Œì§€ ë©”ëª¨ë¦¬ì— ì˜¬ë¦´í•„ìš”ëŠ” ì—†ë‹¤ê³  ìƒê°í•˜ê¸°ë•Œë¬¸ì´ë‹¤. Golangì€ ì»´íŒŒì¼ ì–¸ì–´ë¡œì¨ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ë§Œ ìˆìœ¼ë©´ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤.
> * Answer 2 : Golangì€ ê²½ëŸ‰ ìŠ¤ë ˆë“œì¸ go-routineì„ ì‚¬ìš©(M:N), JavaëŠ” ë„¤ì´í‹°ë¸Œ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•œë‹¤. í¬ê¸°ë¥¼ ë¹„êµí•˜ë©´ Golangì€ ìŠ¤ë ˆë“œ í¬ê¸°ê°€ 2KBì¸ë° ë¹„í•´, JavaëŠ” ìŠ¤ë ˆë“œ í¬ê¸°ê°€ 1MBì´ìƒì´ë‹¤. ì´ëŠ” ì¦‰, ìŠ¤ì¼€ì¥´ë§ì— ìˆì–´ Golangì´ Context Switchì—ì„œ ì´ì ì„ ê°€ì ¸ê°€ë©° ë™ì‹œì— ë” ë§ì€ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆë‹¤ëŠ” ì´ì ì„ ê°€ì§€ê³  ìˆë‹¤ëŠ” ê²ƒì´ë‹¤. ê´€ë ¨ëœ ìë£ŒëŠ” í•„ìì˜ [Goroutine structure and behavior](https://ghkdqhrbals.github.io/posts/thread-goroutine/) í¬ìŠ¤íŒ…ì— ìˆë‹¤.

```golang
package main
...
func worker(finished chan map[int]int, requestURL string, bodyReader *bytes.Reader, client *http.Client, transferRatePerSecond int) {

	// ë¡œì»¬ ë§µ ìƒì„±
	m := make(map[int]int)

	for i := 0; i < transferRatePerSecond; i++ {
		// ìš”ì²­ ìƒì„±
		req, err := http.NewRequest(http.MethodPost, requestURL, bodyReader)
		if err != nil {
			fmt.Printf("client: could not create request: %s\n", err)
			os.Exit(1)
		}

		// json í—¤ë” ì„¤ì •
		req.Header.Set("Content-Type", "application/json")

		// ì‹¤ì œ ìš”ì²­ ì „ì†¡ ë° ë°˜í™˜
		res, _ := client.Do(req)

		// ë¡œì»¬ ë§µì— ì‚½ì…
		m[res.StatusCode] += 1
	}

	// ì™„ë£Œ í›„ ì±„ë„ë¡œ ë¡œì»¬ ë§µ ì „ì†¡
	finished <- m
}

func main() {

	argsWithProg := os.Args
	argsWithoutProg := os.Args[1:]

	// http ì „ì†¡ url
	requestURL := argsWithoutProg[0]

	// json íŒŒì¼ ê²½ë¡œ ex) user
	// .json í™•ì¥ì ëª…ì€ ì œì™¸
	jsonReq := argsWithoutProg[1]

	// ì‹¤í–‰íšŸìˆ˜ ì„¤ì •
	transferRatePerSecond, _ := strconv.Atoi(argsWithoutProg[2])

	// JSON íŒŒì¼ ì½ê¸°
	jsonFile, err := os.Open(jsonReq + ".json")
	if err != nil {
		fmt.Println(err)
	}
	defer jsonFile.Close()

	// í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ë° timeout
	client := &http.Client{
		Timeout: 30 * time.Second,
	}

	// jsoníŒŒì¼ì„ ë°”ì´íŠ¸ë¡œ ë³€í™˜
	jsonBody, _ := ioutil.ReadAll(jsonFile)
	bodyReader := bytes.NewReader(jsonBody)

	// ìŠ¤ë ˆë“œ ì‹±í¬ ë§µ
	var contexts = sync.Map{}
	finished := make(chan map[int]int)

	// ë©€í‹° ìŠ¤ë ˆë“œ http request
	go worker(finished, requestURL, bodyReader, client, transferRatePerSecond)

	// ìŠ¤ë ˆë“œ ë³„ ì±„ë„ì„ í†µí•œ ì™„ë£Œ í™•ì¸ ë° ìŠ¤ë ˆë“œì˜ ë§µ ê°€ì ¸ì˜¤ê¸°
	m := <-finished

	// ìŠ¤ë ˆë“œ ë³„ ì™„ë£Œê°’ êº¼ë‚´ì„œ mutex lockí•´ì£¼ëŠ” ë§µ ì €ì¥
	for k, v := range m {
		result, ok := contexts.Load(k)
		if ok {
			contexts.Store(k, result.(int)+v)
		} else {
			contexts.Store(k, v)
		}
	}

	// ì„±ê³µí•œ http request ê°œìˆ˜ í™•ì¸
	contexts.Range(func(k, v interface{}) bool {
		fmt.Println("status: ", k, " count: ", v)
		return true
	})
}

```

### [ë¬¸ì œì 1] 400 status code error
ê·¸ëŸ°ë° ë¬¸ì œì ì´ ë°œìƒí–ˆë‹¤. ìœ„ì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ì•„ë˜ì™€ ê°™ì´ ê²°ê³¼ë¥¼ ë°›ëŠ”ë‹¤.

* ì‹¤í–‰

```
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go http://localhost:8080/auth/user user 50
[http://localhost:8080/auth/user user 50]
status:  409  count:  1 <- ì˜ˆìƒëœ ê²°ê³¼
status:  400  count:  49 <- ì™œ?;;
```

* ì„œë²„ë¡œê·¸

```
auth-server               | 2023-01-16 05:55:17.348  INFO 1 --- [nio-8085-exec-9] chatting.chat.web.UserController         : request URI=/auth/user
auth-server               | 2023-01-16 05:55:17.350 DEBUG 1 --- [nio-8085-exec-9] org.hibernate.SQL                        :
auth-server               |     select
auth-server               |         user0_.user_id as user_id1_0_0_,
auth-server               |         user0_.email as email2_0_0_,
auth-server               |         user0_.join_date as join_dat3_0_0_,
auth-server               |         user0_.login_date as login_da4_0_0_,
auth-server               |         user0_.logout_date as logout_d5_0_0_,
auth-server               |         user0_.user_name as user_nam6_0_0_,
auth-server               |         user0_.user_pw as user_pw7_0_0_
auth-server               |     from
auth-server               |         user_table user0_
auth-server               |     where
auth-server               |         user0_.user_id=?
auth-server               | 2023-01-16 05:55:17.351 TRACE 1 --- [nio-8085-exec-9] o.h.type.descriptor.sql.BasicBinder      : binding parameter [1] as [VARCHAR] - [a]
auth-server               | 2023-01-16 05:55:17.355 ERROR 1 --- [nio-8085-exec-9] c.chat.web.error.GlobalExceptionHandler  : handleCustomException throw CustomException : DUPLICATE_RESOURCE

# ------------------------------ ì •ìƒ ì—ëŸ¬ ------------------------------
nginx                     | 192.168.192.1 - - [16/Jan/2023:05:55:17 +0000] "POST /auth/user HTTP/1.1" 409 162 "-" "Go-http-client/1.1" "-"

# ------------------------------ ë¹„ì •ìƒ ì—ëŸ¬ ------------------------------
nginx                     | 192.168.192.1 - - [16/Jan/2023:05:55:17 +0000] "POST /auth/user HTTP/1.1" 400 0 "-" "Go-http-client/1.1" "-"
nginx                     | 192.168.192.1 - - [16/Jan/2023:05:55:17 +0000] "POST /auth/user HTTP/1.1" 400 0 "-" "Go-http-client/1.1" "-"
nginx                     | 192.168.192.1 - - [16/Jan/2023:05:55:17 +0000] "POST
...
```

```
HTTP client in Go by default has DefaultMaxIdleConnsPerHost value of 2
```

ê°™ì€ IDë¡œ auth serverì— http reqeustí•˜ê¸° ë•Œë¬¸ì—, status code 409ì€ ë¶„ëª… ì˜ˆìƒëœ ê²°ê³¼ì´ë‹¤. í•˜ì§€ë§Œ! 400 ì—ëŸ¬ëŠ” ì›í•˜ëŠ” ê²°ê³¼ê°€ ì•„ë‹ˆë‹¤. ì• ì´ˆì— nginxë¥¼ í†µí•´ auth-serverë¡œ ì²« ë²ˆì§¸ requestë§Œ ë“¤ì–´ê°€ê³  ë‚˜ë¨¸ì§€ëŠ” íŒ…ê²¨ë‚˜ê°€ëŠ” í˜„ìƒì„ ê´€ì°°í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë©´ test codeê°€ ë¬¸ì œì´ê±°ë‚˜ nginx configurationì´ ì˜ëª»ë˜ì—ˆë‹¤ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.


### [ë¬¸ì œì 1 í•´ê²°] byteì½”ë“œ ì˜¤ë¥˜

```
...
func worker(finished chan map[int]int, requestURL string, jsonBody []byte, client *http.Client, transferRatePerSecond int) {
  ...
	for i := 0; i < transferRatePerSecond; i++ {
	  # bodyReaderì€ í¬ì¸í„°ì´ê¸° ë•Œë¬¸ì—, ì‚¬ìš© ì´ì „ê³¼ ì´í›„ê°€ ë‹¤ë¥´ë‹¤
		bodyReader := bytes.NewReader(jsonBody)
		...
	}
  ...
}

ì´ì „ bodyReader = &{[123 10 ...] 0 -1}

ì „ì†¡ ì´í›„ì˜ bodyReader &{[123 10 ...] 89 -1}
```

[https://go.dev/src/compress/gzip/example_test.go](https://go.dev/src/compress/gzip/example_test.go)ë¥¼ ë³´ë©´ ì•„ë˜ì˜ ë ˆí¼ëŸ°ìŠ¤ê°€ ìˆë‹¤.

> Note that passing req to http.Client.Do promises that it
> will **close** the body, in this case **bodyReader**.

ì¦‰, **89ëŠ” ì´ë¯¸ ì†Œë¹„ëœ bodyReaderì„ í‘œì‹œí•˜ëŠ” ë°”ì´íŠ¸**ì´ë‹¤. ë”°ë¼ì„œ ì´ë¥¼ ë‹¤ì‹œ resendí•˜ê²Œ ëœë‹¤ë©´ net/http ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì´ë¥¼ ì½ì§€ ì•Šê¸°ë•Œë¬¸ì—, í•´ë‹¹ ë°”ì´íŠ¸ë¥¼ ë‹¤ì‹œ 0ìœ¼ë¡œ ì¬ì„¤ì •í•˜ëŠ” ê³¼ì •ì„ ê°€ì ¸ì•¼í•œë‹¤.

ë”°ë¼ì„œ ì´ë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•˜ì—¬ ì •ìƒì—ëŸ¬ ê²°ê³¼ë¥¼ ë°›ì•„ë³¼ ìˆ˜ ìˆë‹¤.

# ìˆ˜ì •ëœ test code

```golang
...
func worker(contexts *sync.Map, wg *sync.WaitGroup, requestURL string, jsonBody []byte, client *http.Client, transferRatePerSecond int, number_worker int) {
	defer wg.Done()
	fmt.Println("Threads start:", number_worker)
	// ë¡œì»¬ ë§µ ìƒì„±
	m := make(map[int]int)

	for i := 0; i < transferRatePerSecond; i++ {
		bodyReader := bytes.NewReader(jsonBody)
		// ìš”ì²­ ìƒì„±
		req, err := http.NewRequest(http.MethodPost, requestURL, bodyReader)
		if err != nil {
			fmt.Printf("client: could not create request: %s\n", err)
			os.Exit(1)
		}
		// json í—¤ë” ì„¤ì •
		req.Header.Set("Content-Type", "application/json")
		// ì‹¤ì œ ìš”ì²­ ì „ì†¡ ë° ë°˜í™˜
		res, _ := client.Do(req)
		// ë¡œì»¬ ë§µì— ì‚½ì…
		m[res.StatusCode] += 1
	}

	for k, v := range m {
		result, ok := contexts.Load(k)
		if ok {
			contexts.Store(k, result.(int)+v)
		} else {
			contexts.Store(k, v)
		}
	}
}

func main() {

	argsWithoutProg := os.Args[1:]
	var wg sync.WaitGroup

	number_worker := 10
	// http ì „ì†¡ url
	requestURL := argsWithoutProg[0]

	// json íŒŒì¼ ê²½ë¡œ ex) user
	// .json í™•ì¥ì ëª…ì€ ì œì™¸
	jsonReq := argsWithoutProg[1]

	// ì‹¤í–‰íšŸìˆ˜ ì„¤ì •
	transferRatePerSecond, _ := strconv.Atoi(argsWithoutProg[2])

	// JSON íŒŒì¼ ì½ê¸°
	jsonFile, err := os.Open(jsonReq + ".json")
	if err != nil {
		fmt.Println(err)
	}
	defer jsonFile.Close()

	t := http.DefaultTransport.(*http.Transport).Clone()
	t.MaxIdleConns = 1000    // connection pool í¬ê¸°
	t.MaxConnsPerHost = 1000 // í˜¸ìŠ¤íŠ¸ ë³„ ìµœëŒ€ í• ë‹¹ connection
	t.MaxIdleConnsPerHost = 1000
	t.Dial = (&net.Dialer{
		Timeout: 1 * time.Second,
	}).Dial

	// í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ë° timeout
	client := &http.Client{
		Timeout:   1 * time.Second,
		Transport: t,
	}

	// jsoníŒŒì¼ì„ ë°”ì´íŠ¸ë¡œ ë³€í™˜
	jsonBody, _ := ioutil.ReadAll(jsonFile)

	// ìŠ¤ë ˆë“œ ì‹±í¬ ë§µ
	var contexts = &sync.Map{}

	// ë©€í‹° ìŠ¤ë ˆë“œ http request
	for i := 0; i < number_worker; i++ {
		wg.Add(1)
		go worker(contexts, &wg, requestURL, jsonBody, client, transferRatePerSecond/number_worker, i)
	}

	wg.Wait()

	// ì„±ê³µí•œ http request ê°œìˆ˜ í™•ì¸
	contexts.Range(func(k, v interface{}) bool {
		fmt.Println("status: ", k, " count: ", v)
		return true
	})
}
```

ì—¬ê¸°ì„œ ì¶”ê°€ëœ ì¤‘ìš”í•œ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```golang
	t := http.DefaultTransport.(*http.Transport).Clone()
	t.MaxIdleConns = 100
	t.MaxConnsPerHost = 100
	t.MaxIdleConnsPerHost = 100
	t.Dial = (&net.Dialer{
		Timeout: 5 * time.Second,
	}).Dial
	t.TLSHandshakeTimeout = 5 * time.Second

	// í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ë° timeout
	client := &http.Client{
		Timeout:   10 * time.Second,
		Transport: t,
	}
```

ê¸°ë³¸ì ìœ¼ë¡œ ë™ì‹œ ì—°ê²° ê°€ëŠ¥ tcp ì†Œì¼“ ê°œìˆ˜ëŠ” net/httpì—ì„œëŠ” 2ê°œë¡œ ì„¤ì •ë˜ì–´ìˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ëŠ” **100ê°œì˜ ë™ì‹œ tcp ì†Œì¼“**ìœ¼ë¡œ ë§ì¶°ì£¼ê³ , **ê°ê°ì˜ ì†Œì¼“ì´ 5ì´ˆ ì´ë‚´ë¡œ ì¬ dialë˜ì§€ ì•Šìœ¼ë©´ ì¢…ë£Œ**í•˜ë„ë¡ ì„¤ì •í•´ì¤€ë‹¤.

ì´ ë°–ì— `number_worker` ìŠ¤ë ˆë“œ ê°œìˆ˜ëŠ” 10ê°œë¡œ ì„¤ì •í•˜ì—¬ ì‹œë®¬ë ˆì´ì…˜í•œë‹¤.
## ê²°ê³¼

```
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go http://localhost:8080/auth/user user 200
Threads start: 8
Threads start: 1
Threads start: 7
Threads start: 6
Threads start: 3
Threads start: 9
Threads start: 0
Threads start: 2
Threads start: 4
Threads start: 5
status:  409  count:  200 <-- ì›í•˜ëŠ” ê²°ê³¼ ë„ì¶œ
```
