---
layout: default
title: 41. μ„λ²„μ„±λ¥ κ°μ„ κΈ°λ΅ - πΆTPS 31%, MTTFB[p99] 39% κ°μ„ 
parent: π“ μ‹¤μ‹κ°„ μ±„ν…μ„λ²„ ν”„λ΅μ νΈ
nav_order: 41
---

created at 2023-12-29
{: .label .label-yellow }

## 1. κ°μ„  μ΄μ „
<img width="1412" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/d2c0eff9-8bbc-44db-a24e-4e36a27acf35">

thread 300 μΌλ΅ μ”μ²­ μ „μ†΅ μ‹ μ„μ™€κ°™μ΄ λ§μ€ cpu λ΅λ“κ°€ κ±Έλ¦¬λ„¤μ”. cpu limit μ„¤μ •μ€ μ μ©λμ–΄ μμ§€ μ•μ•„ λ³΄μ΄μ§€λ§ μΌλ°μ μΌλ΅ νλ“ ν•λ‚λ΅ λλ¦¬κΈ°μ—λ” λ§μ€ λ¶€ν•λ¥Ό νΌμ κ°λ‹Ήν•κ³  μλ”κ²ƒμ„ ν™•μΈν•  μ μμ—μµλ‹λ‹¤.

## 2. ingress νλ“ replicaSet=2 CPU λ΅λ“ λ¶„μ‚° μ‹ κ° νλ“ CPU λ¦¬μ†μ¤ μ†λ¨ κ΄€μ°°

<img width="1001" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/78afa556-691e-421a-9f68-2bf7f1f4f4a0">

<img width="1002" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/3d5041fd-8faa-420e-b507-c1c6b1ada47f">


AWS **NLB** μ—μ„ κ° pods λ΅ λ΅λ“λ°Έλ°μ‹±μ„ μν–‰ν•κ² λκ³ , κ·Έ κ²°κ³Όλ΅ CPU Usage λν• λ¶„μ‚°λ  μ μμ—μµλ‹λ‹¤!

## 3. Ingress Pod κ°€ **2**κ°μΌ λ• μ„±λ¥μ§€ν‘ μΈ΅μ •

> * πΆ : μ„±λ¥ν–¥μƒ
> * π”΄ : μ„±λ¥κ°μ†

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| TPS ν‰κ·  | 319.99 | 422.20 | **31.94% πΆ** |
| TPS p95 | 376.77 | 497.80 | **32.12% πΆ** |
| TPS p99 | 415.61 | 532.80 | **28.20% πΆ** |
| MTTFB ν‰κ·  | 950.89 ms | 709.86 ms | **25.35% πΆ** |
| MTTFB p95 | 1322.11 ms | 958.64 ms | **27.49% πΆ** |
| MTTFB p99 | 1833.22 ms | 1117.45 ms | **39.04% πΆ** |
| MTTFB μ°¨μ΄ ν‰κ·  | 112.52 ms | 58.82 ms | **47.72% πΆ** |
| MTTFB ν‰κ· μ μΈ λ³€λ™λ¥  | 10.67% | 7.67% | **28.12% πΆ** |

μ •λ§ ν° ν­μΌλ΅ TPS μ™€ MTTFB μ§€ν‘κ°€ λ³€ν•κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤. CPU Usage λ” κ° μ›μ»¤λ…Έλ“λ΅ μ λ¶„μ‚°λ κ²ƒ λν• μ΄μ „ κ·Έλν”„λ¥Ό ν†µν•΄ κ΄€μ°°ν•  μ μ‡μ—μ£ ! νλ“κ°€ 2κ°λ΅ λμ–΄λ‚¬μ„ λ• μ΄μ •λ„μ΄λ©΄ λ‹¨μν μƒκ°ν–μ„ λ• 3κ°μ Ingress Pod λΌλ©΄ μ–΄λ–¨κΉμ”?

## 4. Ingress Pod κ°€ **3**κ°μΌ λ• μ„±λ¥μ§€ν‘ μΈ΅μ •

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| TPS ν‰κ·  | 422.20 | 462.79 | **9.61% πΆ** |
| TPS p95 | 497.80 | 556.60 | **11.81% πΆ** |
| TPS p99 | 532.80 | 588.62 | **10.48% πΆ** |
| MTTFB ν‰κ·  | 709.86 ms | 651.05 ms | **8.28% πΆ** |
| MTTFB p95 | 958.64 ms | 1017.44 ms | **-6.13% π”΄** |
| MTTFB p99 | 1117.45 ms | 1265.16 ms | **-13.22% π”΄** |
| MTTFB μ°¨μ΄ ν‰κ·  | 58.82 ms | 88.51 ms | **-50.48% π”΄** |
| MTTFB ν‰κ· μ μΈ λ³€λ™λ¥   | 7.67% | 11.53% | **-50.33% π”΄** |

TPS, MTTFB mean κ°’μ΄ μ†ν­ μƒμΉν• κ²ƒμ„ ν™•μΈν•  μ μμ—μµλ‹λ‹¤. **ν•μ§€λ§ μµμ•…μ μ‹λ‚μ΄λ΅λ¥Ό κ°€μ •ν•  μ μλ” p95, p99 μΈ΅μ •μ€ MTTFB κ°€ μ΅°κΈ λ‚®μ•„μ§„ κ²ƒμ„ ν™•μΈν•  μ μμ—μµλ‹λ‹¤.** μ΅°κΈ μ΄μƒν•μ£ ? λ³΄ν†µ TPS μ™€ MTTFB λ” λΉ„λ΅€κ΄€κ³„λΌκ³  μƒκ°ν•λ”λ° μ„μ κ²°κ³Όλ” λ°λ€μΈ λ¶€λ¶„μ΄ μ΄μƒν•©λ‹λ‹¤. μ΄μ κ°€ λ­κΉμ”? μ°¨κ·Όμ°¨κ·Ό λ¶„μ„ν•΄λ³Όκ²μ”. λ³Έ λ¶„μ„μ€ 17:05λ¶„, 17:45λ¶„ μ‹μ‘λ 10λ¶„λ™μ•μ μ„λ²„ λ΅λ“ν…μ¤νΈμ κ° μ§€ν‘λ¥Ό ν™•μΈν•  κ²ƒμ…λ‹λ‹¤.

1. HTTP Request Response ν™•μΈ

<img width="1410" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/73185a6e-e11e-40cc-983e-aa949ce6ee47">

Request μμ μ°¨μ΄λ” μ—†κµ°μ”! ν•μ§€λ§ μ‘λ‹µμ‹κ°„μ΄ κ°‘μκΈ° ν™• μ¦κ°€ν• λ¶€λ¶„μ΄ λ³΄μ΄μ£ ? μ΄ μ‹μ μ—μ„μ λ‹¤λ¥Έ μ§€ν‘λ“¤μ„ κ΄€μ°°ν•΄λ³Όκ²μ”.

2. λ©”λ¨λ¦¬ GC μ— μ†μ”λ μ‹κ°„ λ° GC count

μ—¬κΈ°μ„ μ°λ¦¬λ” minor GC μ λΉλ„κ°€ ν™• λ†’μ•„μ΅κ³  latency λν• μ¦κ°€ν•λ” κ²ƒμ„ ν™•μΈν•  μ μμµλ‹λ‹¤. λΏλ§ μ•„λ‹λΌ majorGC λ„ λ°μƒν–μµλ‹λ‹¤. μ™μ΄λ ‡κ² μ¦κ°€ν–μ„κΉμ”?

<img width="1412" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/7a6d18c8-be9d-4147-ae4b-ff2ac00bcf93">

## 5. Heap GC λ΅ μΈν• Stop The World μ§€μ—°μ‹κ°„ ν™•μΈ

minor GC κ°€ ν…μ¤νΈ λ™μ• 50λ² μ •λ„ λ°μƒν–μΌλ©°, μ§€μ—°μ‹κ°„μ€ μ•½ 8ms λ΅ μ•„μ§ κ³Όν•μ§€ μ•μ€ ν™ μ‚¬μ©λ‰μ„ ν™•μΈν•  μ μμ—μµλ‹λ‹¤.

<img width="1416" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/943c1214-3d93-4415-9908-02e40a46ebc8">

