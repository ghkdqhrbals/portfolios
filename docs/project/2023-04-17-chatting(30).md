---
layout: default
title: 30. Spring Cloud ê¸°ë°˜ MSA ë³€í™˜ ì‹œì‘-5
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 30
---
created at 2023-04-17
{: .label .label-yellow }
# 1. Saga Choreography Architecture

v5 ë²„ì „ì¸ í˜„ì¬ êµ¬í˜„ì§„í–‰/ì™„ë£Œ ì¤‘ì¸ ì•„í‚¤í…ì²˜ì…ë‹ˆë‹¤.

![img](../../../assets/img/msa/12.svg)


# 2. Saga Choreography ì´ë²¤íŠ¸ ì„±ê³µê°’ í´ë¼ì´ì–¸íŠ¸ ë°˜í™˜ feat. SSE

ì €ëŠ” ì‹ ê·œìœ ì € ì¶”ê°€ ê¸°ëŠ¥ì„ Sagaì˜ Choreography ë¡œ êµ¬í˜„í•˜ì˜€ëŠ”ë°ìš”. ì—¬ê¸°ì„œ ê¸°ëŠ¥ì ìœ¼ë¡œ í˜ë“¤ì—ˆë˜ ë¶€ë¶„ì´ ìˆì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì´ë²¤íŠ¸ë“¤ì´ ëª¨ë‘ ì²˜ë¦¬ë˜ì—ˆì„ ë•Œ, í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ê·¸ ê²°ê³¼ê°’ì„ ë°˜í™˜í•˜ëŠ” ë¶€ë¶„ì´ì˜€ì–´ìš”. ê·¸ë˜ì„œ ì €ëŠ” ìœ„ì˜ ê·¸ë¦¼ì—ì„œë„ ì„¤ëª…í•˜ì˜€ë˜ **Server-Sent-Event** ì™€ **WebFlux** ë¡œ ì´ë¥¼ í•´ê²°í•˜ì˜€ìŠµë‹ˆë‹¤. ë¨¼ì € ê²°ê³¼ë¶€í„° ë³¼ê¹Œìš”?

## 2.1 Saga Choreography ì´ë²¤íŠ¸ ì„±ê³µê°’ í´ë¼ì´ì–¸íŠ¸ ë°˜í™˜ ê²°ê³¼
![img](../../../assets/img/msa/13.png)

userStatus/chatStatus/customerStatus ì´ ì„¸ ê°€ì§€ê°€ Kafka MQ ë°±ë³¸ë§ì„ í†µí•´ ì²˜ë¦¬ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  SSE ë¡œ stream í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ë“¤ì´ í•˜ë‚˜ì”© ì „ì†¡ë©ë‹ˆë‹¤.

## 2.2 í•˜ë‚˜ì˜ í´ë¼ì´ì–¸íŠ¸ ë‹¹ í•˜ë‚˜ì˜ Sinks ìƒì„±

ì €ëŠ” Netty ë¡œ ì›¹ì„œë²„ë¥¼ êµ¬ì¶•í–ˆëŠ”ë°ìš”. NettyëŠ” Spring-WebFluxë¥¼ ì§€ì›í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  WebFlux ëŠ” ë©€í‹° ìŠ¤ë ˆë“œë¡œë¶€í„° í•˜ë‚˜ì˜ ì±„ë„ì„ êµ¬ì¶•í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” `Sinks` ê°ì²´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. 

ìš°ë¦¬ê°€ í•´ê²°í•´ì•¼ í•˜ëŠ” ë¬¸ì œëŠ” **ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¡œë¶€í„° í•˜ë‚˜ì˜ ì±„ë„ì„ í†µí•´ ì§€ì†ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ê°€ ê²°ê³¼ê°’ì„ ë°˜í™˜ë°›ë„ë¡ í•˜ëŠ”ê²ƒ**ì´ì£ ? ì´ ì±„ë„ì„ Sinks ê°ì²´ë¡œ ì„¤ì •í•œë‹¤ë©´ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

### 2.2.1 Concurrent Sinks Map ìƒì„±

```java
public static ConcurrentHashMap<String, Sinks.Many<Object>> sinkMap = new ConcurrentHashMap<>();
```


ì—¬ëŸ¬ ìŠ¤ë ˆë“œì˜ ì ‘ê·¼ìœ¼ë¡œë¶€í„° lock í•´ì£¼ëŠ” `ConcurrentHashMap` ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. Key ê°’ìœ¼ë¡œëŠ” userIdë¥¼ ì‚¬ìš©í•  ê²ƒì´ë©°, Value ë¡œëŠ” **í•˜ë‚˜ì˜ ì±„ë„** ì¦‰ Sinks ê°ì²´ë¥¼ í• ë‹¹í•´ì¤ë‹ˆë‹¤. ì´ëŠ” @Configuration ì—ë‹¤ê°€ static ìœ¼ë¡œ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

### 2.2.2 **Kafka Listener Thread** ì—ì„œ Sinks êº¼ë‚´ì„œ Flux streaming

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class MessageListener {
    private final UserCommandQueryService userService;
    private final KafkaTemplate<String, Object> kafkaProducerTemplate;

    // concurrencyë¥¼ partition ê°œìˆ˜ì— ë§ì¶”ì–´ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤!
    // ì €ëŠ” partition ê°œìˆ˜ë¥¼ 5ë¡œ ì„¤ì •í•´ì„œ concurrency íŒŒë¼ë¯¸í„°ì— "5"ë¡œ ì„¤ì •í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
    @KafkaListener(topics = KafkaTopic.userRes, containerFactory = "userKafkaListenerContainerFactory", concurrency = KafkaTopicPartition.userRes)
    public void listenUser(UserResponseEvent req) {
        log.info("ë©”ì„¸ì§€ ë„ì°© = {}", req.getServiceName());

        // ì´ë²¤íŠ¸ Status ë¥¼ Trancation í…Œì´ë¸”ì— ì—…ë°ì´íŠ¸ ì‹œì¼œì¤ë‹ˆë‹¤.
        userService.updateStatus(req).exceptionally(e->{
            // ì´ë²¤íŠ¸ ì‘ë‹µë“¤ì„ ì²˜ë¦¬í•  ë•Œ ì—ëŸ¬ê°€ ë‚œë‹¤ë©´, sinkMap ì—ì„œ Sinks ë¥¼ ê°€ì ¸ì™€ì„œ tryEmitError()ë¥¼ í†µí•´
            // ì—ëŸ¬ emit + onComplete ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•©ë‹ˆë‹¤.
            AsyncConfig.sinkMap.get(req.getUserId()).tryEmitError(e);
            return null;
        });
    }

    private void sendToKafka(String topic,Object req) {
        kafkaProducerTemplate.send(topic, req).thenAccept((SendResult<String, Object> result)->{
            log.debug("ë©”ì„¸ì§€ ì „ì†¡ ì„±ê³µ topic={}, offset={}, partition={}",topic, result.getRecordMetadata().offset(), result.getRecordMetadata().partition());
        }).exceptionally(e->{
            log.error("ë©”ì„¸ì§€ ì „ì†¡ ì‹¤íŒ¨={}", e.getMessage());
            return null;
        });
    }
}
```

### 2.2.3 **Service Thread** ì—ì„œ Sinks êº¼ë‚´ì„œ Flux streaming

```java
public class userServiceImpl implements userService{
    ...
    @Override
    @Async
    @Transactional
    public CompletableFuture<UserTransaction> updateStatus(UserResponseEvent event) {
        Optional<UserTransaction> tx = userTransactionRepository.findByEventId(event.getEventId());

        if (tx.isPresent()){
            UserTransaction ut = tx.get();
            // ì„œë¹„ìŠ¤ ì´ë¦„ì„ í†µí•´ ë©”ì„¸ì§€ Status êµ¬ë¶„
            switch (event.getServiceName()){
                case ServiceNames.chat -> {
                    ut.setChatStatus(event.getUserResponseStatus());
                    break;
                }
                case ServiceNames.customer -> {
                    ut.setCustomerStatus(event.getUserResponseStatus());
                    break;
                }
            }
            String chatStatus = ut.getChatStatus();
            String customerStatus = ut.getCustomerStatus();
            String userStatus = ut.getUserStatus();
            
            // ë‘˜ ë‹¤ SUCCESS ì¼ ê²½ìš°,
            if (chatStatus.equals(UserResponseStatus.USER_SUCCES.name())
                    && customerStatus.equals(UserResponseStatus.USER_SUCCES.name())){
                // ìœ ì € Status ì— ë”°ë¼ ì™„ë£Œ/ë¯¸ì™„ë£Œ
                if (userStatus.equals(UserStatus.USER_INSERT.name())){

                    // ìœ ì € ì €ì¥
                    Optional<User> findUser = userRepository.findById(ut.getUserId());
                    if (!findUser.isPresent()){
                        User user = new User(
                                ut.getUserId(),
                                ut.getUserPw(),
                                ut.getEmail(),
                                ut.getUserName(),
                                LocalDateTime.now(),
                                LocalDateTime.now(),
                                LocalDateTime.now(),
                                ut.getRole()
                        );
                        userRepository.save(user);
                    }else{
                        // ìœ ì €ê°€ ì´ë¯¸ ì¡´ì¬í•  ë•Œ
                        ut.setUserStatus(UserStatus.USER_INSERT_FAIL.name());
                        // CompletableFuture Fail ì²˜ë¦¬
                        return CompletableFuture.failedFuture(new ResponseStatusException(HttpStatus.CONFLICT, "ë™ì¼í•œ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤"));
                    }
                    
                    // ì´ë²¤íŠ¸ Transaction UPDATE
                    ut.setUserStatus(UserStatus.USER_INSERT_COMPLETE.name());

                    // ê²°ê³¼ SSE í´ë¼ì´ì–¸íŠ¸ ë°˜í™˜
                    AsyncConfig.sinkMap.get(event.getUserId()).tryEmitNext(ut);
                    AsyncConfig.sinkMap.get(event.getUserId()).tryEmitComplete();

                } else if (userStatus.equals(UserStatus.USER_DELETE.name())) {
                    userRepository.deleteById(ut.getUserId());
                    
                    // ì´ë²¤íŠ¸ Transaction UPDATE
                    ut.setUserStatus(UserStatus.USER_DELETE_COMPLETE.name());

                    // ê²°ê³¼ SSE í´ë¼ì´ì–¸íŠ¸ ë°˜í™˜
                    AsyncConfig.sinkMap.get(event.getUserId()).tryEmitNext(ut);
                    AsyncConfig.sinkMap.get(event.getUserId()).tryEmitComplete();
                }
                
            } else if (chatStatus.equals(UserResponseStatus.USER_FAIL.name())
                    || customerStatus.equals(UserResponseStatus.USER_FAIL.name())) {
                // chatService/customerService ë¡œ ë¶€í„° ì‘ë‹µë°›ì€ ì´ë²¤íŠ¸ì— FAIL ì´ ìˆì„ ê²½ìš°
                // Transaction FAIL ì²˜ë¦¬
                ut.setUserStatus(UserStatus.USER_INSERT_FAIL.name());
                return CompletableFuture.failedFuture(new ResponseStatusException(HttpStatus.CONFLICT, "ë™ì¼í•œ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤"));
                
            } else {
                // ì¤‘ê°„ ê²°ê³¼ê°’ë“¤ ê³„ì† í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡
                AsyncConfig.sinkMap.get(event.getUserId()).tryEmitNext(ut);
            }
        }else{
            // ì´ë²¤íŠ¸ íŠ¸ëœì ì…˜ì´ ì—†ì„ ë•Œ, 
            return CompletableFuture.failedFuture(new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, "ì—†ëŠ” íŠ¸ëœì ì…˜ ì…ë‹ˆë‹¤"));
        }
        return CompletableFuture.completedFuture(tx.get());
    }
    ...
}
```

### 2.2.4 **Executor Threads(Netty)** ì—ì„œ Sinks êº¼ë‚´ì„œ Flux streaming

```java
public class UserController {
    ...
    @PostMapping(value = "/user", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<?> saveUser(@RequestBody RequestUser req) throws InterruptedException {
        // saga choreograhpy tx ê´€ë¦¬ id;
        UUID eventId = UUID.randomUUID();
        
        // SinkMap ì— í´ë¼ì´ì–¸íŠ¸ Sinks ì €ì¥
        AsyncConfig.sinkMap.put(req.getUserId(), Sinks.many().multicast().onBackpressureBuffer());

        UserEvent userEvent = new UserEvent(
                eventId,
                UserStatus.USER_INSERT,
                req.getUserId()
        );
        
        // ì´ë²¤íŠ¸ Publishing (ë§Œì•½ MQê°€ ë‹«í˜€ìˆìœ¼ë©´ exception)
        userCommandQueryService
                .newUserEvent(req, eventId, userEvent)
                .exceptionally(e -> {
                    if (e.getCause() instanceof CustomException) {
                        CustomException e2 = ((CustomException) e.getCause());
                        AsyncConfig.sinkMap.get(req.getUserId()).tryEmitError(new ResponseStatusException(e2.getErrorCode().getHttpStatus(), e2.getErrorCode().getDetail()));
                    } else {
                        AsyncConfig.sinkMap.get(req.getUserId()).tryEmitError(new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, e.getMessage()));
                    }
                    return null;
                });
        return AsyncConfig.sinkMap.get(req.getUserId()).asFlux().log();
    }
}
```

{: .important}
> ë¬¸ì œì ì´ ëª‡ ê°œ ë³´ì´ëŠ”ë°ìš”. **1) í´ë¼ì´ì–¸íŠ¸ì˜ ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡­ê²Œ Sinks ë¥¼ ì—…ë°ì´íŠ¸í•˜ê²Œ ëœë‹¤ëŠ” ë¬¸ì œ**ê°€ í•˜ë‚˜ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  í•´ë‹¹ **2) ConcurrentHashMap ì˜ ì‚¬ì´ì¦ˆë¥¼ ê³ ë ¤**í•´ì•¼ í•œë‹¤ëŠ” ì  ë˜í•œ ë¬¸ì œê°€ ë  ê²ƒ ê°™ì•„ìš”. ì´ ë¶€ë¶„ì€ ê³ ë¯¼í•´ë´ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

