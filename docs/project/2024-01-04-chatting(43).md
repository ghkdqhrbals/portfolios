---
layout: default
title: 43. ì„œë²„ì„±ëŠ¥ ê°œì„ ê¸°ë¡ - ğŸ”´MTTFB í‰ê· ì°¨ì´ - 31% ì„±ëŠ¥ê°ì†Œ
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 42
---

created at 2024-01-07
{: .label .label-yellow }


ì €ëŠ” ì±„íŒ…ì„œë²„ì˜ Interceptor ì—ì„œ Redis Session ì— ì €ì¥ëœ refreshToken ì„ find í•˜ë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì´ëŸ¬í•œ Interceptor ë©”ì†Œë“œì™€ Redis ì§€ì—°ì‹œê°„ì„ io.micrometer ë¡œ ì¸¡ì •í•´ë³´ì•˜ëŠ”ë°ìš”. ì•„ë˜ì™€ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤.

![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/497d6330-276d-4820-b87c-2d595278a481)

![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/a9f824b0-72d2-411d-ab1e-e85919c8536f)

![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/7f16f7e4-ada8-46ee-a3d8-f210f21c41b7)

ìš°ë¦¬ê°€ ë´ì•¼í•  ë¶€ë¶„ì€ UserRedisSessionRepository ì˜ ì§€ì—°ì‹œê°„ì…ë‹ˆë‹¤! **ì´ ì§€ì—°ì‹œê°„ì´ ë‹¤ë¥¸ RDB ì™€ ë¹„êµí–ˆì„ ë•Œ ë„ˆë¬´ë‚˜ë„ ë†’ì•˜ìŠµë‹ˆë‹¤**. ì•„ë‹ˆ ë¹ ë¥´ê²Œ ë°ì´í„°ë¥¼ ì°¾ê¸°ìœ„í•´ Redis remote in-memory ë¥¼ ì“°ëŠ”ë°, RDB ë³´ë‹¤ ì„±ëŠ¥ì´ ë‚®ë‹¤ë‹ˆìš”... ê·¸ë˜ì„œ ì €ëŠ” Redis ì˜ ì„±ëŠ¥ì„ ë†’ì´ê¸° ìœ„í•´ Lettuce ê°€ ì œê³µí•˜ëŠ” connection pool ì„ ì“°ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤. **Lettuce CP(Connection Pool)ì˜ default ê°’ë“¤ì„ ìˆ˜ì •**í•˜ë©´ì„œ ì—¬ëŸ¬ ì„±ëŠ¥ì§€í‘œë“¤ì„ ëª¨ì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

- ê¸°ì¡´(max-active:8, max-idle: 8, min-idle: 0) **= Original**

  * TPS í‰ê· : 362.60
  * TPS p95: 438.80
  * TPS p99: 494.42
  * MTTFB í‰ê· : 590.52 ms
  * MTTFB p95: 875.44 ms
  * MTTFB p99: 1167.77 ms
  * MTTFB ì°¨ì´ í‰ê·  : 78.26 ms
  * MTTFB í‰ê· ì ì¸ ë³€ë™ë¥ : 11.81%

- ë³€ê²½(max-active:100, max-idle: 50, min-idle: 10) = **Change1**

  * TPS í‰ê· : 342.94
  * TPS p95: 450.15
  * TPS p99: 502.65
  * MTTFB í‰ê· : 599.58 ms
  * MTTFB p95: 1131.07 ms
  * MTTFB p99: 1531.29 ms
  * MTTFB ì°¨ì´ í‰ê·  : 122.83 ms
  * MTTFB í‰ê· ì ì¸ ë³€ë™ë¥ : 19.00%

- ë³€ê²½(max-active:150, max-idle: 70, min-idle: 50) = **Change2**

  * TPS í‰ê· : 338.45
  * TPS p95: 433.25
  * TPS p99: 491.85
  * MTTFB í‰ê· : 600.22 ms
  * MTTFB p95: 1012.68 ms
  * MTTFB p99: 1241.76 ms
  * MTTFB ì°¨ì´ í‰ê·  : 104.21 ms
  * MTTFB í‰ê· ì ì¸ ë³€ë™ë¥ : 16.47%


|Metric | Change1 (%) | Change2 (%) |
|---|--- |-------------|
|TPS_Average | -5.42%ğŸ”´ | -6.66%ğŸ”´    |
|TPS_p95 | 2.59% ğŸ”´| -1.26% ğŸ”´   |
|TPS_p99 | 1.66% ğŸ”´ | -0.52% ğŸ”´   |
|MTTFB_Average | -1.53% ğŸ”´| -1.64% ğŸ”´   |
|MTTFB_p95 | -29.20% ğŸ”´| -15.68% ğŸ”´  |
|MTTFB_p99 | -31.13% ğŸ”´| -6.34% ğŸ”´   |



![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/26acbaf5-bc0b-4eb4-b8ab-368782143a48)


ê²°ê³¼ë¶€í„° ë§ì”€ë“œë¦¬ë©´ ë‚®ì€ CP ê°€ ì˜¤íˆë ¤ ì„±ëŠ¥ì§€í‘œê°€ ë” ì¢‹ê²Œ ë‚˜ì™”ìŠµë‹ˆë‹¤. ì—¬ì „íˆ Redis Repository Latency ê°€ ë‹¤ë¥¸ RDB Latency ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤ ã…œã…œ ğŸ˜‚

### refreshToken í™•ì¸í•˜ëŠ” interceptor ì§€ì—°ì‹œê°„ ì´ì „ê³¼ ì´í›„

![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/497d6330-276d-4820-b87c-2d595278a481)

<img width="1060" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/84a1a567-e5c1-4583-9f07-02e1b5f653a9">

### Repository ì§€ì—°ì‹œê°„ ì´ì „ê³¼ ì´í›„

![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/a9f824b0-72d2-411d-ab1e-e85919c8536f)

<img width="1060" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/b9bc9310-df21-4b41-9f4a-d5b85fcc3c61">

### Repository ì§€ì—°ì‹œê°„ max time ì´ì „ê³¼ ì´í›„

![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/7f16f7e4-ada8-46ee-a3d8-f210f21c41b7)

<img width="1060" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/e698e718-ed75-4047-8a0f-46beed52ea5b">

* CP ì¦ê°€ ì´í›„

<img width="1105" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/2c81de42-180c-4685-8c0d-4e7415be1b1e">



## ì™œ ì˜¤íˆë ¤ ê°ì†Œí•˜ì§€? :(

- [x]  ë„¤íŠ¸ì›Œí¬ bandwidth ë¶€ì¡±ë¬¸ì œ      
  â†’ ë„¤íŠ¸ì›Œí¬ 1.5Mbps ë§Œ ì¨ì„œ ë„¤íŠ¸ì›Œí¬ bandwidth ëŠ” ì¶©ë¶„í–ˆìŠµë‹ˆë‹¤ ğŸ˜Ÿ
- [x]  ê³¼ë„í•œ cpu usage ë¬¸ì œ       
  ![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/11d20bd0-98c0-400d-bced-d522a0159174)
  â†’ cpu usage ê·¸ë˜í”„ í™•ì¸í•´ë³´ë©´ ê±°ì˜ ì‚¬ìš©ëŸ‰ì´ ë§¤ìš° ë‚®ìŠµë‹ˆë‹¤. 
- [x]  ë©”ëª¨ë¦¬ fragementation? ì•„ë‹ˆë©´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë„ˆë¬´ ë†’ì€ê°€ìš”?     
  ![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/3708690b-a74f-44e3-a18b-14ff61b1d674)
  â†’ ì”ì—¬ ë©”ëª¨ë¦¬ê°€ 40% ì´ìƒ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ Memory fragementation ì€ ì œì™¸í–ˆìŠµë‹ˆë‹¤.
- [x]  Key indexing ì´ ì œëŒ€ë¡œ ì•ˆë˜ì–´ìˆì–´ì„œ ì°¾ê¸°ê°€ í˜ë“ ê°€ìš”?       
  ![image](https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/64fb4341-8240-4c28-8c7c-cab682b17c5f)
  Redis HASH search O(1) ë¡œ ë¹ ë¥´ê²Œ ì°¾ì•„ìš”. ì¦‰ indexing ì€ ì œëŒ€ë¡œ ë˜ì–´ìˆì–´ìš”!
- [x] Race Condition ë¬¸ì œì¸ê°€ìš”?           
  Redis ëŠ” ì‹±ê¸€ìŠ¤ë ˆë“œë¡œ ë™ì‘í•˜ê¸°ë•Œë¬¸ì— Race ê²½í•©ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤ê³  ì•Œê³ ìˆìŠµë‹ˆë‹¤(ë¬¼ë¡  ê²½ìš°ì— ë”°ë¼ ë©€í‹°ìŠ¤ë ˆë“œë¡œ ì „í™˜í•  ìˆ˜ ìˆê¸´ í•˜ì§€ë§Œìš”).

ì•„ì§ ì´ìœ ë¥¼ íŒŒì•…í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ ğŸ˜­ í˜¹ì‹œ ì–´ë–¤ ì´ìœ ì¸ì§€ ì•Œê³  ê³„ì‹ ë‹¤ë©´ ghkdqhrbals@gmail.com ìœ¼ë¡œ ì—°ë½ì£¼ì‹œë©´ ë„ˆë¬´ë„ˆë¬´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ™