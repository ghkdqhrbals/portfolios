---
layout: default
title: 40. ì„œë²„ì„±ëŠ¥ ê°œì„ ê¸°ë¡ - ğŸŸ¢TPS p99 4556%, MTTFB p95 94.47% ê°œì„ 
parent: ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
date: 2023-12-21
nav_order: 40
---

created at 2023-12-21
{: .label .label-yellow }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

## ì„œë¡ 

ì €ëŠ” ì—¬ëŸ¬ í˜ì´ì¦ˆë¥¼ ì§„í–‰í•˜ë©° ì„±ëŠ¥ ê°œì„ ì„ ì§„í–‰í•˜ì˜€ê³ , ê° í˜ì´ì¦ˆ ë³„ ì„±ëŠ¥ìˆ˜ì¹˜ë“¤ì„ ë¨¼ì € ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
![img](../../../assets/cd/5.png)
* **Phase 1** : HPA ë¥¼ í†µí•œ íŒŒë“œ ì˜¤í†  ìŠ¤ì¼€ì¼ë§ ì•„ì›ƒ ì ìš©
* **Phase 2** : Readiness íƒ€ì„ì•„ì›ƒ ì¦ê°€
* **Phase 3** : ë‚´ì¥ tomcat max-threads í¬ê¸° ì¦ê°€
* **Phase 4** : ë‚´ì¥ tomcat ìµœì í™”

í‘œë¥¼ ë´ë„ ì–¼ë§ˆë‚˜ ê°œì„ ë˜ì—ˆëŠ”ì§€ í•œ ëˆˆì— ì˜ ì•ˆë³´ì´ì£ ?ã…ã… ê·¸ë˜ì„œ ê·¸ë˜í”„ë¡œ í‘œí˜„í•´ë´¤ìŠµë‹ˆë‹¤!
![img](../../../assets/cd/tps.png)
![img](../../../assets/cd/mttfb.png)
![img](../../../assets/cd/p.png)

ê·¸ëŸ¼ ì´ì œ ê°ê°ì˜ ì„±ëŠ¥ ê°œì„  í˜ì´ì¦ˆë¥¼ í•˜ë‚˜ì”© ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤!


## ì„œë²„ ë¡œë“œ í…ŒìŠ¤íŠ¸ í™˜ê²½
* Thread(virtual user) : 296
* URL : GET /rooms
* Duration : 10min
* Test-Server
  * CPU : 8 virtual core
  * Memory : 32GB
  * OS : MacOS Big Sur
* Target-Server EC2 ì¸ìŠ¤í„´ìŠ¤
  * Instance Type: t3.medium, 3ëŒ€ ì›Œì»¤ë…¸ë“œ ìš´ìš©
  * CPU : 2 virtual core, total 6 virtual core
  * Memory : 4GB, total 12GB
  * OS : Amazon Linux 2 x86_64 HVM gp2

## ë¡œë“œ í…ŒìŠ¤íŠ¸
### **Original. ë‹¨ì¼ ì±„íŒ…ì„œë²„ íŒŒë“œë¡œ í•¸ë“¤ë§ ì‹œ ê²°ê³¼**

| Metric             | Before       |
|--------------------|--------------|
| Total Tests        | **40,228**       |
| Error Rate         | **51.11% (20,560)** |
| TPS í‰ê·  (Average)  | **109.27**       |
| TPS p50            | **69.00**        |
| TPS p95            | **4.00**         |
| TPS p99            | **2.84**         |
| TPS p99.9          | **1.63**         |
| MTTFB í‰ê·  (Average)| **1605.44 ms**   |
| MTTFB p50          | **1636.55 ms**   |
| MTTFB p95          | **24013.28 ms**  |
| MTTFB p99          | **27690.40 ms**  |
| MTTFB p99.9        | **28157.50 ms**  |
| MTTFB ì°¨ì´ í‰ê·  (Average Difference)| **2838.38 ms**|
| MTTFB í‰ê· ì ì¸ ë³€ë™ë¥  (Average Variability)| **75.00%** |

* í…ŒìŠ¤íŠ¸ ì§€í‘œ í™•ì¸

ë§Œì•½ HPA íŒŒë“œ ì˜¤í†  ìŠ¤ì¼€ì¼ ì•„ì›ƒ ì—†ì´ ë‹¨ì¼ íŒŒë“œë¡œë§Œ í•¸ë“¤ë§í•  ë•Œ ì–´ë–¤ ê²°ê³¼ê°€ ë‚˜ì˜¬ì§€ ê¶ê¸ˆí•˜ì§€ ì•Šë‚˜ìš”? ê·¸ë˜ì„œ ì‹¤í—˜í•´ë³´ì•˜ê³  ìœ„ì˜ ê²°ê³¼ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤.
ì‹¤í—˜ ì¤‘ ì˜¤ë¥˜ê°€ ë„ˆë¬´ ë§ì´ ë°œìƒë˜ì„œ ìë™ìœ¼ë¡œ ì¤‘ì§€ë  ì •ë„ë¡œ ë§ì€ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì—ëŸ¬ë¥ ì´ 50% ì´ìƒì„ ê¸°ë¡í•´ë²„ë ¸ìŠµë‹ˆë‹¤.
ì „ì²´ íŠ¸ëœì­ì…˜ì˜ 95% ëŠ” 4 TPS ë‚´ë¡œ ì²˜ë¦¬ë˜ê³  99.9% ëŠ” 1.63 TPS ë‚´ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. í•˜ìœ„ íŠ¸ëœì­ì…˜ì²˜ë¦¬ëŸ‰ì´ ë§¤ìš° ë‚®ì£ . 

MTTFB ë˜í•œ ë†’ì€ ìˆ˜ì¹˜ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. p99 ëŠ” 27ì´ˆ, p99.9 ëŠ” 28ì´ˆë¡œ ì²˜ë¦¬ë˜ê³  ìˆìŠµë‹ˆë‹¤... ì´ëŠ” ì„œë²„ê°€ ë§¤ìš° ëŠë¦¬ê²Œ ì‘ë‹µí•˜ê³  ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
ë˜í•œ í‰ê·  MTTFB ì™€ ë§¤ìš° í° ì°¨ì´ë¥¼ ë³´ì¸ë‹¤ëŠ” ëœ»ì€ ì„œë²„ì˜ ì‘ë‹µì‹œê°„ì´ ë§¤ìš° ë¶ˆì•ˆì •í•˜ë‹¤ëŠ” ê²ƒì„ ë³´ì—¬ì£¼ì£ !

í•´ë‹¹ ë¡œë“œ í…ŒìŠ¤íŠ¸ëŠ” 10ë¶„ë™ì•ˆ ì‹¤í–‰í•˜ë„ë¡ ì§€ì‹œí–ˆì§€ë§Œ 03:10 ì— ë†’ì€ ì—ëŸ¬ìœ¨ë¡œ ì¸í•´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

<img width="1013" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/08caf7f8-6cba-4a95-ae34-e2d2c4164cac">

### **Phase 1. HPA ë¥¼ í†µí•œ íŒŒë“œ ì˜¤í†  ìŠ¤ì¼€ì¼ë§ ì ìš© ì‹œ ê²°ê³¼**

ê·¸ëŸ¬ë©´ CPU ìì›ì„ ì¢€ ë” ë§ì´ ì¨ë³¼ê¹Œìš”? Kubernetes HPA(HorizontalPodAutoscaler) ë¥¼ í†µí•´ íŒŒë“œë¥¼ cpu ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ìë™ìœ¼ë¡œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ/ì¸ì„ ìˆ˜í–‰í•˜ë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ë¥¼ í†µí•´ ë‹¤ì‹œ ë¡œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ì•˜ìŠµë‹ˆë‹¤. 

| Metric             | Before       | After        | Change            |
|--------------------|--------------|--------------|-------------------|
| Total Tests        | 40,228       | 142,805      | **254.91% ğŸŸ¢**        |
| Error Rate         | 51.11%(20,560)| 6.57%(9,389) | **-87.16% ğŸŸ¢**        |
| TPS í‰ê·  (Average)  | 109.27       | 228.45       | **109.07% ğŸŸ¢**        |
| TPS p50            | 69.00        | 238.25       | **245.29% ğŸŸ¢**        |
| TPS p95            | 4.00         | 80.38        | **1909.50% ğŸŸ¢**       |
| TPS p99            | 2.84         | 6.82         | **139.44% ğŸŸ¢**        |
| TPS p99.9          | 1.63         | 1.87         | **14.72% ğŸŸ¢**         |
| MTTFB í‰ê·  (Average)| 1605.44 ms   | 1265.08 ms   | **-21.20% ğŸŸ¢**        |
| MTTFB p50          | 1636.55 ms   | 934.00 ms    | **-42.96% ğŸŸ¢**        |
| MTTFB p95          | 24013.28 ms  | 4105.42 ms   | **-82.89% ğŸŸ¢**        |
| MTTFB p99          | 27690.40 ms  | 19557.53 ms  | **-29.33% ğŸŸ¢**        |
| MTTFB p99.9        | 28157.50 ms  | 21906.02 ms  | **-22.19% ğŸŸ¢**        |
| MTTFB ì°¨ì´ í‰ê·  (Average Difference)| 2838.38 ms | 1020.87 ms | **-64.12% ğŸŸ¢**        |
| MTTFB í‰ê· ì ì¸ ë³€ë™ë¥  (Average Variability)| 75.00% | 86.83% | **15.77% ğŸ”´**         |


* í…ŒìŠ¤íŠ¸ ì§€í‘œ í™•ì¸ ë° ê°œì„ ì 
  
<img width="970" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/4ea4c027-34f7-4293-95e2-b7799382bede">
    
ì¤‘ê°„ì¤‘ê°„ TPS ê°€ ê°ì†Œí•˜ëŠ” ëª¨ìŠµì„ í™• ìœ„ì˜ ê·¸ë˜í”„ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. TPS ê°ì†Œ ì´ìœ ëŠ” ì•„ë˜ì˜ ê·¸ë˜í”„ì—ì„œ ì›ì¸ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
<img width="975" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/80d42111-f3d2-4318-913c-5d436d86afee">
    
<img width="974" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/ece440d4-52c1-4c01-93b5-8db783a7e33d">
    
MTTFB ê°€ ì¤‘ê°„ì¤‘ê°„ 5ì´ˆê°€ ë„˜ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ëŸ° í”¼í¬ë¥¼ ë³´ì¼ ë•Œ ë§ˆë‹¤ ì˜¤ë¥˜ë˜í•œ ì¦ê°€í•©ë‹ˆë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ TPS ë˜í•œ ê°™ì´ ê°ì†Œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì €ëŠ” ì±„íŒ…ì„œë²„ì˜ ë¡œë“œê°€ ì¤‘ê°„ì¤‘ê°„ ì¦ê°€í•´ì„œ í—¬ìŠ¤ì²´í¬ì˜ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí–ˆê³ , ì„œë¹„ìŠ¤ê°€ ë¡œë“œë°¸ëŸ°ì‹±ì„ ë‹¤ì‹œ ìˆ˜í–‰í•˜ë©´ì„œ  TPS ê°€ ê°ì†Œí–ˆë‹¤ê³  ìƒê°í–ˆì–´ìš”. í•œë²ˆ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.
> ì±„íŒ…ì„œë²„ì˜ Deployment ì˜ readinessProbe í—¬ìŠ¤ì²´í¬ timeoutSecondsëŠ” 1ì´ˆë¡œ ì„¤ì •ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤.
    
<img width="1440" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/54e51317-0a91-4457-bf15-626b4e729964">
    
deploy ë¡œê·¸ë¥¼ í™•ì¸í–ˆë”ë‹ˆ ì—­ì‹œ health íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ íƒ€ì„ì•„ì›ƒì„ 60ì´ˆë¡œ ì„¤ì •í•˜ë©´ ê²¬ë”œ ìˆ˜ ìˆê² ì£ ?

### **Phase 2. Readiness íƒ€ì„ì•„ì›ƒ 1ì´ˆ -> 60ì´ˆ**


| Metric                                | Before       | After      | Change         |
|---------------------------------------|--------------|------------|----------------|
| Total Tests                           | 142,805      | 138,487    | **-3.02% ğŸ”´**      |
| Error Rate                            | 6.57%(9,389) | 0.02%(25)  | **No Error ğŸŸ¢**     |
| TPS í‰ê·  (Average)                      | 228.45       | 237.09     | **3.78% ğŸŸ¢**       |
| TPS p50                               | 238.25       | 243.50     | **2.21% ğŸŸ¢**       |
| TPS p95                               | 80.38        | 126.53     | **57.38% ğŸŸ¢**      |
| TPS p99                               | 6.82         | 64.56      | **846.16% ğŸŸ¢**     |
| TPS p99.9                             | 1.87         | 47.60      | **2430.48% ğŸŸ¢**    |
| MTTFB í‰ê·  (Average)                    | 1265.08 ms   | 1224.22 ms | **-3.23% ğŸŸ¢**      |
| MTTFB p50                             | 934.00 ms    | 1150.59 ms | **23.19% ğŸ”´**      |
| MTTFB p95                             | 4105.42 ms   | 2383.01 ms | **-41.98% ğŸŸ¢**     |
| MTTFB p99                             | 19557.53 ms  | 3636.65 ms | **-81.39% ğŸŸ¢**     |
| MTTFB p99.9                           | 21906.02 ms  | 4132.45 ms | **-81.15% ğŸŸ¢**     |
| MTTFB ì°¨ì´ í‰ê·  (Average Difference)      | 1020.87 ms   | 437.17 ms  | **-57.18% ğŸŸ¢**     |
| MTTFB í‰ê· ì ì¸ ë³€ë™ë¥  (Average Variability)  | 86.83%       | 35.20%     | **-59.46% ğŸŸ¢**     |

* í…ŒìŠ¤íŠ¸ ì§€í‘œ í™•ì¸ ë° ê°œì„ ì 

Error ëŠ” 0.0% ë¡œ ì—ëŸ¬ì—†ì´ ì •ìƒì ì¸ ìš”ì²­ì²˜ë¦¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ë˜í•œ MTTFBì™€ TPS ì˜ p95, p99, p99.9 ëª¨ë‘ **í° í­ìœ¼ë¡œ ìƒìŠ¹**í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤!
ì›ë˜ëŠ” ì„œë²„ê°€ ì–´ëŠì •ë„ ë¶€í•˜ê°€ ë°œìƒí•´ì„œ K8S health check restAPI ë¥¼ 1ì´ˆë‚´ì— ì‘ë‹µí•˜ì§€ ëª»í•˜ë©´ ì„œë²„ê°€ êº¼ì§ìœ¼ë¡œ ì¸í•´ ì—ëŸ¬ê°€ ëŒ€í­ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê·¸ ì œí•œì‹œê°„ì„ 60ì´ˆë¡œ ëŠ˜ë¦¼ì— ë”°ë¼ ì—ëŸ¬ë¥ ì´ ê±°ì˜ 0% ë¡œ ì¤„ì—ˆì£ .
Error ê°€ ì‚¬ë¼ì§ìœ¼ë¡œ ì¸í•´ ê¸¸ê³  ê¸´ ìš”ì²­ ëŒ€ê¸°ì‹œê°„ ë˜í•œ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤. ëŒ€ê¸°ì‹œê°„ì´ ì‚¬ë¼ì§„ ê²ƒì€ MTTFB p99.9 ì˜ ê°ì†ŒëŸ‰ì„ ë³´ì—° ì•Œ ìˆ˜ ìˆì£ (21906.02 ms ì—ì„œ 4132.45 ms ë¡œ **81.15%** ê°ì†Œ)!

> ê·¸ë˜ë„ ì—¬ì „íˆ êµ°ë°êµ°ë° MTTFB í”¼í¬ê°€ **4000ms** ë¡œ ì˜¬ë¼ê°€ë©´ì„œ ì„œë²„ê°€ ì‚´ì‘ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ì— ë§ì¶”ì–´ TPS ë˜í•œ ë–¨ì–´ì§€ê³ , ì˜¤ë¥˜ë„ ì¤‘ê°„ì— ì¡°ê¸ˆì”© ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
<img width="969" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/8b54019a-200b-4541-80d8-e31d3f15616b">
    
<img width="967" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/b7b87c6a-dc44-44cc-b9fa-2e39def4c145">

### **Phase 3. ë‚´ì¥ tomcat max-threads í¬ê¸° 10ê°œ -> 100ê°œ**

ê·¸ë ‡ë‹¤ë©´ ì´ë²ˆì—” Spring boot ë‚´ì¥ í†°ì¼“ ì„œë²„ì˜ max-threads-size ë¥¼ ëŠ˜ë ¤ë´…ì‹œë‹¤. ì´ìœ ëŠ” ì±„íŒ…ì„œë²„ì˜ cpu ì‚¬ìš©ëŸ‰ì´ ìƒê°ë³´ë‹¤ ì‘ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ë§ì€ ìŠ¤ë ˆë“œë¥¼ ëŒë¦¬ê±°ë‚˜ ìš”ì²­ì„ ë§ì´ ë°›ì„ ìˆ˜ ìˆì–´ì•¼ì§€ cpu ì‚¬ìš©ë¥ ë„ ì˜¬ë¼ê°€ë‹ˆ ì´ ë¶€ë¶„ì— ë¬¸ì œê°€ ìˆë‹¤ê³  íŒë‹¨í•˜ê³  ìŠ¤ë ˆë“œ í’€ ì‚¬ì´ì¦ˆë¥¼ ëŠ˜ë¦¬ëŠ” ë°©í–¥ì„ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.


| Metric             | Before       | After        | Change       |
|--------------------|--------------|--------------|--------------|
| Total Tests        | 138,487      | 134,988      | **-2.52% ğŸ”´**    |
| Error Rate         | 0.02%(25)    | 0.03%(35)    | **No Error ğŸŸ¢** |
| TPS í‰ê·  (Average)  | 237.09       | 234.29       | **-1.18% ğŸ”´**    |
| TPS p50            | 243.50       | 244.50       | **0.41% ğŸŸ¢**     |
| TPS p95            | 126.53       | 110.55       | **-12.63% ğŸ”´**   |
| TPS p99            | 64.56        | 59.92        | **-7.00% ğŸ”´**    |
| TPS p99.9          | 47.60        | 53.07        | **11.51% ğŸŸ¢**    |
| MTTFB í‰ê·  (Average)| 1224.22 ms   | 1249.87 ms   | **2.09% ğŸ”´**     |
| MTTFB p50          | 1150.59 ms   | 1217.48 ms   | **5.80% ğŸ”´**     |
| MTTFB p95          | 2383.01 ms   | 2280.26 ms   | **-4.47% ğŸŸ¢**    |
| MTTFB p99          | 3636.65 ms   | 3473.83 ms   | **-4.47% ğŸŸ¢**    |
| MTTFB p99.9        | 4132.45 ms   | 3887.59 ms   | **-5.93% ğŸŸ¢**    |
| MTTFB ì°¨ì´ í‰ê·  (Average Difference)| 437.17 ms | 350.82 ms  | **-19.76% ğŸŸ¢**   |
| MTTFB í‰ê· ì ì¸ ë³€ë™ë¥  (Average Variability)| 35.20% | 24.47% | **-30.49% ğŸŸ¢**   |


<img width="971" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/36d9b254-6940-440d-a740-f4d2a769b296">

ê·¸ë˜í”„ë¡œ ë³¼ ë• ëª°ëì§€ë§Œ, ìˆ˜ì¹˜ë¥¼ í™•ì¸í•´ë³´ë‹ˆ í™•ì‹¤íˆ TPS ì™€ MTTFB ì˜ ìµœìƒìœ„ ì§€í‘œ(p99.9)ê°€ ë†’ê²Œ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ë˜í•œ MTTFB ì˜ ë³€ë™í­(MTTFB ì°¨ì´ í‰ê· )ì´ ì‘ì€ ê²ƒ ë˜í•œ ê´€ì°°ë˜ì£ . ì´ ë§ì€ íŠ¸ë˜í”½ì„ ê· ì¼í•œ ì‹œê°„ ë‚´ ì²˜ë¦¬í•˜ê²Œ ë˜ë‹ˆê¹Œ ì„œë²„ì˜ ì•ˆì „ì„±ì´ í–¥ìƒë˜ì—ˆë‹¤ê³  ë³¼ ìˆ˜ ìˆê² ì£ ?

ë°˜ë©´, ì•„ì§ ìƒê°ë³´ë‹¤ cpu ë¦¬ì†ŒìŠ¤ë¥¼ ì œëŒ€ë¡œ í™œìš©í•˜ì§€ ëª»í•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

<img width="874" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/1ead65ee-dd04-46d9-a4a1-267be519a83c">

> ë¹¨ê°„ì„ ì€ request ì´ë©° ë…¸ë€ì„ ì€ limit ì…ë‹ˆë‹¤. y-grid ëŠ” 0.5 cpu ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

### **Phase 4. ë‚´ì¥ tomcat ìµœì í™”**

| Metric             | Before       | After        | Change      |
|--------------------|--------------|--------------|-------------|
| Total Tests        | 134,988      | 181,050      | **34.02% ğŸŸ¢**   |
| Error Rate         | 0.03%(35)    | 0.00%(0)     | **No Error ğŸŸ¢** |
| TPS í‰ê·  (Average)  | 234.29       | 312.16       | **33.26% ğŸŸ¢**   |
| TPS p50            | 244.50       | 319.00       | **30.53% ğŸŸ¢**   |
| TPS p95            | 110.55       | 217.45       | **96.82% ğŸŸ¢**   |
| TPS p99            | 59.92        | 132.28       | **120.51% ğŸŸ¢**  |
| TPS p99.9          | 53.07        | 96.52        | **81.91% ğŸŸ¢**   |
| MTTFB í‰ê·  (Average)| 1249.87 ms   | 950.89 ms    | **-23.89% ğŸŸ¢**  |
| MTTFB p50          | 1217.48 ms   | 919.20 ms    | **-24.55% ğŸŸ¢**  |
| MTTFB p95          | 2280.26 ms   | 1322.11 ms   | **-42.04% ğŸŸ¢**  |
| MTTFB p99          | 3473.83 ms   | 1833.22 ms   | **-47.26% ğŸŸ¢**  |
| MTTFB p99.9        | 3887.59 ms   | 2099.12 ms   | **-46.05% ğŸŸ¢**  |
| MTTFB ì°¨ì´ í‰ê·  (Average Difference)| 350.82 ms | 112.52 ms | **-67.89% ğŸŸ¢**  |
| MTTFB í‰ê· ì ì¸ ë³€ë™ë¥  (Average Variability)| 24.47% | 10.67% | **-56.39% ğŸŸ¢**  |

PR https://github.com/ghkdqhrbals/spring-chatting-server/pull/334 ì—ì„œ ì ìš©ëœ í†°ì¼“ ìµœì í™” ì„¤ì •ì„ ì•„ë˜ì— í’€ì–´ë³¼ê²Œìš”.

* ëŒ€ê¸° í í¬ê¸°(accept-count) 100 -> 100
    * ìœ ì§€
* ë™ì‹œ ì—°ê²° ê°œìˆ˜(max-connections) 100 -> 8192
    * í˜„ì¬ vuser 300 ì˜ ë™ì‹œ ì—°ê²° ìš”ì²­ì„ ì „ì†¡í•˜ê¸°ë•Œë¬¸ì— ì´ë¥¼ ê³ ë ¤í•˜ì—¬ default ê°œìˆ˜ê¹Œì§€ ì¦ëŸ‰
* ìµœëŒ€ ìŠ¤ë ˆë“œ í’€ í¬ê¸°(max-threads) 100 -> 150
    * ì±„íŒ…ì„œë²„ vcpu limit 1500m ì´ê¸°ë•Œë¬¸ì— ê° ì½”ì–´ë‹¹ * 100 í•˜ì—¬ ì²˜ë¦¬ 1.5 * 100 = 150
    * í˜„ì¬ ëŒ€ë¶€ë¶„ì˜ API ìš”ì²­ì—ì„œ i/o ì‘ì—…ì„ í•˜ê¸° ë•Œë¬¸ì— ì™ ë§Œí•˜ë©´ ìŠ¤ë ˆë“œë¥¼ ëŠ˜ë¦¬ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ë§Œì•½ cpu ì†Œëª¨ëŸ‰ì´ ë§ë‹¤ê³  í•œë‹¤ë©´ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ë‹¤ê³  í•©ë‹ˆë‹¤. ê´œí•œ context switch ë¥¼ ì¤„ì´ëŠ” ê²ƒì´ íš¨ìœ¨ì ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
* ì—°ê²° íƒ€ì„ì•„ì›ƒ(connection-timeout) 10s -> 60s
    * í˜„ì¬ readinessProbe íƒ€ì„ì•„ì›ƒ ì„¤ì •ì´ 60s ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ì— ë§ì¶”ì–´ ì˜¤ë¥˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ 60s ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì˜¬ë°”ë¥´ë‹¤ê³  ìƒê°í•´ì„œ ë³€ê²½í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
* í•­ìƒ ìœ ì§€ë˜ëŠ” ìµœì†Œ ìŠ¤ë ˆë“œ í¬ê¸°(min-spare-threads) 30 -> 30
    * ìœ ì§€

ì •ë§ ì‹ ê¸°í•˜ì§€ ì•Šë‚˜ìš”? ëª¨ì˜¤ë“  ì§€í‘œì—ì„œ **ì•„ì£¼ í° í­ìœ¼ë¡œ ìƒìŠ¹**í•˜ëŠ” ê²ƒì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ë“œë””ì–´ ë™ì‹œ ìš”ì²­ ìŠ¤ë ˆë“œ 300 ì„ ìš°ë¦¬ëŠ” ì—ëŸ¬ì—†ì´ ì•ˆì •ì ìœ¼ë¡œ ê²¬ë”œ ìˆ˜ ìˆëŠ” ì„œë²„ë¥¼ ë§Œë“¤ì–´ë‚¸ê±°ì—ìš”!

ê·¸ëŸ¼ ì§€í‘œë“¤ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

TPS ì˜ ì „ì²´ ì§€í‘œë“¤ì´ ìµœì†Œ 30% ìƒìŠ¹í•˜ì˜€ìŠµë‹ˆë‹¤. ì‹¬ì§€ì–´ TPS p99 ëŠ” 120% ê°€ ê°œì„ ë˜ë©´ì„œ ëŒ€ë¶€ë¶„ì˜ ìš”ì²­ë“¤ì´ ê¾¸ì¤€íˆ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ê³  ìˆì£ .
MTTFB ë„ ë³¼ê¹Œìš”? MTTFB í‰ê· ì€ 23%ê°€ ê°œì„ ë˜ì—ˆìœ¼ë©° 90th, 95th, 99th, 99.9th ë ˆì´í„´ì‹œ í¼ì„¼íŠ¸ê°€ ëª¨ë‘ 40% ì´ìƒ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰, ë§ˆì°¬ê°€ì§€ë¡œ ëŒ€ë¶€ë¶„ì˜ ìš”ì²­ì´ ë§¤ìš° ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ê³  ìˆìŒì„ ë³´ì—¬ì£¼ì£ .
MTTFB ê·¸ë˜í”„ë¥¼ ë³´ì‹œê²Œ ë˜ë©´ ëˆˆìœ¼ë¡œ ë´ë„ ìƒë‹¹íˆ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì´ˆê¸° Initial ê³¼ì • ë¹¼ê³¤).

<img width="971" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/b1cda34a-4c3b-4d47-a3b7-79f588061e4c">
<img width="969" alt="image" src="https://github.com/ghkdqhrbals/spring-chatting-server/assets/29156882/7761580e-5c65-4bc3-bea2-571934cc0f12">

**ì €ëŠ” ì´ ê²°ê³¼ë¥¼ í†µí•´ ë³‘ëª©ì´ ê°€ì¥ ë§ì´ ê±¸ë¦¬ëŠ” ê³³ì´ ë‚´ì¥ í†°ì¼“ì´ì˜€ë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.**

ê·¸ëŸ¼ ì´ì œ í˜„ì¬ê¹Œì§€ì˜ ëª¨ë“  í…ŒìŠ¤íŠ¸ë“¤ì„ ìš”ì•½í•˜ì—¬ ì‹œì‘ê³¼ ëì˜ ì„±ëŠ¥ì§€í‘œë¥¼ ë¹„êµí•´ë³´ê² ìŠµë‹ˆë‹¤.

## **ì„±ëŠ¥ê°œì„  ì‹œì‘ê³¼ ë ë¹„êµ!**

| Metric             | Before       | After        | Change      |
|--------------------|--------------|--------------|-------------|
| Total Tests        | 40,228       | 181,050      | **349.29% ğŸŸ¢**  |
| Error Rate         | 51.11%(20,560)| 0.00%(0)     | **No Error ğŸŸ¢** |
| TPS í‰ê·  (Average)  | 109.27       | 312.16       | **185.94% ğŸŸ¢**  |
| TPS p50            | 69.00        | 319.00       | **362.32% ğŸŸ¢**  |
| TPS p95            | 4.00         | 217.45       | **5362.50% ğŸŸ¢** |
| TPS p99            | 2.84         | 132.28       | **4556.34% ğŸŸ¢** |
| TPS p99.9          | 1.63         | 96.52        | **5852.76% ğŸŸ¢** |
| MTTFB í‰ê·  (Average)| 1605.44 ms   | 950.89 ms    | **-40.68% ğŸŸ¢**  |
| MTTFB p50          | 1636.55 ms   | 919.20 ms    | **-43.90% ğŸŸ¢**  |
| MTTFB p95          | 24013.28 ms  | 1322.11 ms   | **-94.47% ğŸŸ¢**  |
| MTTFB p99          | 27690.40 ms  | 1833.22 ms   | **-93.40% ğŸŸ¢**  |
| MTTFB p99.9        | 28157.50 ms  | 2099.12 ms   | **-92.52% ğŸŸ¢**  |
| MTTFB ì°¨ì´ í‰ê·  (Average Difference)| 2838.38 ms | 112.52 ms | **-96.04% ğŸŸ¢**  |
| MTTFB í‰ê· ì ì¸ ë³€ë™ë¥  (Average Variability)| 75.00% | 10.67% | **-85.77% ğŸŸ¢**  |

ì™€ìš°... ì •ë§ ë†€ë¼ìš´ ê²°ê³¼ì…ë‹ˆë‹¤. TPS ëŠ” 3ë°°, MTTFB í‰ê· ì€ 40% ê°€ëŸ‰ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  TPS, MTTFB ì˜ p50, p95, p99, p99.9 ëª¨ë‘ ë§¤ìš° í° í­ìœ¼ë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤!
> TPS p99.9 ëŠ” 5852.76% ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤ã…‹ã…‹;; ë¬´ìŠ¨ì¼ì´ì£ 

ì´ëŠ” ì„œë²„ì˜ ì•ˆì •ì„±ì´ ë§¤ìš° í–¥ìƒë˜ì—ˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì—ëŸ¬ìœ¨ì€ 0.00000% ë¡œ ì—ëŸ¬ê°€ ì „í˜€ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.


## **ê²°ë¡ **

![img](../../../assets/cd/5.png)


## Appendix - MTTFB í‰ê· ê³¼ ë³€ë™ëŸ‰/ë³€ë™ë¥ , p50/p95/p99/p99.9 ì¸¡ì • ì½”ë“œ

```python
import sys
import pandas as pd
import numpy as np
import locale


original_locale = locale.getlocale()
locale.setlocale(locale.LC_ALL, '')

def calculate_error_rate(data):
    total_tests = data['Tests'].sum()
    total_errors = data['Errors'].sum()
    error_rate = (total_errors / (total_tests+total_errors)) * 100
    return error_rate

def format_with_commas(number):
    return locale.format_string("%d", number, grouping=True)

def calculate_weighted_average_tps(data):
    tps = data['TPS']
    average_tps = tps.mean()
    return average_tps

def calculate_percentiles(data, column, percentiles, ascending=True):
    values = data[column]
    if not ascending:
        values = -values  # ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ì„ ìœ„í•´ ê°’ì— ë§ˆì´ë„ˆìŠ¤(-)ë¥¼ ê³±í•©ë‹ˆë‹¤.
    sorted_values = np.sort(values)
    return {f'p{p}': np.percentile(sorted_values, p) for p in percentiles}

def calculate_average_mttfb_difference(data):
    mttfb = data['Mean_time_to_first_byte']
    mttfb_differences = mttfb.diff().abs()[1:]  # ì²« ë²ˆì§¸ ê°’ì€ NaN ì´ë¯€ë¡œ ì œì™¸
    average_difference = mttfb_differences.mean()
    return average_difference

def calculate_total_weighted_mttfb_average(data):
    mttfb = data['Mean_time_to_first_byte']
    tests = data['Tests']
    total_weighted_mttfb = (mttfb * tests).sum()
    total_tests = tests.sum()
    weighted_average = total_weighted_mttfb / total_tests
    return weighted_average

def calculate_mttfb_variation(data):
    mttfb = data['Mean_time_to_first_byte']
    tests = data['Tests']

    mttfb_changes = mttfb.diff()[1:]
    mttfb_abs_percent_changes = (mttfb_changes / mttfb[:-1]).abs() * 100
    average_tests_weights = (tests[:-1] + tests[1:]) / 2
    weighted_avg_abs_changes = mttfb_abs_percent_changes * average_tests_weights[1:]
    average_weighted_avg_abs_change = weighted_avg_abs_changes.sum() / average_tests_weights[1:].sum()

    return average_weighted_avg_abs_change

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python script.py <path_to_csv_file>")
        sys.exit(1)

    csv_file_path = sys.argv[1]
    data = pd.read_csv(csv_file_path)
    total_tests = data['Tests'].sum()
    total_errors = data['Errors'].sum()
    error_rate = calculate_error_rate(data)
    print(f"Total Tests: {format_with_commas(total_tests+total_errors)}")
    print(f"Error Rate: {error_rate:.2f}% ({format_with_commas(total_errors)})")

    average_tps = calculate_weighted_average_tps(data)
    tps_percentiles = calculate_percentiles(data, 'TPS', [50, 95, 99, 99.9], ascending=False)
    print(f"TPS í‰ê· : {average_tps:.2f}")
    print(f"TPS p50: {-tps_percentiles['p50']:.2f}")
    print(f"TPS p95: {(-tps_percentiles['p95']):.2f}")
    print(f"TPS p99: {(-tps_percentiles['p99']):.2f}")
    print(f"TPS p99.9: {(-tps_percentiles['p99.9']):.2f}")

    weighted_average = calculate_total_weighted_mttfb_average(data)
    mttfb_percentiles = calculate_percentiles(data, 'Mean_time_to_first_byte', [50, 95, 99, 99.9])
    print(f"MTTFB í‰ê· : {(weighted_average):.2f} ms")
    print(f"MTTFB p50: {(mttfb_percentiles['p50']):.2f} ms")
    print(f"MTTFB p95: {(mttfb_percentiles['p95']):.2f} ms")
    print(f"MTTFB p99: {(mttfb_percentiles['p99']):.2f} ms")
    print(f"MTTFB p99.9: {(mttfb_percentiles['p99.9']):.2f} ms")

    diff_average = calculate_average_mttfb_difference(data)
    print(f"MTTFB ì°¨ì´ í‰ê·  : {(diff_average):.2f} ms")

    variation = calculate_mttfb_variation(data)
    print(f"MTTFB í‰ê· ì ì¸ ë³€ë™ë¥ : {(variation):.2f}%")

locale.setlocale(locale.LC_ALL, original_locale)
```