---
layout: default
title: 4. í”„ë¡œì íŠ¸ ìˆ˜í–‰ì‹œ ê³ ë ¤ì 2
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 4
---

created at 2022-12-19
{: .label .label-yellow }

## ì¶”ê°€ë‚´ìš©
### ë¬¸ì œì 2. ë©”ëª¨ë¦¬ìƒì—ì„œ ìœ ì €ë°ì´í„°ì˜ ë³µì œ í•´ê²° ë°©ë²•
ì´ì „ í¬ìŠ¤íŒ…[[ì‹¤ì‹œê°„ ì±„íŒ…ë°© êµ¬í˜„(2)]](https://ghkdqhrbals.github.io/posts/chatting(2)/)ì—ì„œ ë¬¸ì œì 2ì¸ **ë©”ëª¨ë¦¬ìƒ ìœ ì €ë°ì´í„° ë³µì œ**ê°€ ì¼ì–´ë‚œë‹¤ê³  ê¸°ìˆ í–ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ sticky sessionê³¼ ê°™ì´ kafka íŒŒí‹°ì…”ë‹ì„ ì§„í–‰í•œë‹¤ê³  í•˜ì˜€ë‹¤. ìƒì„¸ë‚´ìš©ì€ ì•„ë˜ì˜ ì½”ë“œë¥¼ í†µí•´ ë³´ì´ê² ë‹¤.

#### KafkaProducerController
```java
@Slf4j
@RestController
@RequestMapping("/api")
public class KafkaProducerController {
    // kafka producerë¥¼ ìœ„í•œ KafkaTemplateë¥¼ ì§€ì •í•œë‹¤.
    private final KafkaTemplate<String, Object> kafkaProducerTemplate;

    @Value("${kafka.topic-login-request}")
    public String TOPIC_LOGIN_REQUEST;

    @Value("${kafka.topic-login-response}")
    public String TOPIC_LOGIN_RESPONSE;

    ...

    // ì„ì‹œë¡œ PostMappingí•˜ì˜€ë‹¤.
    // ì—­í• 1. userIdì™€ userPwë¥¼ ë‹´ì€ RequestLoginDTOê°€ ë„ì°©í•˜ë©´ ì´ë¥¼ kafkaì˜ íŠ¹ì • íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡
    @PostMapping("login")
    public ResponseEntity<?> produceMessageWithRequestLoginDTO(@RequestBody RequestLoginDTO requestLoginDTO) {

        // ì´ë¶€ë¶„ì´ ì¤‘ìš”í•˜ë‹¤!!!!
        // userIdë¥¼ Kafkaì˜ í† í”½ì— keyë¡œ ë˜ì ¸ì£¼ë©´ì„œ íŠ¹ì • íŒŒí‹°ì…˜ì— ë“¤ì–´ê°€ë„ë¡ ì„¤ì •í•œë‹¤
        // (ë˜ì ¸ì£¼ë©´ partition = HASH(useriD) mod (íŒŒí‹°ì…˜ê°œìˆ˜) ë¡œ ìˆ˜í–‰í• ë“¯)
        ListenableFuture<SendResult<String, Object>> future = kafkaProducerTemplate.send(TOPIC_LOGIN, requestLoginDTO.getUserId(), requestLoginDTO);

        // callback
        future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {
            @Override
            public void onFailure(Throwable ex) {
                log.error("Unable to send message: {}", ex.getMessage());
            }

            @Override
            public void onSuccess(SendResult<String, Object> result) {
                log.info("Sent message with key: {}, offset: {}, partition: {}", requestLoginDTO.getUserId(), result.getRecordMetadata().offset(), result.getRecordMetadata().partition());
            }
        });
        return ResponseEntity.ok(requestLoginDTO);
    }
}
```
#### MessageListener
```java
@Slf4j
@Component
public class MessageListener {

    ...

    // ë¡œê·¸ì¸
    @KafkaListener(topics = "${kafka.topic-login-request}", containerFactory = "loginKafkaListenerContainerFactory")
    public void listenLogin(RequestLoginDTO loginDTO) {
        log.info("Receive [RequestLoginDTO] Message with userID={},userPw={}", loginDTO.getUserId(), loginDTO.getUserPw());

        Optional<User> user = userService.matchUserIdAndUserPw(loginDTO.getUserId(), loginDTO.getUserPw());

        ResponseLoginDTO responseLoginDTO = new ResponseLoginDTO();
        responseLoginDTO.setRequestUserID(loginDTO.getUserId());

        if (user.isPresent()) {
            responseLoginDTO.setIsAccept(true);
            responseLoginDTO.setUser(user.get());
        } else {
            responseLoginDTO.setIsAccept(false);
            responseLoginDTO.setUser(new User());
        }

        // Kafka ë©”ì„¸ì§€ ì „ì†¡/ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ ListenableFuture ì‚¬ìš©
        ListenableFuture<SendResult<String, Object>> future = kafkaProducerTemplate.send(TOPIC_LOGIN_RESPONSE, loginDTO.getUserId(), responseLoginDTO);

        // ë©”ì‹œì§€ ë¹„ë™ê¸° callback ì²˜ë¦¬
        future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {
            @Override
            public void onFailure(Throwable ex) {
                log.error("Fail to send message to broker: {}", ex.getMessage());
            }

            @Override
            public void onSuccess(SendResult<String, Object> result) {
                log.info("Send message with offset: {}, partition: {}", result.getRecordMetadata().offset(), result.getRecordMetadata().partition());
            }
        });
    }
}
```
#### KafkaTopicConfig
```java
// ì—­í• 1. Kafka í† í”½ í• ë‹¹
@Configuration
public class KafkaTopicConfig {
    @Autowired
    private KafkaAdmin kafkaAdmin;

    @Value("${kafka.topic-login-request}")
    public String TOPIC_LOGIN_REQUEST;

    @Value("${kafka.topic-login-response}")
    public String TOPIC_LOGIN_RESPONSE;

    // ê³„ì‚° ì˜ í•´ì•¼í•œë‹¤. Partition ê°œìˆ˜ >= Groupë‚´ Conusmer ê°œìˆ˜.
    // ìƒì„±í•˜ê³ ì í•˜ëŠ” Conumser=2 Partitionì€ 2ì´ê¸°ì—, ê°ê° conusmerì—ê²Œ leader-partition ë§¤ì¹­ê°€ëŠ¥
    private NewTopic generateTopic(String topicName) {
      return TopicBuilder.name(topicName)
        .partitions(2) // íŒŒí‹°ì…˜ í• ë‹¹ ê°œìˆ˜
        .replicas(3) // broker 3ëŒ€ì— í• ë‹¹
        .build(); // ì¦‰, í† í”½ì€ ì´ 2ê°œì˜ leader-partition, 2ê°œì˜ follow-partition ë³´ìœ 
    }

    @PostConstruct
    public void init() {
      kafkaAdmin.createOrModifyTopics(generateTopic(TOPIC_LOGIN_REQUEST));
      kafkaAdmin.createOrModifyTopics(generateTopic(TOPIC_LOGIN_RESPONSE));
    }
}

```
#### KafkaProducerConfig
```java
@Configuration
@EnableKafka
public class KafkaProducerConfig {

    @Value("${kafka.bootstrap-servers}")
    private String bootstrapServer;

    private ProducerFactory<String, Object> producerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        // Kafka Broker ì—”ë“œ í¬ì¸íŠ¸ í• ë‹¹(8097, 8098, 8099)
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServer);
        // Kafkaì— ì „ì†¡ë  í‚¤ëŠ” ìŠ¤íŠ¸ë§ìœ¼ë¡œ ì„¤ì •
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        // Kafkaì— ì „ì†¡ë  ê°’ì„ ì§ë ¬í™” í•˜ëŠ” ë°©ë²•ì„ ì§€ì •
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);

        return new DefaultKafkaProducerFactory<>(configProps);
    }

    @Bean
    public KafkaTemplate<String, Object> kafkaProducerTemplate() {
        return new KafkaTemplate<>(producerFactory());
    }

}
```
#### KafkaConsumerConfig
```java
// ì—­í• 1. Kafkaì—°ê²°
// ì—­í• 2. ë©”ì„¸ì§€ë¥¼ ë°›ì•„ì„œ ìš°ë¦¬ê°€ ì›í•˜ëŠ” íƒ€ì…ì¸ RequestLoginDTOë¡œ ë³€í™˜
@Slf4j
@EnableKafka
@Configuration
public class KafkaConsumerConfig {

    @Value("${kafka.bootstrap-servers}")
    private String bootstrapServer;

    ...

    // login consumer ê°ì²´ ë³€í™˜
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, RequestLoginDTO> loginKafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, RequestLoginDTO> factory = new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(loginConsumerFactory("chatServerGroup"));
        return factory;
    }

    // login consumer ê°ì²´ ë³€í™˜
    public ConsumerFactory<String, RequestLoginDTO> loginConsumerFactory(String groupId) {

        // ì•ì„œ producerì´ jsonì§ë ¬í™”ë¡œ ë³´ëƒˆìœ¼ë‹ˆ, ë§ˆì°¬ê°€ì§€ë¡œ jsonDeserialize
        JsonDeserializer<RequestLoginDTO> deserializer = new JsonDeserializer<>(RequestLoginDTO.class);
        deserializer.setRemoveTypeHeaders(false);
        // ëª¨ë“  íŒ¨í‚¤ì§€ ì‹ ë¢°
        deserializer.addTrustedPackages("*");
        deserializer.setUseTypeMapperForKey(true);

        // ê°ì²´ë³€í™˜ ì„¤ì •
        ImmutableMap<String, Object> config = ImmutableMap.<String, Object>builder()
                .put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServer)
                .put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class)
                .put(ConsumerConfig.GROUP_ID_CONFIG, groupId)
                // ì—­ì§ë ¬í™” ë¡œì§
                .put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, deserializer)
                .build();

        return new DefaultKafkaConsumerFactory<>(config, new StringDeserializer(), deserializer);
    }
}
```
ìœ ì €ì˜ IDëŠ” ëª¨ë“  ì„œë¹„ìŠ¤ì— í•„ìš”í•œ ì¤‘ìš”í•œ keyì´ë©° ìœ ë‹ˆí¬í•˜ë‹¤. `kafkaProducerTemplate.send(.., key=userId, ..)`ë¡œ frontì—ì„œ kafkaì˜ íŠ¹ì • íŒŒí‹°ì…˜ìœ¼ë¡œ ë“¤ì–´ê°€ë„ë¡ í•˜ê³ , í•´ë‹¹ íŒŒí‹°ì…˜ì€ backend ì„œë²„ ì¤‘ í•˜ë‚˜ê°€ ê³„ì†(ë§Œì•½ ê³„ì† ì‚´ì•„ìˆë‹¤ë©´) ì½ê²Œëœë‹¤ë©´ ë©”ëª¨ë¦¬ì˜ ì¤‘ë³µì‚¬ìš©ì´ í•´ê²°ëœë‹¤.

### Kafka Test
ì°¸ê³ ë¡œ Kafkaë¸Œë¡œì»¤ëŠ” 3ëŒ€(port:29092, 39092, 49092)ë¥¼ ì„¤ì •í•˜ì˜€ê³  ì•„ë˜ì˜ docker composeë¥¼ í†µí•´ ì‹¤í–‰í•˜ì˜€ë‹¤.
```dockerfile
version: '3'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.2.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181

  kafka1:
    image: confluentinc/cp-kafka:7.2.1
    container_name: kafka1
    ports:
      - "8097:8097"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:8097,INTERNAL://kafka1:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

  kafka2:
    image: confluentinc/cp-kafka:7.2.1
    container_name: kafka2
    ports:
      - "8098:8098"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:8098,INTERNAL://kafka2:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL

  kafka3:
    image: confluentinc/cp-kafka:7.2.1
    container_name: kafka3
    ports:
      - "8099:8099"
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: EXTERNAL:PLAINTEXT,INTERNAL:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL://localhost:8099,INTERNAL://kafka3:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
```
ìœ„ì˜ docker composeë¥¼ ì‹¤í–‰í•˜ê²Œ ë˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì»¨í…Œì´ë„ˆ ìƒì„±ëœë‹¤.
```bash
gyuminhwangbo@Gyuminui-MacBookPro ghkdqhrbals.github.io % docker ps
CONTAINER ID   IMAGE                             COMMAND                  CREATED          STATUS          PORTS                              NAMES
9e0fd3e5a419   confluentinc/cp-kafka:7.2.1       "/etc/confluent/dockâ€¦"   10 minutes ago   Up 10 minutes   0.0.0.0:8098->8098/tcp, 9092/tcp   kafka2
b24b4c68887b   confluentinc/cp-kafka:7.2.1       "/etc/confluent/dockâ€¦"   10 minutes ago   Up 10 minutes   0.0.0.0:8099->8099/tcp, 9092/tcp   kafka3
7dfabb292ff4   confluentinc/cp-kafka:7.2.1       "/etc/confluent/dockâ€¦"   10 minutes ago   Up 10 minutes   0.0.0.0:8097->8097/tcp, 9092/tcp   kafka1
02adb2b2386d   confluentinc/cp-zookeeper:7.2.1   "/etc/confluent/dockâ€¦"   10 minutes ago   Up 10 minutes   2181/tcp, 2888/tcp, 3888/tcp       zookeeper
```

ì´í›„, ì•„ë˜ì™€ ê°™ì´ backendì—ì„œ login-responseë¡œ ì „ë‹¬í–ˆë˜ ë©”ì„¸ì§€ë¥¼ í™•ì¸í•´ë³¼ ìˆ˜ ìˆë‹¤.
POST /login -> producer -> kafka -> **consumer** ì´ ë¶€ë¶„
```bash
# kafka3 ë¸Œë¡œì»¤ ì ‘ì†
gyuminhwangbo@Gyuminui-MacBookPro ghkdqhrbals.github.io % docker exec -it kafka3 /bin/bash

# login-responseì— ìŒ“ì¸ ë©”ì„¸ì§€ í™•ì¸
[appuser@b24b4c68887b ~]$ kafka-console-consumer --bootstrap-server localhost:9092 --topic login-response --from-beginning
# login fail
{"requestUserID":"aa","isAccept":false,"user":{"userId":null,"userPw":null,"email":null,"userName":null,"userStatus":null,"joinDate":null,"loginDate":null,"logoutDate":null}}
# login success
{"requestUserID":"a","isAccept":true,"user":{"userId":"a","userPw":"1234","email":"a@naver.com","userName":"user_A","userStatus":"ì•ˆë…•í•˜ì„¸ìš”!","joinDate":[2022,12,17],"loginDate":[2022,12,17],"logoutDate":[2022,12,17]}}
```

### ì¶”ê°€ì ì¸ í…ŒìŠ¤íŠ¸
ì§ì ‘ í† í”½ ìƒì„±ë¶€í„° pub/sub í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì§„í–‰í•´ë³´ì•˜ë‹¤.
```bash
# kafka2 ë¸Œë¡œì»¤ ì ‘ì†
gyuminhwangbo@Gyuminui-MacBookPro ghkdqhrbals.github.io % docker exec -it kafka2 /bin/bash

# ì§ì ‘ í† í”½ìƒì„±
[appuser@9e0fd3e5a419 ~]$ kafka-topics --bootstrap-server localhost:9092 --create --topic randomTopic2 --partitions 3 --replication-factor 3
Created topic randomTopic2.

# ìƒì„±ëœ í† í”½í™•ì¸
[appuser@9e0fd3e5a419 ~]$ kafka-topics --describe --topic randomTopic2 --bootstrap-server kafka1:9092
Topic: randomTopic2	TopicId: BL7DT0u4SuO_flLPKHbutg	PartitionCount: 3	ReplicationFactor: 3	Configs:
	Topic: randomTopic2	Partition: 0	Leader: 3	Replicas: 3,2,1	Isr: 3,1,2
	Topic: randomTopic2	Partition: 1	Leader: 1	Replicas: 1,3,2	Isr: 3,2,1
	Topic: randomTopic2	Partition: 2	Leader: 2	Replicas: 2,1,3	Isr: 3,1,2

# ì§ì ‘ producing
[appuser@9e0fd3e5a419 ~]$ kafka-console-producer --bootstrap-server localhost:9092 --topic randomTopic
>Hi
>AA

# ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ kafka3 ë¸Œë¡œì»¤ ì ‘ì†
gyuminhwangbo@Gyuminui-MacBookPro ghkdqhrbals.github.io % docker exec -it kafka3 /bin/bash

# ì§ì ‘ consuming
[appuser@b24b4c68887b ~]$ kafka-console-consumer --bootstrap-server localhost:9092 --topic randomTopic --from-beginning
Hi # ì´ì™€ê°™ì´ ë°›ì•„ë³¼ ìˆ˜ ìˆë‹¤.
AA
```


