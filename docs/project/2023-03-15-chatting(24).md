---
layout: default
title: 24. íŠ¸ëœì ì…˜ê³¼ ë©€í‹°ìŠ¤ë ˆë“œì˜ ì˜ëª»ëœ ë§¤ì¹­ ìˆ˜ì •
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
date: 2023-03-15
nav_order: 24
---
created at 2023-03-15
{: .label .label-yellow }

{: .important }
> HikariCPë¥¼ ì‚¬ìš©í•˜ë˜ ì¤‘, ìƒˆë¡œìš´ ìŠ¤ë ˆë“œì—ì„œ `hikariDataSource.getConnection()` ì„ ìˆ˜í–‰í–ˆì§€ë§Œ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ì‚¬ìš©í•˜ë˜ Connection ì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. 3ì¼ê°„ í•´ê²°ì´ ì•ˆë˜ì„œ stack-overflow ì— ì§ˆë¬¸ì„ ì˜¬ë ¸ìŠµë‹ˆë‹¤ã…œã…œ. í˜¹ì‹œ ì™œ ì´ëŸ° í˜„ìƒì´ ë°œìƒí•˜ëŠ”ì§€ ì•„ì‹ ë‹¤ë©´ ì•„ë˜ì˜ ë§í¬ì— ë‹µë³€ì„ ë‚¨ê²¨ì£¼ì‹œë©´ ì •ë§ì •ë§ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤!  
>
> Stack-overflow : [Does HikariCP.getConnection() return the same Connection when run getConnection in different thread?](https://stackoverflow.com/questions/75781250/does-hikaricp-getconnection-return-the-same-connection-when-run-getconnection)

# íŠ¸ëœì ì…˜ê³¼ ë©€í‹°ìŠ¤ë ˆë“œì˜ ì˜ëª»ëœ ë§¤ì¹­ ìˆ˜ì • version.1

ì €ëŠ” ì„œë¹„ìŠ¤ì™€ ë°ì´í„°ë² ì´ìŠ¤ ë³„ ë”°ë¡œ ìŠ¤ë ˆë“œ í’€ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ê·¸ ì´ìœ ëŠ”, ë‹¨ìˆœíˆ 1. DBì˜ connection ì„ ê°€ì ¸ì™€ì„œ, 2. DB ì¿¼ë¦¬ ë§Œì„ ê´€ë¦¬í•˜ëŠ” ìŠ¤ë ˆë“œ í’€ì´ ìˆì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤ ë¼ëŠ” ìƒê°ì„ ê°€ì¡Œì—ˆê¸° ë–„ë¬¸ì´ì—ìš”.

í•˜ì§€ë§Œ, ì €ëŠ” Transactionì€ Connectionì— ì¢…ì†ë˜ì–´ ìˆìœ¼ë©°, Connectionì€ ThreadLocalì´ë‹¤! ë¼ëŠ” ê²ƒì„ ê°„ê³¼í•˜ê³  ìˆì—ˆì–´ìš”.

> * DB-Connection ì€ `ThreadLocal` ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
> * Transaction ì€ ë‹¨ì¼ DB-Connection ì—ì„œ ìœ íš¨í•©ë‹ˆë‹¤.
> * ì¦‰, Transaction ì€ ë‹¨ì¼ Thread ë‚´ì—ì„œë§Œ ìœ íš¨í•©ë‹ˆë‹¤!

ê·¸ë˜ì„œ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë¡œ í•˜ë‚˜ì˜ Connection ì„ HikariCP ì—ì„œ ê°€ì ¸ì™€ Transaction ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.

![img](../../../assets/img/performance/13.svg)

1. ì¼ë‹¨ ì§ì ‘ íŠ¸ëœì ì…˜ì„ ì»¨íŠ¸ë¡¤í•˜ê¸° ìœ„í•´ì„œ @Trnasactional ì–´ë…¸í…Œì´ì…˜ì„ Service ë©”ì†Œë“œì—ì„œ ëºìŠµë‹ˆë‹¤. 
2. ì´í›„, ë¦¬í¬ì§€í† ë¦¬ private ë©”ì†Œë“œë“¤ì„ ì‹œí€€ì…œí•˜ê²Œ ìˆ˜í–‰ë˜ë„ë¡ ê´€ë¦¬í•˜ëŠ” `login()` ë©”ì†Œë“œë¥¼ ë§Œë“¤ì—ˆì–´ìš”.
3. ë˜í•œ ì„œë¹„ìŠ¤ì—ì„œ ë¦¬í¬ì§€í† ë¦¬ì˜ `login()`ì„ í˜¸ì¶œí•  ë•Œ, `.get()`ìœ¼ë¡œ blocking í•˜ì˜€ìŠµë‹ˆë‹¤(ì´ìœ ëŠ”, ).
4. `matchIdAndPw`, `updateLoginDate`, `addEvent` ë‚´ë¶€ì—ì„œ HikariCPë¡œë¶€í„° Connection ì„ ë¹Œë ¤ì˜¤ë©´, ê°™ì€ `db-thread-1` ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ê¸°ë•Œë¬¸ì— ë™ì¼í•œ Connection ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê°ê°ì˜ ë©”ì†Œë“œì—ì„œ ì»¤ë„¥ì…˜ì„ ì“°ê³  prepareStatementì™€ ResultSetë§Œ ë‹«ì•„ì£¼ë©´ ë˜ìš”.
5. ì—¬ëŸ¬ ë©”ì†Œë“œì—ì„œ Exception ë°œìƒ ì‹œ, `login()`ì—ì„œ try/catch í•´ì„œ ë§ˆì°¬ê°€ì§€ë¡œ `hikariDataSource.getConnection()` ìˆ˜í–‰í•´ì„œ ë™ì¼ ì»¤ë„¥ì…˜ ì–»ì–´ì˜¤ê³ , `conn.rollback()` ì„ ìˆ˜í–‰í•˜ë„ë¡ í•©ë‹ˆë‹¤.
6. ë§ˆì§€ë§‰ìœ¼ë¡œ ë‹¤ ì“´ ì»¤ë„¥ì…˜ì€ finally ë¬¸ì— HikariCPì— ë‹¤ì‹œ ë°˜í™˜í•©ë‹ˆë‹¤. 

{: .note }
> ì ì  ì–´ë…¸í…Œì´ì…˜ì„ ì•ˆì“°ëŠ” ê²ƒ ê°™ì•„ì„œ ë§ˆìŒì´ ì°¹ì°¹í•˜ì§€ë§Œ, ì‹¤ì œ Human Readable í•˜ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•˜ë‹¤ë³´ë‹ˆ ì–´ì©” ìˆ˜ ì—†ëŠ” ë¶€ë¶„ì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤. 

> ì¼ë‹¨ ê°œë°œì‹œê°„ë„ ë§¤ìš° ì˜¤ë˜ ê±¸ë¦¬ê¸´ í•˜ì§€ë§Œ, **try/catchë¬¸ì´ ì§„ì§œ ë„ˆë¬´ë„ˆë¬´ ë§ì•˜ì–´ìš” :(** ë§¤ ë©”ì†Œë“œë§ˆë‹¤ Try/Catch ê°€ ë“¤ì–´ê°€ì•¼í•˜ë”ë¼êµ¬ìš”. 
> ë„ˆë¬´ ì§€ê¸‹ì§€ê¸‹í•´ì„œ í•œêµ°ë°ì„œë§Œ try/catch í•˜ë„ë¡ ë°”ê¾¸ëŠ” ê²ƒì„ ì‹œë„ì¤‘ì…ë‹ˆë‹¤!

# íŠ¸ëœì ì…˜ê³¼ ë©€í‹°ìŠ¤ë ˆë“œì˜ ì˜ëª»ëœ ë§¤ì¹­ ìˆ˜ì • version.2

ìœ„ì™€ ê°™ì´ ìŠ¤ë ˆë“œ, Connection, ë“±ë“±ì„ ì§ì ‘ ì»¨íŠ¸ë¡¤ í–ˆì—ˆëŠ”ë°, ëª¨ë“  ë©”ì†Œë“œë¥¼ ì „ë¶€ ì´ëŸ°ì‹ìœ¼ë¡œ ê³ ì¹˜ë ¤ë‹ˆ ì‹œê°„ì´ ë§ì´ ì†Œìš”ë ê²ƒ ê°™ì•˜ìŠµë‹ˆë‹¤. íš¨ìœ¨ì ì´ì§€ë„ ì•Šêµ¬ìš”.

ì‚¬ì‹¤ ì§ì ‘ ì»¨íŠ¸ë¡¤ í–ˆë˜ ì´ìœ ëŠ”, **ì„¸ë¶€ ë™ì‘ê³¼ì •ë“¤ì„ ìƒì„¸íˆ ì´í•´í•˜ê³  ì‹¶ì—ˆê¸° ë•Œë¬¸**ì´ì—ìš”.
ì§€ê¸ˆì€ ëŒ€ë¶€ë¶„ ì²´ê°í–ˆê¸°ì—, **ì •ë§ ê³ ë§ˆìš´ ì–´ë…¸í…Œì´ì…˜ë“¤(@Transactional, @Async) + DeferredResultì„ ì‚¬ìš©**í•˜ê¸°ë¡œ í•˜ì˜€ìŠµë‹ˆë‹¤! ê·¸ ê²°ê³¼ ë§¤ìš° ì½”ë“œê°€ ê°„ê²°í•´ ì§ê³¼ ë™ì‹œì— ê°œë°œì†ë„ë˜í•œ ë¹¨ë¼ì¡ŒìŠµë‹ˆë‹¤.

**ê²°ë¡ ì€ ì•„ë˜ì™€ ê°™ì´ ê¸°ì¡´ ë¡œì§ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.**

* ì„œë¹„ìŠ¤ ìŠ¤ë ˆë“œ í’€ë§Œ ì„¤ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.(ê¸°ì¡´ì—ëŠ” DBí’€,ì„œë¹„ìŠ¤í’€ ë”°ë¡œì˜€ì–´ìš”. **DB ì¿¼ë¦¬ ìŠ¤ë ˆë“œëŠ” íŠ¸ë Œì ì…˜ ë¡œì»¬ì„ ì§€í‚¤ê¸° ìœ„í•´ì„œ ì„œë¹„ìŠ¤ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤**.)
* CompletableFutureì€ @Asyncì™€ DeferredResultë¡œ ìŠ¤ë ˆë“œ ìƒì„±ê³¼ ë°˜í™˜ì„ non-blockingìœ¼ë¡œ ë³€ê²½í•˜ì˜€ìŠµë‹ˆë‹¤.
* @Transactional ì„ í†µí•´ ê·€ì°®ì€ Conn,pstmt,resultSet ë°˜í™˜ë¬¸ì„ ì œê±°í•  ìˆ˜ ìˆì—ˆì–´ìš”.
* íŠ¸ëœì ì…˜(~DB connection) ì„ í”„ë¡ì‹œ ê°ì²´ë¡œ ê´€ë¦¬í•´ì£¼ëŠ” **TransactionAspectSupport** ë¥¼ í†µí•´ ë¡¤ë°±ìœ„ì¹˜ë¥¼ ì§ì ‘ ì„¤ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

![img](../../../assets/img/msa/6.svg)

ìœ„ì˜ ê·¸ë¦¼ê³¼ ê°™ì´ ìˆ˜ì •í•œ í›„, HTTP Benchmark Testë¡œ HikariCP Statusë¥¼ Spring-AOPë¥¼ í†µí•´ ì•„ë˜ì™€ ê°™ì´ ì²´í¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ëª‡ ê°œì˜ Connectionì„ HikariCPì— ë¯¸ë¦¬ í• ë‹¹í•  ì§€ ì•Œ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ì£ .

# ì ì • HikariCP ì²´í¬ë¥¼ ìœ„í•œ Spring AOP + Hikari Status Check

#### Code

```java
@Aspect
@Component
@Slf4j
public class DataSourceAspectLogger {
    private HikariPool pool;
    @Autowired
    private HikariDataSource ds;
    
    // AOP
    @Before("execution(* chatting.chat.domain.user.repository.UserRepositoryJDBC.saveAll(..))")
    public void logBeforeConnection(JoinPoint jp) throws Throwable {
        logDataSourceInfos("Before ", jp);
    }

   // AOP
    @After("execution(* chatting.chat.domain.user.repository.UserRepositoryJDBC.saveAll(..))")
    public void logAfterConnection(JoinPoint jp) throws Throwable {
        logDataSourceInfos("After ", jp);
    }

    // Hikari Connection Pool ë°›ì•„ì˜¤ê¸°
    @Autowired
    public void getPool() {
        try {
            java.lang.reflect.Field field = ds.getClass().getDeclaredField("pool");
            field.setAccessible(true);
            this.pool = (HikariPool) field.get(ds);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

    // HikariCP Status ì²´í¬
    public void logDataSourceInfos(final String time, final JoinPoint jp) {
        final String method = String.format("%s", jp.getSignature().getName());
        int totalConnections = pool.getTotalConnections(); // ì‚¬ì „ì— ë¯¸ë¦¬ ë•¡ê²¨ì˜¤ëŠ” DB Connection ê°œìˆ˜
        int activeConnections = pool.getActiveConnections(); // ë¹Œë ¤ì¤€ Connection ê°œìˆ˜
        int freeConnections = totalConnections - activeConnections; // Idle Conenction ê°œìˆ˜, getIdle ë¡œë„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì–´ìš”.
        int connectionWaiting = pool.getThreadsAwaitingConnection(); // Wait Connection ê°œìˆ˜
        log.info(String.format("%s %s: [Total: %d, Active: %d, Idle: %d, Wait: %d]", time, method, ds.getMaximumPoolSize(),activeConnections,freeConnections,connectionWaiting));
    }
}
```

#### 1000ê°œ request ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹œ, ìµœëŒ€ HikariCP Status Result

```
[service-thread-14] c.c.web.logger.DataSourceAspectLogger    : After  saveAll: [Total: 10, Active: 10, Idle: 0, Wait: 101]
```

ìœ„ì˜ ê²°ê³¼ë¡œ ë¯¸ë£¨ì–´ë³´ì•„, í˜„ì¬ ì„œë²„ëŠ” 1000ê°œì˜ ë™ì‹œ request ê°€ ë“¤ì–´ì™”ì„ ë•Œ, `Active`+`Wait`=**111 ê°œì˜ DB connection ì´ í•„ìš”í•¨**ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ì œ RDSëŠ” `max_connection`ì´ 83ê°œë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ë°ìš”. í…ŒìŠ¤íŠ¸ìš© psql í„°ë¯¸ë„ 2ê°œ + tableplus í„°ë¯¸ë„ 1ê°œ + rds proxy 2ê°œ = 5ê°œë¥¼ defaultë¡œ ì‚¬ìš©í•˜ê¸° ë–„ë¬¸ì— ìµœëŒ€ 78ê°œê¹Œì§€ ì•„ìŠ¬ì•„ìŠ¬í•˜ê²Œ ì„¤ì •ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ ë˜ë©´ ìµœëŒ€í•œ waitë¥¼ ì¤„ì¼ ìˆ˜ ìˆê² ì£ ? ì¶”ê°€ì ìœ¼ë¡œ ì €ëŠ” `jdbcTemplate.batchUpdate` ë¡œ ì¼ì • time ë™ì•ˆ Insert ì¿¼ë¦¬ë“¤ì„ ëª¨ì•„ì„œ ì „ì†¡í•˜ëŠ”ë°ìš”. ì´ë ‡ê²Œ ë˜ë©´, connection ì„ ëœ ì¡ì•„ë¨¹ëŠ” ë‹¤ëŠ” ì¥ì ì´ ìˆì–´ì„œ connection wait time ì¤„ì´ê¸°ì— ë„ì›€ì´ ëœ ê²ƒê°™ì•„ìš”.

### (Appendix) JDBC SQLException Code(Postgresql)

* 23505 : unique_violation

[https://www.postgresql.org/docs/8.3/errcodes-appendix.html](https://www.postgresql.org/docs/8.3/errcodes-appendix.html)

### (Appendix) ì„œë¹„ìŠ¤,ë¦¬í¬ì§€í† ë¦¬ ë…¸ ì–´ë…¸í…Œì´ì…˜
#### UserController
```java
    // ìœ ì € ì €ì¥
    @PostMapping("/user")
    public DeferredResult<ResponseEntity<?>> addUser(@RequestBody RequestAddUserVO req) throws InterruptedException {

        // DeferredResultëŠ” Spring 3.2ë¶€í„° ì§€ì›í•˜ëŠ” ì´ë²¤íŠ¸ driven ë¹„ë™ê¸° ì§€ì› Callback ë©”ì†Œë“œ
        // DeferredResultë¥¼ ë¦¬í„´ íƒ€ì…ìœ¼ë¡œ ì„¤ì •í•˜ë©´,
        // ì´ë²¤íŠ¸ê°€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¡œë¶€í„° ë“¤ì–´ì˜¤ë©´ í´ë¼ì´ì–¸íŠ¸ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” í˜„ì¬ nio í†°ì¼“ ìŠ¤ë ˆë“œì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ê²°ê³¼ë¬¼ ë°˜í™˜
        // ì¦‰, Golangì˜ ì±„ë„ê°™ì€ ì¡´ì¬ì„(ì¡°ê¸ˆ ë‹¤ë¥´ê¸´ í•˜ì§€ë§Œ)
        DeferredResult<ResponseEntity<?>> dr = new DeferredResult<>();

        // ìœ ì € ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ìœ ì € ì €ì¥
        CompletableFuture.runAsync(()->{
        }).thenCompose(s->{
            return userService.save(req);
        }).thenAcceptAsync( s1->{
            sendToKafkaWithKey(TOPIC_USER_CHANGE, new RequestUserChange(req.getUserId(), req.getUserName(),"","INSERT"), req.getUserId());
            dr.setResult(ResponseEntity.ok("success"));
        }).exceptionally(e->{
            if (e.getCause() instanceof CustomException){
                dr.setResult(ErrorResponse.toResponseEntity(((CustomException) e.getCause()).getErrorCode()));
            }else{
                dr.setResult(ResponseEntity.badRequest().body("default bad request response"));
            }
            return null;
        });

        // deferredResult ëŠ” defaultë¡œ ë˜ì—ˆë‹¤ê°€ ì´ë²¤íŠ¸ê°€ ë“¤ì–´ì˜¤ë©´ í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ ë¹„ë¡œì†Œ ìˆ˜í–‰
        return dr;
    }
```