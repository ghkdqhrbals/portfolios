---
layout: default
title: 13. ëŒ€ëŸ‰ Rest api test ì‹œ ì†ë„ë¬¸ì œ í•´ê²°ê³¼ì •-1
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
nav_order: 13
---

created at 2023-01-16
{: .label .label-yellow }


ì´ì „ í¬ìŠ¤íŒ…ì—ì„œ 10000ê°œì˜ rest apië¥¼ ì§ì ‘ testí•´ë³´ì•˜ë‹¤. ë¡œì§ì—ëŠ” ë¬¸ì œê°€ ì—†ì§€ë§Œ ì„±ëŠ¥ì´ìŠˆê°€ ë„ˆë¬´ ë‚˜ë²„ë ¸ë‹¤.
**10000ê°œ í…ŒìŠ¤íŠ¸ í•˜ëŠ”ë° 110ì´ˆ**ê°€ ê±¸ë¦°ê²ƒì´ë‹¤. ì˜ì‹¬ê°€ëŠ” ë¶€ë¶„ì´ í•œë‘êµ°ë°ê°€ ì•„ë‹ˆë‹¤. ì˜¤ëŠ˜ì˜ í¬ìŠ¤íŒ…ì€ ì˜ì‹¬ê°€ëŠ” ë¶€ë¶„ì„ í•œë²ˆ ì°¾ì•„ë³´ê³  ì •ë¦¬í•˜ë ¤í•œë‹¤. ë³¸ ê³¼ì •ì˜ ê²°ê³¼ë¡œ **10Kê°œì˜ request test ì‹œ, 10Kê°œì˜ responseê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„: 110ì´ˆ -> 49ì´ˆ**ë¡œ ì„±ëŠ¥ê°œì„  ë° ì´ìœ ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

# INDEX(ì˜ì‹¬ê°€ëŠ” ë¶€ë¶„)
1. Golang Codeì˜ http request ì†ë„
2. Auth Server -> **Kafka** -> Chat Server -> Chat DB ê³¼ì •
3. Chat DB(tx log) -> Debezium -> Kafka -> JDBC-Sink-Connector -> Backup DB ê³¼ì •
4. ì•½ 10ê°œì˜ í† í”½ê³¼ ê°ê°ì˜ í† í”½ì´ 1~25ê°œì˜ íŒŒí‹°ì…˜ì„ ë³´ìœ í•¨ì— ë”°ë¼ 3ëŒ€ì˜ Kafka brokerë¼ë¦¬ ê³¼í•œ replication ìƒì„±
5. **ë„ì»¤ ë¦¬ì†ŒìŠ¤ ë° nginx í”„ë¡œì„¸ì„œ ì œí•œ**   
   5-1. ì‹¤í—˜í™˜ê²½    
   5-2. CPU ì‚¬ìš©ë¥  í™•ì¸   
   5-3. ê°œì„ ê²°ê³¼(110ì´ˆ -> 86ì´ˆ)   
6. **ë‹¨ì¼ Auth ì„œë²„ë¡œ ì¸í•œ ë³‘ëª©í˜„ìƒ**   
   6-1. auth-server ìˆ˜í‰ í™•ì¥   
   6-2. nginx loadbalancing   
   6-3. ê°œì„ ê²°ê³¼-1(86ì´ˆ -> 83ì´ˆ)   
   6-4. ê°œì„ ê²°ê³¼-2(83ì´ˆ -> 49ì´ˆ)   
 

## 1. ~~Golang Codeì˜ http requestì‹œ ì†ë„~~
ì „ì†¡ì†ë„ëŠ” ë§¤ìš° ë¹ ë¥´ë‹¤. ì‚¬ì‹¤ ì²˜ë¦¬í•  ë¡œì§ì´ ë³„ë¡œ í•„ìš”ì—†ê¸°ë•Œë¬¸ì— ë¹ ë¥¸ê²ƒì€ ì˜ˆìƒëœ ê²°ê³¼ì´ë‹¤. ë¬¸ì œëŠ” **responseê°€ ì˜¤ëŠ” ì‹œì ì´ ëŠë¦¬ë‹¤**ëŠ” ê²ƒ!

## 2. Auth Server -> **Kafka** -> Chat Server -> Chat DB ê³¼ì •
> ![img](../../../assets/img/kafka/lags.png)
> ìœ„ì˜ ìº¡ì²˜ì—ì„œ ë³´ëŠ”ë°”ì™€ ê°™ì´, **ì§€ì—°ë˜ëŠ” ë°ì´í„°ê°€ ê±°ì˜ 7600ê°œì˜ ë©”ì„¸ì§€ ì¤‘ 1000ê°œ** ì •ë„ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì¦‰, ì—¬ê¸°ì„œ ì–´ëŠì •ë„ì˜ ì§€ì—°ì´ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì–˜ëŠ” ì¼ë‹¨ íŒŒí‹°ì…˜ì„ 2ê°œë§Œ ì‚¬ìš©í•˜ëŠ”ë°, íŒŒí‹°ì…˜ì„ ëŠ˜ë ¤ ë¶„ì‚°ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ì„ê²ƒ ê°™ë‹¤!
>
> í•˜ì§€ë§Œ ì´ ë¶€ë¶„ì€ Auth Server í…ŒìŠ¤íŠ¸ì— í¬ê²Œ ì˜í–¥ì´ ì—†ë‹¤. ì˜¤íˆë ¤ Chat Serverì˜ ì„±ëŠ¥í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì¤€ë‹¤.

## 3. Chat DB(tx log) -> Debezium -> Kafka -> JDBC-Sink-Connector -> Backup DB ê³¼ì •
ì´ ë¶€ë¶„ì€ ë§ˆì°¬ê°€ì§€ë¡œ Chat Server í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•´ì•¼í•  ë¶€ë¶„ì´ë‹¤.

## 4. ì•½ 10ê°œì˜ í† í”½ê³¼ ê°ê°ì˜ í† í”½ì´ 1~25ê°œì˜ íŒŒí‹°ì…˜ì„ ë³´ìœ í•¨ì— ë”°ë¼ 3ëŒ€ì˜ Kafka brokerë¼ë¦¬ ê³¼í•œ replication ìƒì„±
ì´ ë¶€ë¶„ì€ ë§ˆì°¬ê°€ì§€ë¡œ (1)Chat Server í…ŒìŠ¤íŠ¸ + (2)ì „ì²´ ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ ì†Œëª¨ëŸ‰ ê´€ì°° ì‹œ ê³ ë ¤í•´ì•¼í•  ë¶€ë¶„ì´ë‹¤.
ì•„ë¬´ë˜ë„ 3ë²ˆì˜ ì˜ì‹¬ë¶€ë¶„ì²˜ëŸ¼ ì§ì ‘ ìº¡ì²˜í•˜ë©´ì„œ í™•ì¸í•˜ê¸°ëŠ” í˜ë“¤ê²ƒ ê°™ë‹¤(í† í”½ì´ ì—¬ëŸ¬ê°œë¼ì„œã…œã…œ). ê·¸ë˜ì„œ Kafkaì˜ lag ë°ì´í„°ë¥¼ ë”°ë¡œ í†µê³„ë‚´ëŠ” Grafanaë¥¼ ì‚¬ìš©í•˜ì—¬ í•œëˆˆì— ë´ì•¼ê² ë‹¤.
![img](../../../assets/img/kafka/lag.png)

## 5. **ë„ì»¤ ë¦¬ì†ŒìŠ¤ ë° nginx í”„ë¡œì„¸ì„œ ì œí•œ**
### 5-1. ì‹¤í—˜í™˜ê²½

| MacBook Pro (13-inch, 2020, Four Thunderbolt 3 ports) |
|:-----------------------------------------------------|
| Processor : 2 GHz ì¿¼ë“œ ì½”ì–´ Intel Core i5                |
| Memory : 32GB 3733 MHz LPDDR4X                       |

### 5-2. CPU ì‚¬ìš©ë¥  í™•ì¸
![img](../../../assets/img/kafka/lag2.png)
í•„ìì˜ ë§¥ë¶ì´ ë…¼ë¦¬ cpu ì½”ì–´ê°€ 8ê°œ ë¬¼ë¦¬ ì½”ì–´ê°€ 4ê°œì¸ ê²ƒì„ ê°ì•ˆí•œë‹¤ë©´ ì•½ 50%ì˜ ìì›ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```
gyuminhwangbo@Gyuminui-MacBookPro spring-chatting-server % sysctl -a | grep cpu
...
hw.activecpu: 8
hw.perflevel0.physicalcpu: 4
hw.perflevel0.physicalcpu_max: 4
hw.perflevel0.logicalcpu: 8
...
```

ê·¸ë¦¬ê³  í˜„ì¬ ë„ì»¤ëŠ” 4ê°œì˜ CPU ë…¼ë¦¬ì½”ì–´ë§Œ í™œìš©ê°€ëŠ¥í•˜ë„ë¡ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •ë˜ì–´ìˆë‹¤.
![img](../../../assets/img/kafka/lag3.png)

**ì¦‰, Dockerì— í• ë‹¹ê°€ëŠ¥í•œ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ í’€ë¡œ ë‹¤ ì“°ê³ ìˆë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤!!** ë”°ë¼ì„œ **ëŒ€ëŸ‰ http request í…ŒìŠ¤íŠ¸ì˜ ì§€ì—° ë¬¸ì œì ì€ Docker í• ë‹¹ ë¦¬ì†ŒìŠ¤ ë¶€ì¡±** ì´ë¼ëŠ” 1ì°¨ ê²°ë¡ ì„ ë‚´ë¦´ê²ƒì´ë‹¤.

### 5-3. ê°œì„ ê²°ê³¼

(1)cpu ìš©ëŸ‰ì„ ë” ëŠ˜ë¦¼ê³¼ ë™ì‹œì— (2)nginxì˜ work í”„ë¡œì„¸ìŠ¤ ì œí•œê±¸ë¦° ë¶€ë¶„ì„ í™•ì¥í•˜ì˜€ë”ë‹ˆ ì•„ë˜ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì˜€ë‹¤.

```
# nginx.conf í”„ë¡œì„¸ì„œ í™•ì¥
worker_processes  100;

# shell í™•ì¸
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go http://127.0.0.1:8080/auth/user 10000
ì‹¤í–‰ì‹œê°„ 86.281953431
status:  200  count:  10000
```

ë¹„êµí–ˆì„ ë–„, **110ì´ˆ -> 86ì´ˆ ë¡œ ì•½ 24ì´ˆ**ê°€ëŸ‰ ë‹¨ì¶•ë¨ì„ ê´€ì°°í•  ìˆ˜ ìˆë‹¤!


## 6. **ë‹¨ì¼ Auth ì„œë²„ë¡œ ì¸í•œ ë³‘ëª©í˜„ìƒ**
Auth ì„œë²„ê°€ í•˜ë‚˜ì´ê¸°ë•Œë¬¸ì— ì„œë²„ ë¡œì§ì˜ ë³‘ëª©í˜„ìƒì´ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ Auth ì„œë²„ë¥¼ í™•ì¥(DBëŠ” ë‹¨ì¼)ì‹œí‚¬ê²ƒì´ë‹¤.
> ìš°ë¦¬ëŠ” ì‰½ê²Œ ì´ë¥¼ í™•ì¥ì‹œí‚¬ ìˆ˜ ìˆë‹¤! **Kafkaì˜ í™•ì¥ì„± ì¥ì **ì´ ì—¬ê¸°ì„œ ë“œëŸ¬ë‚˜ê³ , **Dockerì˜ ì´ë¯¸ì§€ ì¬í™œìš© ì¥ì **ë˜í•œ ì—¬ê¸°ì„œ ë“œëŸ¬ë‚œë‹¤!

ìš°ë¦¬ê°€ ìˆ˜ì •í•´ì•¼ í•  ê³³ì€ `nginx.conf`ì™€ `docker-compose.yaml` ì´ ë‘ ê°€ì§€ì´ë‹¤.

### 6-1. ë¨¼ì € docker-compose.yamlì— auth-server-2ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€

```dockerfile
version : '2'
services:
  # -------- KAFKA --------
  ...
  # -------- Chatting Server --------
  ...
  # -------- kafdrop for visualization --------
  ...
  # -------- postgres -> kafka source connector --------
  ...
  # -------- API GATEWAY --------
  ...
  # -------- Authentication Server --------
  ...
  auth-server-2:
    container_name: auth-server-2
    build: ./spring-auth-backend-server
    ports:
      - "8072:8072"
    environment:
      - SERVER_PORT=8072
      - SPRING_DATASOURCE_URL=jdbc:postgresql://auth-db:5435/auth
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=password
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - KAFKA_BOOTSTRAP=kafka1:9092,kafka2:9092,kafka3:9092 # ë‚´ë¶€í¬íŠ¸
    depends_on:
      - auth-db
    restart: always
```

### 6-2. ì´í›„, nginx.confì˜ upstreamì— í•´ë‹¹ ì»¨í…Œì´ë„ˆë¥¼ ì¶”ê°€

```
upstream auth-server {
        server auth-server:8085;
        server auth-server-2:8072;
    }
```

ìœ„ì™€ ê°™ì´ ì•„ë¬´ê²ƒë„ ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´, nginxê°€ ë¼ìš´ë“œ ë¡œë¹ˆìœ¼ë¡œ ë²ˆê°ˆì•„ê°€ë©´ì„œ ë©”ì„¸ì§€ë¥¼ ë‚ ë ¤ì¤€ë‹¤.

### 6-3. ê°œì„ ê²°ê³¼-1

```
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go http://127.0.0.1:8080/auth/user 10000
ì‹¤í–‰ì‹œê°„ 83.900060333
status:  200  count:  10000
```

**86ì´ˆ -> 83ì´ˆ**ë¡œ ì•„ì£¼ ì¡°ê¸ˆ ê°ì†Œí•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

> ì°¸ê³ ë¡œ cpuì‚¬ìš©ë¥ ì€ í‰ê·  520%ë¡œ 440%ì—ì„œ **ì•½ 80%ê°€ëŸ‰ ìƒìŠ¹**í–ˆë‹¤.

### 6-4. ê°œì„ ê²°ê³¼-2
ê·¸ëŸ°ë° ì´ìƒí•œ ì ì„ ë°œê²¬í–ˆë‹¤. í˜¹ì‹œ ëª°ë¼ì„œ ë°”ë¡œ í•œë²ˆë” í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë”ë‹ˆ,

```
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go http://127.0.0.1:8080/auth/user 10000
ì‹¤í–‰ì‹œê°„ 83.900060333
status:  200  count:  10000
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go http://127.0.0.1:8080/auth/user 10000
ì‹¤í–‰ì‹œê°„ 49.853405095
status:  200  count:  10000 <--- ì•½ 34ì´ˆ ì†Œëª¨ì‹œê°„ ê°ì†Œ?!
```

ì´ê²Œ ë¬´ìŠ¨ì¼ì¼ê¹Œ?

* ì¼ë‹¨ TCP handshakeì— ì†Œëª¨ë˜ëŠ” ì‹œê°„ ê°ì†ŒëŠ” ì•„ë‹ê²ƒì´ë‹¤.

> Golang ì½”ë“œì—ì„œ Timeout ë°œìƒí•˜ë©´ ì—°ê²°ì„ ìœ ì§€í•˜ì§€ ì•Šê¸°ë•Œë¬¸ì—, ë‹¤ì‹œ handshakeë¥¼ í•´ì¤˜ì•¼í•˜ê¸° ë–„ë¬¸ì´ë‹¤.

* í˜¹ì‹œ nginxê°€ ì´ì „ connectionì— ëŒ€í•œ ì •ë³´ë¥¼ ìºì‹œë¡œ ê°€ì§€ê³  ìˆê¸°ë•Œë¬¸ì— ì´ˆê¸° ì—°ê²°ì´ ë¹ ë¥´ê²Œ ì„¤ì •ëœê²Œ ì•„ë‹ê¹Œ?

> ì´ë˜í•œ ì•„ë‹ ê²ƒì´ë‹¤. nginxëŠ” defaultë¡œ GET ë©”ì†Œë“œì— ëŒ€í•´ì„œë§Œ ìºì‹œ êµ¬ì„±ì„ ì„¤ì •í•´ì£¼ê¸° ë•Œë¬¸ì´ë‹¤. ìš°ë¦¬ëŠ” POST ë©”ì†Œë“œë¥¼ ì „ì†¡í•œë‹¤.
>
> ì¦ëª…í•˜ê¸° ìœ„í•´ nginx containerì„ ì´ˆê¸°í™”ì‹œí‚¤ê³  ì¬ì‹¤í–‰ í•´ë³´ì•˜ë‹¤. ì—­ì‹œ 49ì´ˆ ì–¸ì €ë¦¬ë¡œ ë‚˜ì™”ë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì›ì¸ì€ nginxëŠ” ì•„ë‹ˆê³ , test code ì•„ë‹ˆê³ , **auth-server**ì— ìˆë‹¤.

* **Spring Server warming-up process**

ìŠ¤í”„ë§ì„œë²„ëŠ” ëŒ€ë¶€ë¶„ì´ LAZYë¡œ ë˜ì–´ìˆì–´ì„œ ì´ˆê¸° ë°ì´í„°ë“¤ë¡œ ì›Œë°ì—…ë˜ê¸° ì „ê¹Œì§€ëŠ” ì•„ì§ ì™„ë²½íˆ initializeë˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ, ìŠ¤í”„ë§ ì„œë²„ê°€ ì›Œë°ì—…(JPA, driver, etc.)ë˜ê¸° ì‹œê°„ì´ ì´ˆê¸° í…ŒìŠ¤íŠ¸ì— í¬í•¨ë˜ê¸°ë•Œë¬¸ì— ì‹œê°„ì´ ë” ì†Œìš”ëœë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

reference : [https://stackoverflow.com/questions/63019528/why-are-spring-rest-services-slow-on-the-first-request](https://stackoverflow.com/questions/63019528/why-are-spring-rest-services-slow-on-the-first-request)
