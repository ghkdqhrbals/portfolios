---
layout: default
title: 22. @Asyncë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Spring Java MultiThread handling
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
date: 2023-03-06
nav_order: 22
---

created at 2023-03-06
{: .label .label-yellow }

#### INDEX
0. ì„œë¡ 
1. Multi Thread with Custom Exception, **Not using @Async!**
   1. ë©€í‹°ìŠ¤ë ˆë”© ê²°ê³¼
      1. ì •ìƒì ì¸ api ìš”ì²­ ê²°ê³¼
      2. db-ìœ ë‹ˆí¬ í‚¤ violation ì—ëŸ¬ í•¸ë“¤ë§ ê²°ê³¼
   2. ì‹ ë‚˜ëŠ” ì½”ë”©!
      1. ìŠ¤ë ˆë“œ í’€ ë° TaskExecutor ì„¤ì •í•´ì„œ Beanì— ì˜¬ë¦¬ê¸°
      2. IoC ì„¤ì •
      3. UserService ì˜ save ë©”ì†Œë“œ CompletableFuture ë°˜í™˜í•˜ê¸°
      4. UserRepositoryJDBC ì˜ saveAll ë©”ì†Œë“œ CompletableFuture ë°˜í™˜í•˜ê¸° ë° ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬
      5. UserController ì˜ non-blocking í˜¸ì¶œ
2. [ë¡œê¹…ëª©ì  ë©€í‹°ìŠ¤ë ˆë”©] Multi Thread with Custom Exception, But only for **logging**
   1. ê¸°ì¡´ Single Thread with Custom Exception
   2. CustomAsyncExceptionHandler ì¶”ê°€
   3. AsyncConfig ë³€ê²½
   4. UserServiceì˜ save ë©”ì†Œë“œ ìˆ˜ì •

# 0. ì„œë¡ 

ì €ëŠ” ìµœê·¼ì— ê³„ì† Chat Server ì„ ìµœì í™”í•˜ëŠ” ê³¼ì •ì„ ìˆ˜í–‰í•˜ê³  ìˆëŠ”ë°ìš”. ë¹„ë™ê¸°ë¡œ ë°”ê¾¸ê³  ë³„ë¡œ ë¬¸ì œì—†ëŠ” ì¤„ ì•Œì•˜ì§€ë§Œ JPA ì—ëŸ¬ë¥¼ í•¸ë“¤ë§í•˜ëŠ” CustomException ì´ ë™ì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ã…œã…œ.

ì‚¬ì‹¤ ë‹¹ì—°í•œê²Œ, ë‹¨ìˆœíˆ @Async ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ JPA-DB ì—ëŸ¬ë¥¼ í•¸ë“¤ë§í•œë‹¤ë©´, í•´ë‹¹ ìŠ¤ë ˆë“œëŠ” ê·¸ëƒ¥ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šê³  ëë‚˜ë²„ë¦¬ê²Œ ë©ë‹ˆë‹¤. ì¦‰, **ì—ëŸ¬ ìì²´ë¥¼ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ë°˜í™˜ë°›ì§€ ëª»í•œë‹¤ëŠ” ê²ƒ**ì´ì£ !

**ê·¸ë˜ì„œ ì €ëŠ” ì• ì´ˆì— ì•„ë˜ì˜ ë¬¸ì œì ì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡, ìŠ¤ë ˆë“œì™€ ì¿¼ë¦¬ë“¤ì„ ì™„ë²½íˆ ì»¨íŠ¸ë¡¤í•˜ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤.**
> * JPA ì¿¼ë¦¬ ìµœì í™” ë¬¸ì œ : ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ ìƒì„¸í•˜ê²Œ ì¿¼ë¦¬ë“¤ì„ Optimizing í•  ìˆ˜ ì—†ìŒ
> * Batch ì„±ëŠ¥ ë¬¸ì œ : JPA ë°°ì¹˜ì„±ëŠ¥ <<< JDBC ë°°ì¹˜ì„±ëŠ¥
> * Multi threading ë¬¸ì œ : JPA í˜¸í™˜ì´ ì–´ë ¤ì›€(ì•„ë˜ì—ì„œ ì„¤ëª…)

* **JPA ë¥¼ ë©€í‹° ìŠ¤ë ˆë“œë¡œ ì‚¬ìš© ì‹œ ë¬¸ì œì **

JPA repository ëŠ” @Async ì–´ë…¸í…Œì´ì…˜ì„ ì§€ì›í•˜ê¸´ í•©ë‹ˆë‹¤. **í•˜ì§€ë§Œ, ì˜¤ì§ ìƒˆë¡œìš´ ë©”ì†Œë“œì—ë§Œ í• ë‹¹í•  ìˆ˜ ìˆì–´ìš”!** JPA ê¸°ë³¸ì œê³µ ë©”ì†Œë“œ(ex. save, saveAll, find, etc.)ë“¤ì€ í“¨ì³ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆê¸°ì—, ë©€í‹° ìŠ¤ë ˆë”© í™˜ê²½ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

* **ê·¸ëŸ¬ë©´ ì–´ë–»ê²Œ í•´ì•¼ë ê¹Œìš”?**

1. **ê¸°ì¡´ì— JPAê°€ ì œê³µí•˜ë˜ ë©”ì†Œë“œë“¤ì„ ì§ì ‘ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ ì§œì•¼ë˜ìš”!**(i.e. INSERT ë¬¸ì€ JPA ê°€ ê¸°ì¡´ save, saveAll ë©”ì†Œë“œë¥¼ í†µí•´ì„œë§Œ ì œê³µí•˜ê¸° ë–„ë¬¸ì—, INSERT ë¬¸ì— ë©€í‹° ìŠ¤ë ˆë”©ì„ ì ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ ì§ì ‘ ì‘ì„±í•´ì•¼í•©ë‹ˆë‹¤.)
2. Repository/Service ì˜ ë©”ì†Œë“œ ë°˜í™˜ íƒ€ì…ì„ CompletableFuture ê°ì²´ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
   * CompletableFutureë€?
   
     Future ê°ì²´ì— CallBack ì„ ë”í•œ ê°ì²´ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¡œ taskë¥¼ ì „ì†¡í•œ ë’¤, Non-blocking ìœ¼ë¡œ hooking í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3.  CustomException ì„ ì¶”ê°€ì ìœ¼ë¡œ í•¸ë“¤ë§í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.(ê¸°ì¡´ì—ëŠ” GlobalExceptionHandler ë¡œ AOP ë¥¼ ì‘ì„±í–ˆì§€ë§Œ, ë”°ë¡œ ë–¼ì¤„ê±°ì—ìš”)

# 1. Multi Thread with Custom Exception, **Not using @Async!**
ì§€ê¸ˆë¶€í„° `@Async`ë¥¼ ì „ë¶€ ë¹¼ë²„ë¦¬ê³  ì§ì ‘ ìŠ¤ë ˆë“œì™€ ì¿¼ë¦¬ë“¤ì„ ì»¨íŠ¸ë¡¤ í• ê±°ì—ìš”. ê·¸ë¦¬ê³  Spring Bean ì˜ IoCë¥¼ í™œìš©í• ê±°ì—ìš”.

ë¨¼ì € ê²°ê³¼ë¶€í„° í™•ì¸í•´ ë³¼ê¹Œìš”?

## 1-1 ë©€í‹°ìŠ¤ë ˆë”© ê²°ê³¼
### 1-1-1. ì •ìƒì ì¸ api ìš”ì²­ ê²°ê³¼
![img](../../../assets/img/rds/20.png)

### 1-1-2. db-ìœ ë‹ˆí¬ í‚¤ violation ì—ëŸ¬ í•¸ë“¤ë§ ê²°ê³¼
![img](../../../assets/img/rds/21.png)

ì¼ë‹¨ ìš”ì²­ì€ 2ê°œì˜ ë©”ì†Œë“œ(1. Kafkaì— ë©”ì„¸ì§€ ì „ì†¡, 2. DBì— ì €ì¥ìš”ì²­)ë¥¼ ë¹„ë™ê¸° Non-blocking ìœ¼ë¡œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤. ì •ìƒ ìƒí™©ì¼ ë•ŒëŠ” ê°ì ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.

ì´ì œ ì¼ë¶€ëŸ¬ ìœ ë‹ˆí¬ í‚¤ violationì„ ìœ ë°œí•˜ëŠ” api ìš”ì²­ì„ ë³´ë‚´ë³´ì•˜ìŠµë‹ˆë‹¤. userRepositoryì—ì„œ ConcurrentExceptionì„ ë³¼ ìˆ˜ ìˆì£ . ì´ê²Œ, ì‹¤ì œ Exceptionì¸ `DuplicateKeyException`ì„ ê°ì‹¸ê³  ìˆëŠ” exception ì¸ë°ìš”. ì¦‰ ì¤‘ì²©ëœ Exceptionì´ì£ . ì´ ë¶€ë¶„ì„ unwrapí•´ì„œ `DuplicateKeyException` ì„ `CustomException` ìœ¼ë¡œ ë³€í™˜í•´ì£¼ì—ˆì–´ìš”. ê·¸ë¦¬ê³  `db-thread-4` ìŠ¤ë ˆë“œëŠ” ì„œë¹„ìŠ¤ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•´ì£¼ê²Œ ë©ë‹ˆë‹¤!

ì´ì œ ì½”ë“œë¥¼ í™•ì¸í•´ ë³¼ê¹Œìš”?

## 1-2 ì‹ ë‚˜ëŠ” ì½”ë”©!
### 1-2-1. ìŠ¤ë ˆë“œ í’€ ë° TaskExecutor ì„¤ì •í•´ì„œ Beanì— ì˜¬ë¦¬ê¸°

ë¨¼ì € í• ë‹¹í•˜ê³ ì í•˜ëŠ” ìŠ¤ë ˆë“œ ê°œìˆ˜ì™€ TaskExecutorê°€ ë©€í‹°ìŠ¤ë ˆë”©ì—ì„œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œëŠ” JavaëŠ” ForkJoinPool.commonPoolì„ ì‚¬ìš©í•  í…ë°ìš”. ì €ëŠ” **ì„œë¹„ìŠ¤ì™€ ë°ì´í„°ë² ì´ìŠ¤ì— ê°ê° ìŠ¤ë ˆë“œ í’€ì„ í• ë‹¹**í•˜ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì´ ë¹ˆìœ¼ë¡œ ê°ê°ì˜ Executor ì„ ë¹ˆì— ì˜¬ë ¤ì£¼ì„¸ìš”.

```java
@Configuration
@Slf4j
public class AsyncConfig  {

    @Bean(name = "taskExecutorForService")
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor t = new ThreadPoolTaskExecutor();
        t.setCorePoolSize(10);
        t.setMaxPoolSize(100);
        t.setQueueCapacity(10);
        t.setThreadNamePrefix("service-thread-");

        t.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        t.setWaitForTasksToCompleteOnShutdown(true);
        t.setAwaitTerminationSeconds(60);

        t.initialize();
        return t;
    }

    @Bean(name = "taskExecutorForDB")
    public Executor AsyncExecutorForDB() {
        ThreadPoolTaskExecutor t = new ThreadPoolTaskExecutor();
        t.setCorePoolSize(10);
        t.setMaxPoolSize(100);
        t.setQueueCapacity(10);
        t.setThreadNamePrefix("db-thread-");

        t.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        t.setWaitForTasksToCompleteOnShutdown(true);
        t.setAwaitTerminationSeconds(60);

        t.initialize();
        return t;
    }
}
```

### 1-2-2. IoC ì„¤ì •

ì•„ë˜ì™€ ê°™ì´ UserService ì„œë¹„ìŠ¤ì— `@Qualifier` ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ë¹ˆì— ë“±ë¡ëœ `taskExecutorForService` Executorì„ ì£¼ì…ì‹œí‚¬ê±°ì—ìš”.

```java
@Slf4j
@Configuration
public class JpaConfig {

    private final EntityManager em;
    private final UserRepository userRepository;
    private final KafkaTemplate<String, Object> kafkaProducerTemplate;
    private final UserRepositoryJDBC userRepositoryJDBC;
    private final JdbcTemplate jdbcTemplate;
    private final Executor serviceExecutor;

    public JpaConfig(EntityManager em,
                     UserRepository userRepository,
                     KafkaTemplate<String, Object> kafkaProducerTemplate,
                     UserRepositoryJDBC userRepositoryJDBC,
                     JdbcTemplate jdbcTemplate,
                     @Qualifier("taskExecutorForService") Executor serviceExecutor) {
        this.em = em;
        this.userRepository = userRepository;
        this.kafkaProducerTemplate = kafkaProducerTemplate;
        this.userRepositoryJDBC = userRepositoryJDBC;
        this.jdbcTemplate = jdbcTemplate;
        this.serviceExecutor = serviceExecutor;
    }
    
    @Bean
    public UserService userService() {
        return new UserServiceImpl(userRepository, userRepositoryJDBC, kafkaProducerTemplate, serviceExecutor);
    }
}
```

### 1-2-3. UserService ì˜ save ë©”ì†Œë“œ CompletableFuture ë°˜í™˜í•˜ê¸°

ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œëŠ” ìœ ì €ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ì„œ ì„œë¹„ìŠ¤ì˜ save ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ëŠ”ë°ìš”. ì•„ë˜ì™€ ê°™ì´ CompletableFutureì„ ì™€ì¼ë“œì¹´ë“œí‹°ì…ìœ¼ë¡œ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. **í…ŒìŠ¤íŠ¸í•˜ê¸° ì‰½ê²Œ `log.info()` ë“¤ì€ ë‚¨ê²¨ë‘˜ê²Œìš” :)**
> **ex**ëŠ” ì£¼ì…ë°›ì€ Executor(serviceExecutor) ì…ë‹ˆë‹¤!

```java
@Slf4j
@Service
@Transactional
public class UserServiceImpl extends KafkaTopicConst implements UserService {
    ...
    @Override
    public CompletableFuture<?> save(User user) throws CustomException {
        log.info("ì„œë¹„ìŠ¤:Save ì§„ì…");
        return CompletableFuture.supplyAsync(() -> {
            log.info("ì„œë¹„ìŠ¤:Future ì§„ì…");
            return Arrays.asList(user);
        }, ex).thenCompose(u -> {
            log.info("ì„œë¹„ìŠ¤:ë¦¬í¬ì§€í† ë¦¬ ì ‘ê·¼ ì‹œì‘");
            return userRepositoryJDBC.saveAll(u);
        }).exceptionally(e -> {
            log.info("ì„œë¹„ìŠ¤:ì—ëŸ¬={}", e.getMessage());
            if (e.getCause() instanceof CustomException) {
                CustomException ex = (CustomException) e.getCause(); // ì •ì˜ëœ CustomExceptionì´ë¼ë©´ íƒ€ì… ìºìŠ¤íŒ…
                throw ex;
            } else {
                throw new RuntimeException(); // ì²˜ìŒë³´ëŠ” ì—ëŸ¬ë¼ë©´, RuntimeException ë°˜í™˜
            }
        }).thenRun(() -> {
            log.info("ì„œë¹„ìŠ¤:ë");
        });
    }
    ...
}
```

### 1-2-4. UserRepositoryJDBC ì˜ saveAll ë©”ì†Œë“œ CompletableFuture ë°˜í™˜í•˜ê¸°

ì–˜ëŠ” ë”°ë¡œ `@Qualifier("taskExecutorForDB")`ë¡œ ë¹ˆì—ì„œ Executor ì„ ì£¼ì…ë°›ì•˜ìŠµë‹ˆë‹¤. CompletableFuture.runAsync(()->{ ... }, [**ì£¼ì…ë°›ì€ Executor**])

> ì´í›„ì— Batch ë¥¼ ì ìš©ì‹œí‚¤ê¸° ìœ„í•´ì„œ saveAll ë¡œ ë©”ì†Œë“œ ë„¤ì„ì„ ì ì—ˆìŠµë‹ˆë‹¤.

```java
@Slf4j
@Repository
public class UserRepositoryJDBC {
    private final JdbcTemplate jdbcTemplate;
    private final Executor databaseExecutor;

    public UserRepositoryJDBC(JdbcTemplate jdbcTemplate, @Qualifier("taskExecutorForDB") Executor databaseExecutor) {
        this.jdbcTemplate = jdbcTemplate;
        this.databaseExecutor = databaseExecutor;
    }

    @Transactional
    public CompletableFuture<?> saveAll(List<User> users) throws CustomException {
        log.info("ë¦¬í¬ì§€í† ë¦¬:ì§„ì…");
        return CompletableFuture.runAsync(()->{
            log.info("ë¦¬í¬ì§€í† ë¦¬:ì¿¼ë¦¬ì‹œì‘");
            String sql = "INSERT INTO user_table (user_id, email, join_date, login_date, logout_date, user_name, user_pw) " +
                    "VALUES (?, ?, ?, ?, ?, ?, ?) ";

            jdbcTemplate.batchUpdate(sql,
                    users,
                    users.size(),
                    (PreparedStatement ps, User user) -> {
                        ps.setString(1, user.getUserId());
                        ps.setString(2, user.getEmail());
                        ps.setObject(3, user.getJoinDate());
                        ps.setObject(4, user.getLoginDate());
                        ps.setObject(5, user.getLogoutDate());
                        ps.setString(6,user.getUserName());
                        ps.setString(7,user.getUserPw());
                    });

        },databaseExecutor).exceptionally(e->{
            log.info("ë¦¬í¬ì§€í† ë¦¬:ì—ëŸ¬={}",e.getClass());
            if (e.getCause().getClass() == DuplicateKeyException.class){
                log.info("ë¦¬í¬ì§€í† ë¦¬:ì—ëŸ¬ë°˜í™˜={}",DUPLICATE_RESOURCE);
                throw new CustomException(DUPLICATE_RESOURCE);
            }
            throw new RuntimeException();
        });
    }
}
```

### 1-2-5. UserController ì˜ non-blocking í˜¸ì¶œ

```java
@Slf4j
@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class UserController extends KafkaTopicConst {
    private final UserService userService;
    private final KafkaTemplate<String, Object> kafkaProducerTemplate;
    ...
    @PostMapping("/user")
    public DeferredResult<ResponseEntity<?>> addUser(@RequestBody RequestAddUserDTO request){

        DeferredResult<ResponseEntity<?>> dr = new DeferredResult<>();

        User user = new User(
                request.getUserId(),
                request.getUserPw(),
                request.getEmail(),
                request.getUserName(),
                LocalDate.now(),
                LocalDate.now(),
                LocalDate.now()
        );

        // ìœ ì € ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ìœ ì € ì €ì¥
        saveUserHandler(dr, user);
        
        // ì¹´í”„ì¹´ ë©”ì„¸ì§€ ì „ì†¡ (ìœ ì € ì €ì¥ì— ì‹¤íŒ¨í•´ë„ ì „ì†¡)
        sendToKafkaWithKey(TOPIC_USER_CHANGE, new RequestUserChange(user.getUserId(), user.getUserName(), "", "INSERT"), user.getUserId());
        
        return dr;
    }
    
    private void saveUserHandler(DeferredResult<ResponseEntity<?>> dr, User user) {
        log.info("ì»¨íŠ¸ë¡¤ëŸ¬:ìœ ì € ì €ì¥ì„ ìœ„í•œ ì„œë¹„ìŠ¤ ì ‘ê·¼ ì‹œì‘");
        CompletableFuture
                .runAsync(() -> {
                    log.info("ì»¨íŠ¸ë¡¤ëŸ¬:Future ì§„ì…");
                }).thenCompose(s -> {
                    log.info("ì»¨íŠ¸ë¡¤ëŸ¬:ì„œë¹„ìŠ¤ ì§„ì… ì‹œì‘");
                    return userService.save(user);
                }).thenAccept(s1 -> {
                    log.info("ì»¨íŠ¸ë¡¤ëŸ¬:ì„œë¹„ìŠ¤ ì •ìƒì¢…ë£Œ");
                    dr.setResult(ResponseEntity.ok("success"));
                }).exceptionally(e -> {
                    log.info("ì»¨íŠ¸ë¡¤ëŸ¬:ì—ëŸ¬={}", e.getMessage());
                    if (e.getCause() instanceof CustomException) {
                        dr.setResult(ErrorResponse.toResponseEntity(((CustomException) e.getCause()).getErrorCode()));
                    } else {
                        dr.setResult(ResponseEntity.badRequest().body("default bad request response"));
                    }
                    return null;
                }).thenRun(() -> {
                    log.info("ì»¨íŠ¸ë¡¤ëŸ¬:ë°˜í™˜=DeferredResults {}", dr.getResult());
                });
    }

    private CompletableFuture<?> sendToKafkaWithKey(String topic,Object req, String key) {
        log.info("ì»¨íŠ¸ë¡¤ëŸ¬:ì¹´í”„ì¹´ ì „ì†¡ ì‹œì‘");
        ListenableFuture<SendResult<String, Object>> future = kafkaProducerTemplate.send(topic,key, req);
        future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {
            @Override
            public void onFailure(Throwable ex) {
                log.error("ë©”ì„¸ì§€ ì „ì†¡ ì‹¤íŒ¨={}", ex.getMessage());
            }
            @Override
            public void onSuccess(SendResult<String, Object> result) {
                log.info("ë©”ì„¸ì§€ ì „ì†¡ ì„±ê³µ topic={}, key={}, offset={}, partition={}",topic, key, result.getRecordMetadata().offset(), result.getRecordMetadata().partition());
            }
        });

        return toCF(future);
    }

    <T> CompletableFuture<T> toCF(ListenableFuture<T> lf){
        CompletableFuture<T> cf = new CompletableFuture<T>();
        lf.addCallback(s-> cf.complete(s), e-> cf.completeExceptionally(e));
        return cf;
    }
    ...
    
}
```

1. ì„œë²„ëŠ” `/user` ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, addUserì—ì„œ `saveUserHandler`ë¥¼ í˜¸ì¶œí•˜ê²Œ ë©ë‹ˆë‹¤. ë˜í•œ `sendToKafkaWithKey` ë„ í˜¸ì¶œí•©ë‹ˆë‹¤.
2. ë¨¼ì € `saveUserHandler`ëŠ” ForkJoinPool.commonPool ì˜ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ë©°,  userServiceì˜ saveë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
3. ë§Œì•½ thenCompose ì´í›„ `then...Async`ë¥¼ ìˆ˜í–‰í•œë‹¤ë©´, ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¡œ ì‹¤í–‰ë˜ë©° ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” userServiceì˜ ìŠ¤ë ˆë“œê°€ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤. ì €ê°™ì€ ê²½ìš°ëŠ” userServiceì˜ ìŠ¤ë ˆë“œê°€ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ê²Œ ë˜ê² ë„¤ìš”.
4. ìœ ì €ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ëœë‹¤ë©´, Response.okë¥¼ DeferredResult ê°ì²´ì— ë„£ì–´ì¤ë‹ˆë‹¤.
5. ë§Œì•½ ì¤‘ê°„ì— ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš° ë”°ë¡œ ì •ì˜í•œ `ErrorResponse.toResponseEntity({ì˜ˆì™¸ì„¤ëª…})`ë¥¼ ë°˜í™˜í•˜ê²Œ ë©ë‹ˆë‹¤.
6. ë¯¸ë¦¬ ì •ì˜í•œ ì—ëŸ¬íƒ€ì…ì´ ì•„ë‹ˆë¼ë©´ Response.badRequestë¥¼ ë°˜í™˜í•˜ê²Œ ë©ë‹ˆë‹¤.

* ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” `sendToKafkaWithKey`ë¥¼ ì´ì œ ë³¼ê¹Œìš”?

1. Spring KafkaTemplate ì—ì„œ ì œê³µí•˜ëŠ” ì„±ê³µë°˜í™˜ì—¬ë¶€ ê°ì²´ëŠ” CompletableFuture ê°ì²´ê°€ ì•„ë‹Œ ListenableFuture ê°ì²´ì…ë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ëŠ” ì´í›„ thenComposeë¡œ ë„˜ê¸¸ ê²ƒì„ ëŒ€ë¹„í•´ì„œ ê°ì²´ë¥¼ `toCF()` ë¥¼ í†µí•´ ë³€í™˜ì‹œì¼œì¤„ê±°ì—ìš”(feat. [í† ë¹„ë‹˜](https://www.youtube.com/watch?v=PzxV-bmLSFY&list=PLv-xDnFD-nnmof-yoZQN8Fs2kVljIuFyC&index=4)). `sendToKafkaWithKey` ê°ì²´ëŠ” ì´ì œ ë©”ì„¸ì§€ ì „ì†¡ ì„±ê³µ ì—¬ë¶€ë¥¼ ë³„ë„ì˜ ìŠ¤ë ˆë“œë¡œ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤!


* ì—ëŸ¬ë¥¼ ë¡œê¹…ë§Œ í•  ê²ƒì´ë¼ë©´, Spring 5.3.x ì—ì„œ ì§€ì›í•˜ëŠ” ì•„ë˜ì˜ ë°©ë²• ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## 2. [ë¡œê¹…ëª©ì ] Multi Thread with Custom Exception, But only for **logging**
`AsyncUncaughtExceptionHandler`, `AsyncConfigurerSupport`ë¥¼ í†µí•´ì„œ @Async ì–´ë…¸í…Œì´ì…˜ì„ **ë¡œê¹… ëª©ì ìœ¼ë¡œ ì‚¬ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.(ë©”ì¸ ìŠ¤ë ˆë“œë¡œì˜ ë°˜í™˜ X)

#### 2-1. ê¸°ì¡´ Single Thread with Custom Exception

```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler extends ResponseEntityExceptionHandler {

    @ExceptionHandler(value = { ConstraintViolationException.class, DataIntegrityViolationException.class})
    protected ResponseEntity<ErrorResponse> handleDataException() {
        log.error("handleDataException throw Exception : {}", DUPLICATE_RESOURCE);
        return ErrorResponse.toResponseEntity(DUPLICATE_RESOURCE);
    }

    @ExceptionHandler(value = { CustomException.class })
    protected ResponseEntity<ErrorResponse> handleCustomException(CustomException e) {
        log.error("handleCustomException throw CustomException : {}", e.getErrorCode());
        return ErrorResponse.toResponseEntity(e.getErrorCode());
    }
}
```

ìœ„ì˜ ì½”ë“œëŠ” ê¸€ë¡œë²Œí•˜ê²Œ Controllerì—ì„œ Exceptionì„ throwí•´ì„œ í•´ë‹¹ í´ë˜ìŠ¤ê°€ `CustomException`, `ConstraintViolationException`, `DataIntegrityViolationException` ì¼ ë•Œ ResponseEntityë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•˜ë„ë¡ í•˜ëŠ” RestControllerAdvice ì…ë‹ˆë‹¤.

ì €ëŠ” í•´ë‹¹ ì½”ë“œë¥¼ í†µí•´ì„œ Service ì—ì„œ ë°œìƒí•œ Exceptionë“¤ì„ í•¸ë“¤ë§í•˜ëŠ”ë°ìš”. ë¬¸ì œëŠ” `@ExceptionHandler`ëŠ” ì˜¤ì§ **ë™ê¸° ì˜ˆì™¸ì²˜ë¦¬**ë§Œ í•œë‹¤ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ìˆ˜ì •í–ˆëŠ”ë°ìš”. ë‹¤ë§Œ `AsyncUncaughtExceptionHandler`ì€ í˜¸ì¶œ ìŠ¤ë ˆë“œì—ê²Œ returnì„ í•  ìˆ˜ ì—†ë‹¤ëŠ” ë‹¨ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì•„ë˜ëŠ” ë‹¨ìˆœíˆ ë¡œê¹…ì„ ëª©ì ìœ¼ë¡œ ì‘ì„±í•´ì•¼ë§Œ í•©ë‹ˆë‹¤.

#### 2-2. CustomAsyncExceptionHandler ì¶”ê°€
```java
public class CustomAsyncExceptionHandler implements AsyncUncaughtExceptionHandler {
    @Override
    public void handleUncaughtException(Throwable ex, Method method, Object... obj) {
        System.out.println("Exception message - " + ex.toString() + ex.getClass().getName());
        System.out.println("Method name - " + method.getName());
        for (Object param : obj) {
            System.out.println("Parameter value - " + param.getClass().getName());
        }
    }
}
```

#### 2-3. AsyncConfig ë³€ê²½

```java
@Configuration
@Slf4j
@EnableAsync
public class AsyncConfig extends AsyncConfigurerSupport {

    @Override
    @Bean(name = "taskExecutor")
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor t = new ThreadPoolTaskExecutor();
        t.setCorePoolSize(10);
        t.setMaxPoolSize(100);
        t.setQueueCapacity(10);
        t.setThreadNamePrefix("auth-thread-");

        t.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        t.setWaitForTasksToCompleteOnShutdown(true);
        t.setAwaitTerminationSeconds(60);

        t.initialize();
        return t;
    }
    
    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return new CustomAsyncExceptionHandler();
    }

}
```

#### 2-4. UserServiceì˜ save ë©”ì†Œë“œ ìˆ˜ì •

```java
@Async
@Service
@Transactional
public class UserServiceImpl implements UserService {
    ...
    @Override
    public User save(User user) throws CustomException {
        Optional<User> findUser = userRepository.findById(user.getUserId());

        if (findUser.isPresent()) {
            throw new CustomException(DUPLICATE_RESOURCE);
        } else {
            User save = userRepository.save(user);
            return save;
        }
    }
}
```

í¸í•˜ê²Œ ë¡œê¹…ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•  ê²ƒì´ë¼ë©´, Spring ì´ ì§€ì›í•´ì£¼ëŠ” ë©”ì†Œë“œë¥¼ ìƒì†ë°›ì•„ì„œ ì‚¬ìš©í•˜ëŠ”ê²Œ ì¢‹ê² ì£ ? ë‹¨ì ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ëŠ”ë° ì œëŒ€ë¡œ í™œìš©í•  ìˆ˜ê°€ ì—†ì£ . ì´ìœ ëŠ” **ìŠ¤ë ˆë“œ ê°„ ë°˜í™˜ì„ ì„¤ì •í•  ìˆ˜ ì—†ê±°ë“ ìš”**!

# 3. ê²°ë¡ 

ê²°ë¡ ì ìœ¼ë¡œ ì´ ê¸°ë‚˜ê¸´ ë³€í™˜ê³¼ì •ì€ Java ì™€ Spring ìì²´ì— ëŒ€í•œ ì´í•´ë„ë¥¼ í‚¤ìš°ëŠ”ë° ë„ì›€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œë¶€í„°ëŠ” JPAë¥¼ ì „ë¶€ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ ë°”ê¾¸ëŠ” ì‘ì—…ê³¼ JDBC Batch ì‘ì—…ì´ ë‚¨ì•˜ë„¤ìš”!


