---
layout: default
title: 12. ëŒ€ëŸ‰ Rest api test
parent: ğŸ“Œ ì‹¤ì‹œê°„ ì±„íŒ…ì„œë²„ í”„ë¡œì íŠ¸
date: 2023-01-16
nav_order: 12
---

created at 2023-01-16
{: .label .label-yellow }

# INDEX
* ëœë¤ê°’ìœ¼ë¡œ testí•˜ëŠ” code
* 10000ê°œ rest api íŠ¸ë˜í”½ ì‹¤í–‰(110ì´ˆ ì†Œìš”)


ì´ì œ ë™ì‹œ ì—°ê²°ê°€ëŠ¥í•œ TCP ì†Œì¼“ì„ í•„ìì˜ ë§¥ë¶ì´ ë²„í‹¸ ìˆ˜ ìˆëŠ”ë§Œí¼ ì—´ì–´ì„œ ë‹¤ëŸ‰ì˜ http requestë¥¼ ì„œë²„ë¡œ ì „ì†¡í•´ë³¼ë ¤ê³  í•œë‹¤.

```golang
	t := http.DefaultTransport.(*http.Transport).Clone()
	t.MaxIdleConns = 10000
	t.MaxConnsPerHost = 10000
	t.MaxIdleConnsPerHost = 1

	// í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ë° timeout
	client := &http.Client{
		Timeout:   1 * time.Second,
		Transport: t,
	}
```

Transport ì„¤ì •ì„ ì ê¹ ì„¤ëª…í•˜ìë©´ ì•„ë˜ì™€ ê°™ë‹¤.

1. MaxIdleConns : ì „ì²´ ì»¤ë„¥ì…˜ í’€
2. MaxConnsPerHost : í˜¸ìŠ¤íŠ¸ ë³„(ì„œë²„) í• ë‹¹ ê°€ëŠ¥í•œ ì»¤ë„¥ì…˜ ê°œìˆ˜
3. **MaxIdleConnsPerHost** : í˜¸ìŠ¤íŠ¸ ë³„ í™œì„±í™” ë˜ì§€ ì•Šì•„ë„ ìœ ì§€í•˜ëŠ” ìµœëŒ€ connection ê°œìˆ˜.(Server-Sent Eventê°™ì´ í´ë¼ì´ì–¸íŠ¸ê°€ ë”°ë¡œ ë­˜ ì•ˆë³´ë‚´ë„ ì„œë²„ê°€ ê³„ì† ë³´ë‚´ì•¼ ë  ë•Œ í•„ìš”í•˜ë‹¤. ë³¸ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” í•„ìš”ì—…ìœ¼ë‹ˆ pass)
4. Dial.Timeout = tcp ì†Œì¼“ ìœ ì§€ íƒ€ì„ì•„ì›ƒ(Keep-alive ì‹œê°„) - http.Client.Timeoutë‘ ê°™ë‹¤.
5. http.Client.Timeout : í´ë¼ì´ì–¸íŠ¸(í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸)ê°€ ì†¡ì‹ /ìˆ˜ì‹ ì´ ëë‚˜ë©´ connection ìœ ì§€í•˜ëŠ” ì‹œê°„

í˜„ì¬ í•„ìì˜ ë§¥ë¶ì€ ì•½ tcp ì†Œì¼“ì„ ë™ì‹œì— 10Kê¹Œì§€ëŠ” ë¬´ë‚œíˆ ì—´ ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ 10Kë¡œ ì»¤ë„¥ì…˜ í’€ì„ ì„¤ì •í•œë‹¤. ë˜í•œ status code 200ì„ ìˆ˜ì‹ ë°›ê¸° ìœ„í•œ ìˆ˜ì •ëœ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©° ìŠ¤ë ˆë“œëŠ” 100ê°œë¡œ ì‹¤í–‰í•œë‹¤.

## ëœë¤ê°’ìœ¼ë¡œ testí•˜ëŠ” code

```golang
...
type User struct {
	UserId   string `json:"userId"`
	UserName string `json:"userName"`
	Email    string `json:"email"`
	UserPw   string `json:"userPw"`
}
type Usera struct {
	Name string
}

func init() {
	rand.Seed(time.Now().UnixNano())
}

var letterRunes = []rune("ê¹€ì´ë°•ìµœì •ê°•ì¡°ìœ¤ì¥ì„í•œì˜¤ì„œì‹ ê¶Œí™©ì•ˆì†¡ë¥˜ì „í™ê³ ë¬¸ì–‘ì†ë°°ì¡°ë°±í—ˆìœ ë‚¨ì‹¬ë…¸ì •í•˜ê³½ì„±ì°¨ì£¼ìš°êµ¬ì‹ ì„ë‚˜ì „ë¯¼ìœ ì§„ì§€ì—„ì±„ì›ì²œë°©ê³µê°•í˜„í•¨ë³€ì—¼ì–‘ë³€ì—¬ì¶”ë…¸ë„ì†Œì‹ ì„ì„ ì„¤ë§ˆê¸¸ì£¼ì—°ë°©ìœ„í‘œëª…ê¸°ë°˜ì™•ê¸ˆì˜¥ìœ¡ì¸ë§¹ì œëª¨ì¥ë‚¨íƒêµ­ì—¬ì§„ì–´ì€í¸êµ¬ìš©")
var letterRunes_name = []rune("ê°€ê°•ê±´ê²½ê³ ê´€ê´‘êµ¬ê·œê·¼ê¸°ê¸¸ë‚˜ë‚¨ë…¸ëˆ„ë‹¤ë‹¨ë‹¬ë‹´ëŒ€ë•ë„ë™ë‘ë¼ë˜ë¡œë£¨ë¦¬ë§ˆë§Œëª…ë¬´ë¬¸ë¯¸ë¯¼ë°”ë°•ë°±ë²”ë³„ë³‘ë³´ë¹›ì‚¬ì‚°ìƒìƒˆì„œì„ì„ ì„¤ì„­ì„±ì„¸ì†Œì†”ìˆ˜ìˆ™ìˆœìˆ­ìŠ¬ìŠ¹ì‹œì‹ ì•„ì•ˆì• ì—„ì—¬ì—°ì˜ì˜ˆì˜¤ì˜¥ì™„ìš”ìš©ìš°ì›ì›”ìœ„ìœ ìœ¤ìœ¨ìœ¼ì€ì˜ì´ìµì¸ì¼ììì”ì¥ì¬ì „ì •ì œì¡°ì¢…ì£¼ì¤€ì¤‘ì§€ì§„ì°¬ì°½ì±„ì²œì² ì´ˆì¶˜ì¶©ì¹˜íƒíƒœíƒíŒí•˜í•œí•´í˜í˜„í˜•í˜œí˜¸í™í™”í™˜íšŒíš¨í›ˆíœ˜í¬ìš´ëª¨ë°°ë¶€ë¦¼ë´‰í˜¼í™©ëŸ‰ë¦°ì„ë¹„ì†œê³µë©´íƒì˜¨ë””í•­í›„ë ¤ê· ë¬µì†¡ìš±íœ´ì–¸ë ¹ì„¬ë“¤ê²¬ì¶”ê±¸ì‚¼ì—´ì›…ë¶„ë³€ì–‘ì¶œíƒ€í¥ê²¸ê³¤ë²ˆì‹ë€ë”ì†ìˆ í›”ë°˜ë¹ˆì‹¤ì§í í”ì•…ëŒëœ¸ê¶Œë³µì‹¬í—Œì—½í•™ê°œë¡±í‰ëŠ˜ëŠ¬ë‘ì–€í–¥ìš¸ë ¨")

const letterBytes_id = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"

func RandStringBytes(n int, letterBytes string) string {
	b := make([]byte, n)
	for i := range b {
		b[i] = letterBytes[rand.Intn(len(letterBytes))]
	}
	return string(b)
}

func RandStringRunes_firstname(n int) string {
	b := make([]rune, n)
	for i := range b {
		b[i] = letterRunes[rand.Intn(len(letterRunes))]
	}
	return string(b)
}

func RandStringRunes_lastname(n int) string {
	b := make([]rune, n)
	for i := range b {
		b[i] = letterRunes_name[rand.Intn(len(letterRunes_name))]
	}
	return string(b)
}

func worker(contexts *sync.Map, wg *sync.WaitGroup, requestURL string, jsonBody []byte, client *http.Client, transferRatePerSecond int, number_worker int) {
	defer wg.Done()
	fmt.Println("Threads start:", number_worker)
	// ë¡œì»¬ ë§µ ìƒì„±
	m := make(map[int]int)

	for i := 0; i < transferRatePerSecond; i++ {
		s := &User{
			UserId:   RandStringBytes(8, letterBytes_id),
			UserName: RandStringRunes_lastname(1) + RandStringRunes_firstname(2),
			Email:    RandStringBytes(5, letterBytes_id) + "@gmail.com",
			UserPw:   RandStringBytes(10, letterBytes_id),
		}
		buf, err := json.Marshal(s)
		if err != nil {
			log.Fatal(err)
			return
		}
		bodyReader := bytes.NewReader(buf)
		// ìš”ì²­ ìƒì„±
		req, err := http.NewRequest(http.MethodPost, requestURL, bodyReader)
		if err != nil {
			os.Exit(1)
		}

		// json í—¤ë” ì„¤ì •
		req.Header.Set("Content-Type", "application/json")

		// ì‹¤ì œ ìš”ì²­ ì „ì†¡ ë° ë°˜í™˜
		res, _ := client.Do(req)

		// ë¡œì»¬ ë§µì— ì‚½ì…
		m[res.StatusCode] += 1
	}

	for k, v := range m {
		result, ok := contexts.Load(k)
		if ok {
			contexts.Store(k, result.(int)+v)
		} else {
			contexts.Store(k, v)
		}
	}

}

func main() {

	argsWithoutProg := os.Args[1:]
	var wg sync.WaitGroup

	number_worker := 100
	// http ì „ì†¡ url
	requestURL := argsWithoutProg[0]

	// json íŒŒì¼ ê²½ë¡œ ex) user
	// .json í™•ì¥ì ëª…ì€ ì œì™¸
	jsonReq := argsWithoutProg[1]

	// ì‹¤í–‰íšŸìˆ˜ ì„¤ì •
	transferRatePerSecond, _ := strconv.Atoi(argsWithoutProg[2])

	// JSON íŒŒì¼ ì½ê¸°
	jsonFile, err := os.Open(jsonReq + ".json")
	if err != nil {
		fmt.Println(err)
	}
	defer jsonFile.Close()

	t := http.DefaultTransport.(*http.Transport).Clone()
	t.MaxIdleConns = 10000    // connection pool í¬ê¸°
	t.MaxConnsPerHost = 10000 // í˜¸ìŠ¤íŠ¸ ë³„ ìµœëŒ€ í• ë‹¹ connection
	t.MaxIdleConnsPerHost = 1

	// í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ë° timeout
	client := &http.Client{
		Timeout:   5 * time.Second,
		Transport: t,
	}

	// jsoníŒŒì¼ì„ ë°”ì´íŠ¸ë¡œ ë³€í™˜
	jsonBody, _ := ioutil.ReadAll(jsonFile)

	// ìŠ¤ë ˆë“œ ì‹±í¬ ë§µ
	var contexts = &sync.Map{}

	// ë©€í‹° ìŠ¤ë ˆë“œ http request
	for i := 0; i < number_worker; i++ {
		wg.Add(1)
		go worker(contexts, &wg, requestURL, jsonBody, client, transferRatePerSecond/number_worker, i)
	}

	wg.Wait()

	// ì„±ê³µí•œ http request ê°œìˆ˜ í™•ì¸
	contexts.Range(func(k, v interface{}) bool {
		fmt.Println("status: ", k, " count: ", v)
		return true
	})
}
```

## 10000ê°œ ì¿¼ë¦¬ ì‹¤í–‰ ê²°ê³¼(110ì´ˆ ì†Œìš”)

ê²°ê³¼ë¡œ ë¹ ì§ì—†ì´ ì •ìƒ 200 code ë¥¼ ë°›ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë©°, dbì—ë„ ê°’ì— ì •ìƒì €ì¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

* terminal
```
gyuminhwangbo@Gyuminui-MacBookPro testing % go run main.go 10000
ì‹¤í–‰ì‹œê°„ 110.251228122
status:  200  count:  10000
```

* auth DB

![img](../../../assets/img/spring/db5432_auth.png)

* chat DB

![img](../../../assets/img/spring/db5434_user.png)

* backup DB - chat DB

![img](../../../assets/img/spring/db5433_user.png)

