---
layout: default
title: 모니터링 지표들과 stream 크기 동적 확장을 위한 버스 리프레시 구현(redis pub/sub)
parent: 토스 러너스 하이 2기
date: 2026-01-09
---

* Stream group 별 pending 개수, lag 개수
* XADD/sec, XACK/sec
* consume 처리지연시간(consuming 하는 시점에서 현재시간과 produced 시간대 - 한 지표 쏘기)... 이거 메인 로직에 들어있으면 지연 ++ 되버려서 다른 방법이 필요할 듯?
* oldest pending idle
* reclaim/sec
* deliveryCount p95, p99

consumer group 정리 중 옛날 이름의 consumer group 이 정리되지 않은채로 idle time 이 증가하고있는것을 확인했습니다. 

![](../2026-01-09-19-19-45.png)

자동정리로직에 옛날 consumer 도 전부 쿼리하도록 변경하였고 어느정도는 사라졌지만 그래도 남아있었습니다. 실제로 cli 쿼리해보면 안남아있는데 계속해서 프로메테우스에 등장해서 이유를 확인해보니 [last 상태 이후 5min 간 stale 하다](https://prometheus.io/docs/prometheus/latest/querying/basics/#staleness)고 하네요. 아래는 정상제거된 모습입니다.

![](../2026-01-09-20-29-40.png)

모니터링을 위해 초당 xinfo 나 group 등의 정보를 초당 너무 자주호출하고 있어서 10초 마다 쿼리하도록 변경하였습니다.

![](../2026-01-09-19-52-07.png)

# 설정 값 버스 리프레시 feat. 센트럴 도그마

센트럴 도그마는 설정값들을 라이브에서 변경할 수 있도록 도와주는 라이브러리입니다. maxLen 이나 retrycount 와 같은 메모리에 직접적인 영향을 주는 값들을 빠르게 변경 해야 하기 떄문에 [Line 센트럴 도그마](https://line.github.io/centraldogma/#:~:text=introductory%20slides%3A-,Give%20it%20a%20try!,-Download%20now%20and)에서 영감을 받아서 실시간으로 설정 값을 변경하고싶을 떄 아래와 같이 변경 스위치를 구성하였습니다. 어찌되었든 사내 인프라인 eks, redis, etc. 만으로 써야했고 추가비용은 없어야되서 아래와 같이 셋업하였습니다.

![](../2026-01-09-20-42-55.png)

아래와 같은 값들을 캐싱/evict 하여 사용합니다.

```json
{
  "streamKey": "summary",
  "maxLen": 10000,
  "maxTryCount": 5,
  "retryIntervalMs": 5000,
  "partitionNumbers": 6,
  "delimiter": ":",
  "cdlPostfix": "CDL",
  "cdlRetryCount": 10,
  "cdlRetryIntervalMs": 10000,
  "pollBatchSize": 1,
  "allCdlKeys": [
    "summary:0:CDL",
    "summary:1:CDL",
    "summary:2:CDL",
    "summary:3:CDL",
    "summary:4:CDL",
    "summary:5:CDL"
  ],
  "allStreamKeys": [
    "summary:0",
    "summary:1",
    "summary:2",
    "summary:3",
    "summary:4",
    "summary:5"
  ]
}
```