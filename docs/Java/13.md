---
layout: default
title: Transactional ì™€ Async ì˜ˆì œ ë° íƒêµ¬
parent: ğŸ“Œ Server
nav_order: 13
---

created at 2023-11-03
{: .label .label-yellow }

> JPA ì˜ì†ì„± ìœ ì§€ê¸°ê°„ì„ ê´€ì°°í•˜ê¸° ìœ„í•œ ì—¬ëŸ¬ ì˜ˆì œë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤

1. `@Transaction` ì½”ë“œ ë°–ì—ì„œëŠ” ì˜ì†ì„± ìœ ì§€ê°€ ë˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸

```java
@Override
@Transactional("REQUIRED")
@Async("taskPool")
public CompletableFuture<UserCredential> saveUser(RegisterUserRequest req) {
    checkUserExistOrThrowCustomException(req.getUserId());
    UserCredential user = userCredentialRepository.save(req.toEntity());
    return CompletableFuture.completeFuture(user);
}

@Test
public void changeNameFunctionOutside(){
    userService.saveUser(req)
    .thenApply((user)->{
        user.setUserName("newUserName");
        return user;
    }).thenAccept((user)->{
        UserCredential findUser = userCredentialRepository.findById(user.getUserId()).orElseThrow(new RuntimeException());
        assertThat(findUser.getUserName()).isNotEqualTo("newUserName"); // oldUserName != newUserName 
})
}

```


2. `@Transaction` ì½”ë“œ ë‚´ë¶€ì—ì„œ ì˜ì†ì„± ìœ ì§€ê°€ ë˜ëŠ” ê²ƒì„ í™•ì¸

```java
@Override
@Transactional("REQUIRED")
@Async("taskPool")
public CompletableFuture<UserCredential> saveUser(RegisterUserRequest req) {
    checkUserExistOrThrowCustomException(req.getUserId());
    UserCredential user = userCredentialRepository.save(req.toEntity());
    return CompletableFuture.supplyAsync(()->{
        user.setUserName("newUserName"); // ë‚´ë¶€ë¡œ ë³€ê²½
        return user;
    });
}

@Test
public void changeNameFunctionOutside(){
    userService.saveUser(req)
    .thenAccept((user)->{
        UserCredential findUser = userCredentialRepository.findById(user.getUserId()).orElseThrow(new RuntimeException());
        assertThat(findUser.getUserName()).isEqualTo("newUserName"); // oldUserName => newUserName == newUserName 
    })
}

```

ì´ë¥¼ í†µí•´ ë°”ë€ ìƒê°ì€ ì•„ë˜ì™€ ê°™ì•„ìš”.

* ê¸°ì¡´

Transactionì€ ThreadLocal í•˜ê²Œ ì„¤ì •ë˜ë©° @Transactional ë¡œ ì„¤ì • ì‹œ, Thread ê°€ callback í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì— commit ë˜ëŠ” ê²ƒìœ¼ë¡œ ì•Œê³ ìˆì—ˆìŠµë‹ˆë‹¤. ì¦‰, @Transactional ì´ ì„ ì–¸ëœ í•¨ìˆ˜ ë‚´ì—ì„œ thenApply ì™€ ê°™ì€ callback í•¨ìˆ˜ê°€ í˜¸ì¶œ ë˜ì–´ë„ ì—”í‹°í‹°ëŠ” Detached ëœ ìƒíƒœì´ë¯€ë¡œ ë³€ê²½ë˜ì§€ ì•Šì„ê²ƒì´ë¼ê³  íŒë‹¨í–ˆì–´ìš”.

* ë³€ê²½

@Transactional ë¡œ ì„¤ì • ì‹œ, `í•¨ìˆ˜` ê°€ Stack ì—ì„œ ë¹ ì§€ëŠ” ì‹œì ì— commit ì´ ì´ë£¨ì–´ì§€ëŠ”ê²ƒì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤. ì¦‰, í•¨ìˆ˜ ë‚´ë¶€ì—ì„œëŠ” ThreadLocal í•˜ë‹¤ë©´ ì–´ë–¤ ê²ƒì´ë“  íŠ¸ëœì­ì…˜ì— ë‹´ê¸¸ ê²ƒì´ê³  ì™¸ë¶€ì—ì„œëŠ” Detached ëœ ì—”í‹°í‹°ë¥¼ ë°˜í™˜ë°›ëŠ”ê²ƒì„ í™•ì¸í–ˆì–´ìš”.

> * [https://chat.openai.com/share/05b696fa-3e8b-418a-ab46-c9d42e67ac56](https://chat.openai.com/share/05b696fa-3e8b-418a-ab46-c9d42e67ac56)