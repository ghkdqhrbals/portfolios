---
layout: default
title: WebFlux(Reactive Programming)
parent: ğŸ“Œ Server
date: 2023-04-05
nav_order: 5
---

## 1. WebFlux í•œì¤„ ì •ì˜
WebFluxëŠ” Reactive Programming ì„ í¸í•˜ê²Œ ì‚¬ìš©ê°€ëŠ¥í•˜ê²Œí•˜ëŠ” Spring ì œê³µ ê°ì²´ë¡œ, Pub/Sub ë°©ì‹ìœ¼ë¡œ ì´ë²¤íŠ¸ ë©”ì„¸ì§€ë¥¼ ì£¼ê³ ë°›ìŠµë‹ˆë‹¤.
> Reactive Programming : ë°ì´í„° ìŠ¤íŠ¸ë¦¼ê³¼ ë³€ê²½ ì‚¬í•­ ì „íŒŒë¥¼ ì¤‘ì‹¬ìœ¼ë¡œí•˜ëŠ” **ë¹„ë™ê¸°** í”„ë¡œê·¸ë˜ë° íŒ¨ëŸ¬ë‹¤ì„ì…ë‹ˆë‹¤.

## 2. WebFlux + Future ì˜ˆì‹œ
## 2-1. CODE
```java
void multiThreadSink(){
    // Sinks ê°ì²´ë¥¼ í†µí•´ Fluxë¥¼ ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ì ‘ê·¼ê°€ëŠ¥í•©ë‹ˆë‹¤.
    // Sinks.many().replay().all() = sinkì˜ fluxì— ì‹ ê·œ êµ¬ë…ì ì¶”ê°€ë˜ë©´, ì´ì „ ë©”ì„¸ì§€ë“¤ ì „ë¶€ ë‚ ë ¤ì¤ë‹ˆë‹¤.
    Sinks.Many<Object> sinks = Sinks.many().replay().all();
    ThreadPoolTaskExecutor t = getThreadPoolTaskExecutor();
    
    // í“¨ì²˜ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¡œ sinksì˜ í†µí•© fluxë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.
    CompletableFuture<String> cf1 = CompletableFuture.supplyAsync(() -> {
        sinks.asFlux().log().subscribe(c -> {
            logger.debug("SUBSCRIBE-task-2: "+c);
            // ê²°ê³¼(ë³¸ ìŠ¤ë ˆë“œê°€ ì´ì „ ë©”ì„¸ì§€ ì •ë³´ë“¤ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤)
            // SUBSCRIBE-task-2: First <- task-1 ìŠ¤ë ˆë“œ
            // SUBSCRIBE-task-2: Thrid <- task-1 ìŠ¤ë ˆë“œ
            // ë³„ë„ì˜ ë¹„ë™ê¸° ìŠ¤ë ˆë“œì´ê¸° ë•Œë¬¸ì—, First/Thrid ë‘˜ ë‹¤ ì—†ì„ ìˆ˜ë„ ìˆì–´ìš”
        });
        return "Completed";
    },t);
    logger.info("emit 1 start");
    sinks.tryEmitNext("First");
    logger.info("emit 1 end");
    

    // í“¨ì²˜ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¡œ sinksì˜ í†µí•© fluxë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.
    CompletableFuture<String> cf2 = CompletableFuture.supplyAsync(() -> {
        Flux<Object> flux = sinks.asFlux();
        flux.log().subscribe(c -> {
            logger.debug("SUBSCRIBE-task-3: "+c);
            // ê²°ê³¼(ë³¸ ìŠ¤ë ˆë“œê°€ ì´ì „ ë©”ì„¸ì§€ ì •ë³´ë“¤ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤)
            // SUBSCRIBE-task-3: First <- task-2 ìŠ¤ë ˆë“œ
            // SUBSCRIBE-task-3: Thrid <- task-2 ìŠ¤ë ˆë“œ
            // ë³„ë„ì˜ ë¹„ë™ê¸° ìŠ¤ë ˆë“œì´ê¸° ë•Œë¬¸ì—, First/Thrid ë‘˜ ë‹¤ ì—†ì„ ìˆ˜ë„ ìˆì–´ìš”
        });
        
        // ì´ ë•Œ, ì¶”ê°€ì ìœ¼ë¡œ ìŠ¤ë ˆë“œ ë‚´ë¶€ì—ì„œ sinksì— "Second" ë©”ì„¸ì§€ë¥¼ Publish í•´ë³¼ê²Œìš”
        logger.info("emit 2 start");
        sinks.tryEmitNext("Second"); 
        logger.info("emit 2 end");
        // ê²°ê³¼(í˜„ì¬ sinkì˜ flux ë¥¼ subscribeí•˜ëŠ” êµ¬ë…ìë“¤ì—ê²Œ ì§ì ‘ ë³¸ ìŠ¤ë ˆë“œê°€ publishing)
        // SUBSCRIBE-task-1: Second <- task-2 ìŠ¤ë ˆë“œ
        // SUBSCRIBE-task-2: Second <- task-2 ìŠ¤ë ˆë“œ
        // SUBSCRIBE-task-3: Second <- task-2 ìŠ¤ë ˆë“œ
        return "Completed";
    },t);
    logger.info("emit 3 start");
    sinks.tryEmitNext("Third");
    logger.info("emit 3 end");
    sinks.asFlux().subscribe(str->{
        logger.info("SUBSCRIBE-task-1: "+(String) str);
    });

    try {
        String s1 = cf1.get();
        String s2 = cf2.get();
        logger.info("emit 4 start");
        sinks.tryEmitNext("Forth");
        logger.info("emit 4 end");
        // ê²°ê³¼(í˜„ì¬ sinkì˜ flux ë¥¼ subscribeí•˜ëŠ” êµ¬ë…ìë“¤ì—ê²Œ ì§ì ‘ ë³¸ ìŠ¤ë ˆë“œê°€ publishing)
        // SUBSCRIBE-task-1: Forth <- main ìŠ¤ë ˆë“œ
        // SUBSCRIBE-task-2: Forth <- main ìŠ¤ë ˆë“œ
        // SUBSCRIBE-task-3: Forth <- main ìŠ¤ë ˆë“œ
    } catch (InterruptedException e) {throw new RuntimeException(e);} 
    catch (ExecutionException e) {throw new RuntimeException(e);}
}


// ìŠ¤ë ˆë“œ í’€ ì„¤ì •
@NotNull
private static ThreadPoolTaskExecutor getThreadPoolTaskExecutor() {
    ThreadPoolTaskExecutor t = new ThreadPoolTaskExecutor();
    t.setCorePoolSize(5);
    t.setMaxPoolSize(10);
    t.setQueueCapacity(10);
    t.setThreadNamePrefix("task-");
    t.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
    t.setWaitForTasksToCompleteOnShutdown(true);
    t.initialize();
    return t;
}
```

## 2-2. RESULTS

```
17:41:21.723 [Test worker] INFO com.example.shopuserservice.FluxTest -- emit 1 start
17:41:21.724 [Test worker] INFO com.example.shopuserservice.FluxTest -- emit 1 end
17:41:21.725 [Test worker] INFO com.example.shopuserservice.FluxTest -- emit 3 start
17:41:21.725 [Test worker] INFO com.example.shopuserservice.FluxTest -- emit 3 end
17:41:21.734 [Test worker] INFO com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-1: First
17:41:21.734 [Test worker] INFO com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-1: Third

# task-1, task-2 ìŠ¤ë ˆë“œ Sinksì˜ Flux êµ¬ë…ì‹œì‘
# ì´ì „ Sinksì— ì„¤ì •í•œ replay().all() ë¡œ ì¸í•´ task-1,task-2ëŠ” ì´ì „ ë©”ì„¸ì§€ë¥¼ ì „ë¶€ ê°€ì ¸ì˜µë‹ˆë‹¤
# replay().all(int number_of_gets)ë¡œ ë°”ê¿”ì£¼ë©´, ë³µì‚¬í•˜ëŠ” ë©”ì„¸ì§€ì˜ ê°œìˆ˜ë¥¼ ì •í•  ìˆ˜ ìˆì–´ìš”
17:41:21.735 [task-1] INFO reactor.Flux.SinkManyReplayProcessor.1 -- | onSubscribe([Fuseable] SinkManyReplayProcessor.ReplayInner)
17:41:21.735 [task-2] INFO reactor.Flux.SinkManyReplayProcessor.2 -- | onSubscribe([Fuseable] SinkManyReplayProcessor.ReplayInner)
17:41:21.739 [task-2] INFO reactor.Flux.SinkManyReplayProcessor.2 -- | request(unbounded)
17:41:21.739 [task-1] INFO reactor.Flux.SinkManyReplayProcessor.1 -- | request(unbounded)
17:41:21.740 [task-1] INFO reactor.Flux.SinkManyReplayProcessor.1 -- | onNext(First)
17:41:21.740 [task-1] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-2: First
17:41:21.740 [task-2] INFO reactor.Flux.SinkManyReplayProcessor.2 -- | onNext(First)
17:41:21.740 [task-1] INFO reactor.Flux.SinkManyReplayProcessor.1 -- | onNext(Third)
17:41:21.740 [task-1] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-2: Third
17:41:21.740 [task-2] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-3: First
17:41:21.741 [task-2] INFO reactor.Flux.SinkManyReplayProcessor.2 -- | onNext(Third)
Completed
17:41:21.741 [task-2] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-3: Third

# task-2 ìŠ¤ë ˆë“œì—ì„œ sinksì— "Second" ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ê³ , Subscribersì—ê²Œ ë°°ë‹¬í•©ë‹ˆë‹¤.
17:41:21.741 [task-2] INFO com.example.shopuserservice.FluxTest -- emit 2 start
17:41:21.741 [task-2] INFO com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-1: Second
17:41:21.741 [task-2] INFO reactor.Flux.SinkManyReplayProcessor.1 -- | onNext(Second)
17:41:21.741 [task-2] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-2: Second
17:41:21.741 [task-2] INFO reactor.Flux.SinkManyReplayProcessor.2 -- | onNext(Second)
17:41:21.741 [task-2] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-3: Second
17:41:21.741 [task-2] INFO com.example.shopuserservice.FluxTest -- emit 2 end
Completed

# main ìŠ¤ë ˆë“œì—ì„œ sinksì—ê²Œ "Forth" ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ê³ , SubScribersì—ê²Œ ë°°ë‹¬í•©ë‹ˆë‹¤.
17:41:21.742 [Test worker] INFO com.example.shopuserservice.FluxTest -- emit 4 start
17:41:21.742 [Test worker] INFO com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-1: Forth
17:41:21.742 [Test worker] INFO reactor.Flux.SinkManyReplayProcessor.1 -- | onNext(Forth)
17:41:21.742 [Test worker] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-2: Forth
17:41:21.742 [Test worker] INFO reactor.Flux.SinkManyReplayProcessor.2 -- | onNext(Forth)
17:41:21.742 [Test worker] DEBUG com.example.shopuserservice.FluxTest -- SUBSCRIBE-task-3: Forth
17:41:21.743 [Test worker] INFO com.example.shopuserservice.FluxTest -- emit 4 end
```

## 3. Sinks ë©”ì†Œë“œ
* **many().multicast()**: a sink that will transmit only **newly pushed data** to its subscribers, honoring their backpressure (newly pushed as in "after the subscriber's subscription").
* **many().unicast()**: same as above, with the twist that data pushed before the first subscriber registers is buffered.
* **many().replay()**: a sink that will replay a specified history size of pushed data to new subscribers then continue pushing new data live.


## 4. Bifunction Webflux
## 4-1. CODE
```java
void bifunction(){
    Flux<String> flux = Flux.generate(
            () -> 0, // ì´ˆê¸° ê°ì²´ ì„¸íŒ…
            (state, sink) -> {
                sink.next("3 x " + state + " = " + 3*state); // sinks.onNext() í˜¸ì¶œ
                if (state == 10) sink.complete(); // sinks.onComplete() í˜¸ì¶œ
                return state + 1;
            });
            
    CompletableFuture cf = CompletableFuture.runAsync(() -> {
        flux.log().subscribe(str -> {
            System.out.println(str);
        });
    });
    flux.log().subscribe(s->{
        System.out.println(s);
    });
}
}
```
## 4-2. RESULTS
```
18:36:06.283 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onSubscribe([Fuseable] FluxGenerate.GenerateSubscription)
18:36:06.283 [Test worker] INFO reactor.Flux.Generate.1 -- | onSubscribe([Fuseable] FluxGenerate.GenerateSubscription)
18:36:06.286 [Test worker] INFO reactor.Flux.Generate.1 -- | request(unbounded)
18:36:06.286 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | request(unbounded)
18:36:06.292 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 0 = 0)
18:36:06.292 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 0 = 0)
3 x 0 = 0
3 x 0 = 0
18:36:06.293 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 1 = 3)
3 x 1 = 3
18:36:06.293 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 1 = 3)
3 x 1 = 3
18:36:06.293 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 2 = 6)
3 x 2 = 6
18:36:06.294 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 2 = 6)
18:36:06.294 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 3 = 9)
3 x 2 = 6
3 x 3 = 9
18:36:06.294 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 3 = 9)
3 x 3 = 9
18:36:06.294 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 4 = 12)
3 x 4 = 12
18:36:06.294 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 4 = 12)
18:36:06.294 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 5 = 15)
3 x 4 = 12
3 x 5 = 15
18:36:06.294 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 5 = 15)
18:36:06.294 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 6 = 18)
3 x 5 = 15
3 x 6 = 18
18:36:06.294 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 6 = 18)
3 x 6 = 18
18:36:06.295 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 7 = 21)
3 x 7 = 21
18:36:06.295 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 7 = 21)
3 x 7 = 21
18:36:06.295 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 8 = 24)
18:36:06.295 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 8 = 24)
3 x 8 = 24
3 x 8 = 24
18:36:06.295 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 9 = 27)
18:36:06.295 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 9 = 27)
3 x 9 = 27
3 x 9 = 27
18:36:06.295 [Test worker] INFO reactor.Flux.Generate.1 -- | onNext(3 x 10 = 30)
3 x 10 = 30
18:36:06.295 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onNext(3 x 10 = 30)
3 x 10 = 30
18:36:06.296 [Test worker] INFO reactor.Flux.Generate.1 -- | onComplete()
18:36:06.296 [ForkJoinPool.commonPool-worker-1] INFO reactor.Flux.Generate.2 -- | onComplete()
```

