---
layout: default
title: Mysql - Redis stream - Mongodb CDC + ETL setup
date: 2025-08-16
parent: ğŸ“Œ Server
---

# Intro

ê¸°ì¡´ì— ì €í¬ëŠ” Mysql ë¥¼ main db ë¡œ, ë©€í‹°í”„ë Œì°¨ì´ì¦ˆë¥¼ ëª©í‘œë¡œ ìš´ì˜í•˜ë‹¤ë³´ë‹ˆ ì—¬ëŸ¬ ë‹¤ì–‘í•œ ìŠ¤í‚¤ë§ˆë“¤ì´ í•„ìš”í–ˆê³  ì´ë¥¼ ìœ„í•œ Mongodb ë¥¼ secondary db ë¡œ ìš´ì˜í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì‹ ê·œ í”¼ì²˜ë¡œ ëŒ€ëŸ‰ì˜ íšŒì›ì¶”ì¶œì„ ì§„í–‰í•˜ê¸° ìœ„í•´ mysql slave ë¥¼ ë³´ëŠ” ê²ƒì´ ì•„ë‹Œ, cdc ë¥¼ í†µí•´ì„œ Mongodb ì— íšŒì›ì •ë³´ë¥¼ upsert í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ì—¬ëŸ¬ê°€ì§€ ì¡°ê±´ë“¤ì˜ í…Œì´ë¸”ì„ ë‹¨ì¼ docs ë¡œ í•©ì¹˜ê²Œ ëœë‹¤ë©´ mysql ì—ì„œ ì²˜ëŸ¼ join êµ³ì´ ì•ˆí•´ë„ ë˜ê¸°ë•Œë¬¸ì— ë¹ ë¥´ê²Œ ì¡°íšŒê°€ ê°€ëŠ¥í•´ ì§‘ë‹ˆë‹¤.

ê·¸ë˜ì„œ Debezium server ì„ ì‚¬ìš©í•˜ì—¬ Mysql binlog ë¥¼ cdc í•˜ê³ , ì´ë¥¼ Redis Stream ìœ¼ë¡œ ë³´ë‚´ê³ , ë³„ë„ sink pod ì—ì„œ Redis Stream í•´ë‹¹ í† í”½ ì½ê³  Mongodb ì— upsert í•˜ëŠ” êµ¬ì¡°ë¡œ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. 

ì´ ê³¼ì •ì„ ì •ë¦¬ë˜ì§€ ì•Šì€ ê¸°ë¡ìœ¼ë¡œ ìš°ì„  ë‚¨ê¹ë‹ˆë‹¤.


# Debezium Server CDC

- kafka ì—†ì´ ì¼ë°˜ debezium server ë¡œ ì§„í–‰
    - reference: [https://debezium.io/documentation/reference/3.2](https://debezium.io/documentation/reference/3.2/)
    - https://debezium.io/documentation/reference/stable/operations/debezium-server.html    
    > ~~ê³µì‹ë¬¸ì„œì—ì„œ ë³´ë©´ debezium.sink.type ì„¤ì •ì´ aws í‚¤ë„¤ì‹œìŠ¤ë°–ì— ì—†ì–´ì„œ ë‹¤ë¥¸ê±° í™•ì¸ ì¤‘â€¦ stream ì„ ê¼­ ì¨ì•¼í•˜ë‚˜? kafka ë§ê³  redis stream ë„ ì§€ì›í•˜ê¸´ í•˜ëŠ”ë° source/sink ê°€ stream -> mongodb ìˆëŠ”ì§€ ë´ì•¼í•¨.~~
* **kafka stream â†’ mongodb sink connector ì€ ìˆê³  redis stream â†’ mongodb sink connector ì€ ì—†ìŒ... ë³„ë„ì˜ pod ë¥¼ ë„ì›Œì„œ redis stream key ì½ê³  mongodb ì— upsert í•˜ëŠ” ë¡œì§ì„ ì‘ì„±í•´ì•¼í•  ê²ƒ ê°™ë‹¤.**
- [https://tech.kakaopay.com/post/kakaopaysec-mongodb-cdc/#4-consumer-group-ìƒì„±-ë°-offset-ì„¤ì •](https://tech.kakaopay.com/post/kakaopaysec-mongodb-cdc/#4-consumer-group-%EC%83%9D%EC%84%B1-%EB%B0%8F-offset-%EC%84%A4%EC%A0%95) ì¹´ì¹´ì˜¤í˜ì´ì—ì„œëŠ” kafka sink connector ì‚¬ìš©í•¨. ìš°ë¦¬ëŠ” redis stream ì“°ê¸°ë•Œë¬¸ì— ë³„ë„ë¡œ ë§Œë“¤ì–´ì•¼í•¨.



* debezium server â†’ redis stream ì„¤ì •ê°’ ê³µì‹ reference
    * https://debezium.io/documentation/reference/2.7/operations/debezium-server.html#_redis_stream

* django í†µí•´ì„œ postgresql â†’ mongodb ì§ì ‘ sink í•œ ì˜¤í”ˆì†ŒìŠ¤. ê³µì‹ìœ¼ë¡œ ì§€ì›í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ê·¸ëƒ¥ ì°¸ê³ ìš©. [https://github.com/maqboolthoufeeq/cdc_debezium](https://github.com/maqboolthoufeeq/cdc_debezium)
    * https://dev.to/maqboolthoufeeq/change-data-capture-cdc-with-debezium-server-no-kafka-django-postgres-mongodb-example-m0h

# Debezium Server

- Mysql â†’ Debezium Server â†’ Stream ì˜ í”„ë¡œì„¸ìŠ¤ ì†Œê°œ
1. Snapshots
    - Debezium Server ê°€ ë™ì‘í•  ë•Œ í˜„ì¬ SQL server ìƒíƒœì˜ ìŠ¤ëƒ…ìƒ·ì„ ì°ìŒ. defaultê°€ INITIAL
        - recovery, custom, initial_only, etc.
    - ê·¸ë˜ì„œ ì–´ëŠ í…Œì´ë¸”ì„ Capture í• ê±°ì•¼? ì •í•  ìˆ˜ ìˆìŒ. [`table.include.list`](https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#sqlserver-property-table-include-list) íŒŒë¼ë¯¸í„° ê°’ìœ¼ë¡œ
- insert sql í…ŒìŠ¤íŠ¸. insert í›„ 1 ì¦ê°€ í™•ì¸
    - ghkdqhrbals@ip-172-30-1-90 debezium-server % redis-cli --json XREVRANGE mysql_sink.gyumin.users + - COUNT 1 \
    | jq -r '.[0][1][1] | fromjson | .payload.after.id'
    **30001**
    ghkdqhrbals@ip-172-30-1-90 debezium-server % redis-cli --json XREVRANGE mysql_sink.gyumin.users + - COUNT 1 \
    | jq -r '.[0][1][1] | fromjson | .payload.after.id'
    **30002**
- í˜ì´ë¡œë“œ í™•ì¸
    - payload(insert ëŠ” before ì—†ê³  update ëŠ” before ì¡´ì¬. + db & table ë¬¶ê³  ë¶„ê¸°í•˜ì—¬ mongodb upsert í•˜ë©´ ë  ë“¯)
    - payload
        
        ```json
        ...
        "payload": {
            "before": null,
            "after": {
              "id": 30002,
              "name": "í…ŒìŠ¤íŠ¸ìš© ìœ ì €",
              // ...
            },
            "source": {
              "version": "3.2.0.Final",
              "connector": "mysql",
              "name": "mysql_sink",
              "ts_ms": 1755138551000,
              "snapshot": "false", // ì´ê±°ëŠ” initial ë‹¨ê³„ì—ì„œ ì¶”ê°€ëœ ê²Œ ì•„ë‹ˆë¼ ì´í›„ cdc í•œê±°ì„.
              "db": "gyumin",
              "sequence": null,
              "ts_us": 1755138551000000,
              "ts_ns": 1755138551000000000,
              "table": "users",
              "server_id": 1,
              "gtid": null,
              "file": "binlog.000002",
              "pos": 7114433,
              "row": 0,
              "thread": 385,
              "query": null
            },
            "transaction": null,
            "op": "c", // c(insert). u(update), d(delete), r(read), t(truncate)
            // ì´ˆê¸°ì— db ì½ì–´ì™€ì„œ redis stream ë¡œë“œì‹œí‚¬ ë–„ r ë¡œ ë“¤ì–´ê°.
            "ts_ms": 1755138551799,
            "ts_us": 1755138551799549,
            "ts_ns": 1755138551799549000
          }
        ```
        

- source binload ì„¸íŒ…
    
    ```json
    // source binload ì„¸íŒ…
    "source": {
      "version": "3.2.0.Final",         // 2025.08.17 ì— stable í•œ ìµœì‹  ë²„ì „ì„. 
      "connector": "mysql",              
      "name": "mysql_sink",              
      "ts_ms": 1755138551000,            // ì†ŒìŠ¤ ì´ë²¤íŠ¸ ì‹œê°(ms). MySQLì˜ binlog ì´ë²¤íŠ¸ íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜
      "snapshot": "false",               // ìŠ¤ëƒ…ìƒ· ì—¬ë¶€: true(ê¸°ì¡´ db ì— ìˆë˜ rows ì½ì–´ì˜¬ ë•Œ), false(ì‹¤ì‹œê°„ cdc)
      "db": "gyumin",                  
      "sequence": null,                  
      "ts_us": 1755138551000000,         // binlog í•´ë‹¹ ì´ë²¤íŠ¸ ì‹œê°„
      "ts_ns": 1755138551000000000,      
      "table": "users",                  // cdc í•œ í…Œì´ë¸”
      "server_id": 1,                    // mysql server id. ì´ê±° ê°’ì„ config ì—ì„œ ìš°ë¦¬ê°€ ì„¤ì •ê°€ëŠ¥
      "gtid": null,                      // GTID ëª¨ë“œ ì‚¬ìš© ì‹œ í•´ë‹¹ íŠ¸ëœì­ì…˜ì˜ GTID. ë¹„í™œì„±í™”ë©´ null
      "file": "binlog.000002",           // ì´ë²¤íŠ¸ë¥¼ ë‹´ê³  ìˆëŠ” binlog íŒŒì¼ëª…
      "pos": 7114433,                    // ìœ„ binlog íŒŒì¼ ë‚´ ì˜¤í”„ì…‹. debezium server ì¬ì‹œì‘í•˜ë©´ ì—¬ê¸°ì„œë¶€í„° ë‹¤ì‹œ cdc í•¨.
      "row": 0,                          // insert values 2ê°œë©´ row 0, 1 ë¡œ ë‚˜ë‰¨.
      "thread": 385,                     // mysql db ì„¸ì…˜ì˜ id
      "query": null                      // ddl ì¿¼ë¦¬. dml ì—ì„œëŠ” null ë¡œ í‘œì‹œí•¨. ì´ê±°ëŠ” insert í•œê±°ë¼ null
    }
    ```
    

- update ì‹œ í˜ì´ë¡œë“œ ì²´í¬.
    
    > ì „ì²´ row ë³€ê²½ì ì´ ê¸°ë¡ë˜ê¸°ë•Œë¬¸ì— upsert ì¹˜ê¸° ì¢‹ê¸´ í•¨. ë³€ê²½ëœ ë¶€ë¶„ë§Œ binlog ì— ê¸°ë¡ë˜ëŠ”ê²Œ ì•„ë‹Œ. mysql ì—ì„  `SHOW VARIABLES LIKE 'binlog_row_image';` ì´ê±° FULL ì´ë©´ ì „/í›„ row ë³€ê²½ì ì„ ë‹¤ ê¸°ë¡í•¨. postgresql ì—ì„œëŠ” wal_level=logical ì´ë‘ ë¹„ìŠ·í•¨.
    > 
    > 
    > ```json
    >   "payload": {
    >     "before": {
    >       "id": 30000,
    >       "name": "í…ŒìŠ¤íŠ¸ìš©",
    >       // ...
    >     },
    >     "after": {
    >       "id": 30000,
    >       "name": "í…ŒìŠ¤íŠ¸ìš© ë³€ê²½",
    >       // ...
    >     }
    > ```
    > 

- binlog ì˜¤í”„ì…‹ ì²´í¬ `HGETALL metadata:debezium:offsets`

    `{  "ts_sec": 1755155084,  "file": "binlog.000002",  "pos": 7117146}`
    

> ì„¤ì • reference : https://redis.io/docs/latest/integrate/write-behind/reference/debezium/mysql/

```yaml
# SINK SETTINTGS
debezium.sink.type=redis
debezium.sink.redis.address=localhost:6379
debezium.sink.redis.db.index=0

# SOURCE SETTINGS
# reference=https://redis.io/docs/latest/integrate/write-behind/reference/debezium/mysql/
debezium.source.connector.class=io.debezium.connector.mysql.MySqlConnector
debezium.source.database.server.id=111
debezium.source.database.dbname=gyumin
debezium.source.database.hostname=localhost
debezium.source.database.port=3306
debezium.source.database.user=root
# debezium.source.databbase.password=
debezium.source.snapshot.mode=initial
# <DB_NAME>.<TABLE_NAME> ìœ¼ë¡œ í…Œì´ë¸” ì§€ì •í•¨. ê·¸ë¦¬ê³  ì•„ë˜ ë¼ì¸ regex ì ìš©ìœ¼ë¡œ ',' separate ì‹œí‚¤ê¸°ë•Œë¬¸ì— í•´ë‹¹ ë¼ì¸ ì˜†ì— ì£¼ì„ ì¶”ê°€í•˜ë©´ ë¯¸ë™ì‘.
debezium.source.table.include.list=gyumin.orders,gyumin.users

# ì´ê±´ column.include ì˜µì…˜ìœ¼ë¡œ ì¹¼ëŸ¼ë‹¨ìœ„ cdc í•  ë•Œ ì‚¬ìš©. ì§€ê¸ˆì€ table ë‹¨ìœ„ ì „ì²´ cdc ë³´ê¸°ë•Œë¬¸ì— í•´ë‹¹ ì„¤ì •ê°’ ë¯¸í•„ìš”.
debezium.source.skip.messages.without.change=true
# binlogs nì´ˆ ì£¼ê¸°ë¡œ ì½ì–´ì™€ì„œ redis stream ì— ë°€ì–´ë„£ìŒ. 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì˜¤ìë§ˆì ë„£ëŠ”ê±°
debezium.source.offset.flush.interval.ms=1000
# ì–´ë””ê¹Œì§€ binlog sink ë˜ì—ˆëŠ”ì§€ëŠ” redis ì— ì €ì¥í•˜ë„ë¡ í•¨
debezium.source.offset.storage=io.debezium.storage.redis.offset.RedisOffsetBackingStore
# <prefix>.<dbName>.<tableName> key ë¡œ stream ì— ìŒ“ì„
debezium.source.topic.prefix=cdc
# cdc í• ë ¤ëŠ” í…Œì´ë¸”ì˜ ddl ì´ë ¥ì„ ì €ì¥í•¨
debezium.source.schema.history.internal=io.debezium.storage.redis.history.RedisSchemaHistory
```

### Mysql datetime to millis ì•Œê³ ìˆì–´ì•¼í•¨.

> reference : https://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-temporal-types
`DATETIME`Â with a value ofÂ `2018-06-20 06:37:03`Â becomesÂ `1529476623000`.

ì •ìƒë™ì‘ í™•ì¸ë˜ì—ˆìœ¼ë‹ˆ í•´ë‹¹ ê±´ ë„ì»¤ë¼ì´ì§• í›„ ì™¸ë¶€ í™˜ê²½ë³€ìˆ˜ secret ì„¸íŒ…ê³¼ pod ë¡œ ë¡œë“œí•˜ëŠ” cicd íŒŒì´í”„ë¼ì¸ ë° ëª¨ë‹ˆí„°ë§ ì„¤ì • í•„ìš”!

# ETL

ì—”í‹°í‹° ë§Œë“¤ê³  ë³€í™˜ì‹œí‚¤ëŠ” ë¡œì§ ì¶”ê°€ì¤‘.