---
layout: default
title: Mysql - Redis stream - Mongodb CDC + ETL setup
date: 2025-09-16
parent: ğŸ“Œ Server
---

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

# 1. Intro

ê¸°ì¡´ì— ì €í¬ëŠ” Mysql ë¥¼ main db ë¡œ, ë©€í‹°í”„ë Œì°¨ì´ì¦ˆë¥¼ ëª©í‘œë¡œ ìš´ì˜í•˜ë‹¤ë³´ë‹ˆ ì—¬ëŸ¬ ë‹¤ì–‘í•œ ìŠ¤í‚¤ë§ˆë“¤ì´ í•„ìš”í–ˆê³  ì´ë¥¼ ìœ„í•œ Mongodb ë¥¼ secondary db ë¡œ ìš´ì˜í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì‹ ê·œ í”¼ì²˜ë¡œ ëŒ€ëŸ‰ì˜ íšŒì›ì¶”ì¶œì„ ì§„í–‰í•˜ê¸° ìœ„í•´ mysql slave ë¥¼ ë³´ëŠ” ê²ƒì´ ì•„ë‹Œ, cdc ë¥¼ í†µí•´ì„œ Mongodb ì— íšŒì›ì •ë³´ë¥¼ upsert í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ì—¬ëŸ¬ê°€ì§€ ì¡°ê±´ë“¤ì˜ í…Œì´ë¸”ì„ ë‹¨ì¼ docs ë¡œ í•©ì¹˜ê²Œ ëœë‹¤ë©´ mysql ì—ì„œ ì²˜ëŸ¼ join êµ³ì´ ì•ˆí•´ë„ ë˜ê¸°ë•Œë¬¸ì— ë¹ ë¥´ê²Œ ì¡°íšŒê°€ ê°€ëŠ¥í•´ ì§‘ë‹ˆë‹¤.

ê·¸ë˜ì„œ Debezium server ì„ ì‚¬ìš©í•˜ì—¬ Mysql binlog ë¥¼ cdc í•˜ê³ , ì´ë¥¼ Redis Stream ìœ¼ë¡œ ë³´ë‚´ê³ , ë³„ë„ sink pod ì—ì„œ Redis Stream í•´ë‹¹ í† í”½ ì½ê³  Mongodb ì— upsert í•˜ëŠ” êµ¬ì¡°ë¡œ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. 

| [OLAP](https://en.wikipedia.org/wiki/Online_analytical_processing) ì—ëŠ” [https://medium.com/@simeon.emanuilov/mongodb-vs-clickhouse-for-olap-1e430a40ade8](https://medium.com/@simeon.emanuilov/mongodb-vs-clickhouse-for-olap-1e430a40ade8) ClickHouse ê°€ Big Data Query ì— ì¢€ ë” ì¢‹ë‹¤ê³ ëŠ” í•˜ë„¤ìš”. ì˜ˆë¡œ createdAt ê°™ì€ ì¹¼ëŸ¼ì„ ìƒëŒ€ë¡œ 10ì›” ë°ì´í„° ì¡°íšŒí•˜ë©´ ClickHouse ê°€ ë” ë¹ ë¥´ë‹¤ë„¤ìš”.

ì´ ê³¼ì •ì„ ì •ë¦¬ë˜ì§€ ì•Šì€ ê¸°ë¡ìœ¼ë¡œ ìš°ì„  ë‚¨ê¹ë‹ˆë‹¤.


# 2. Debezium Server CDC ê°œìš”

## 2.1. ì•„í‚¤í…ì²˜ ì„ íƒ

- **Kafka ì—†ì´ ì¼ë°˜ Debezium Serverë¡œ ì§„í–‰**
    - Reference: [Debezium 3.2 Documentation](https://debezium.io/documentation/reference/3.2/)
    - [Debezium Server Operations](https://debezium.io/documentation/reference/stable/operations/debezium-server.html)

## 2.2. Sink Connector í•œê³„ì  ë° í•´ê²°ë°©ì•ˆ

### ë¬¸ì œì  ë¶„ì„
- **Kafka Stream â†’ MongoDB Sink Connector**: âœ… ê³µì‹ ì§€ì›
- **Redis Stream â†’ MongoDB Sink Connector**: âŒ ê³µì‹ ë¯¸ì§€ì›

### í•´ê²°ë°©ì•ˆ
ë³„ë„ì˜ Sink Podë¥¼ êµ¬í˜„í•˜ì—¬ Redis Stream ë©”ì‹œì§€ë¥¼ ì½ê³  MongoDBì— upsertí•˜ëŠ” ë¡œì§ ê°œë°œ í•„ìš”

### ì°¸ê³  ìë£Œ
- [ì¹´ì¹´ì˜¤í˜ì´ MongoDB CDC êµ¬í˜„ì‚¬ë¡€](https://tech.kakaopay.com/post/kakaopaysec-mongodb-cdc/#4-consumer-group-ìƒì„±-ë°-offset-ì„¤ì •) - Kafka Sink Connector ì‚¬ìš©
- [Debezium Server â†’ Redis Stream ê³µì‹ ê°€ì´ë“œ](https://debezium.io/documentation/reference/2.7/operations/debezium-server.html#_redis_stream)
- [PostgreSQL â†’ MongoDB CDC ì˜¤í”ˆì†ŒìŠ¤ ì°¸ê³ ](https://github.com/maqboolthoufeeq/cdc_debezium) - Django ê¸°ë°˜ êµ¬í˜„ì²´

## 2.3. CDC í”„ë¡œì„¸ìŠ¤ íë¦„

### MySQL â†’ Debezium Server â†’ Redis Stream ë°ì´í„° í”Œë¡œìš°

```mermaid
graph LR
    A[MySQL Binlog] --> B[Debezium Server]
    B --> C[Redis Stream]
    C --> D[Sink Pod]
    D --> E[MongoDB]
```

### 1. Snapshots (ì´ˆê¸° ë°ì´í„° ë¡œë“œ)
- **ê¸°ë³¸ê°’**: `initial` ëª¨ë“œ
- **ë™ì‘**: Debezium Server ì‹œì‘ ì‹œ í˜„ì¬ MySQL ìƒíƒœì˜ ìŠ¤ëƒ…ìƒ· ìƒì„±
- **ëª¨ë“œ ì˜µì…˜**:
  - `initial`: ì „ì²´ í…Œì´ë¸” ìŠ¤ëƒ…ìƒ· í›„ CDC ì‹œì‘
  - `recovery`: ì´ì „ ì˜¤í”„ì…‹ë¶€í„° ë³µêµ¬
  - `custom`: ì‚¬ìš©ì ì •ì˜ ìŠ¤ëƒ…ìƒ·
  - `initial_only`: ìŠ¤ëƒ…ìƒ·ë§Œ ìˆ˜í–‰ í›„ ì¢…ë£Œ

### 2. í…Œì´ë¸” ì„ íƒ
- **ì„¤ì •**: `table.include.list` íŒŒë¼ë¯¸í„°ë¡œ CDCí•  í…Œì´ë¸” ì§€ì •
- **í˜•ì‹**: `<database>.<table>` (ì˜ˆ: `gyumin.orders,gyumin.users`)

### 3. ì‹¤ì‹œê°„ CDC
- MySQL binlog ë³€ê²½ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€
- Redis Streamì— JSON í˜•íƒœë¡œ ì´ë²¤íŠ¸ ì „ì†¡
## 2.4. CDC ë°ì´í„° í˜•íƒœ ë° í…ŒìŠ¤íŠ¸

### ì‹¤ì‹œê°„ CDC í…ŒìŠ¤íŠ¸ ê²°ê³¼
```bash
# INSERT í›„ ID ì¦ê°€ í™•ì¸
$ redis-cli --json XREVRANGE mysql_sink.gyumin.users + - COUNT 1 | jq -r '.[0][1][1] | fromjson | .payload.after.id'
30001

$ redis-cli --json XREVRANGE mysql_sink.gyumin.users + - COUNT 1 | jq -r '.[0][1][1] | fromjson | .payload.after.id'
30002
```

### í˜ì´ë¡œë“œ êµ¬ì¡° ë¶„ì„

#### INSERT ì‘ì—… (op: "c")
```json
{
  "payload": {
    "before": null,  // INSERTëŠ” ì´ì „ ìƒíƒœ ì—†ìŒ
    "after": {
      "id": 30002,
      "name": "í…ŒìŠ¤íŠ¸ìš© ìœ ì €"
      // ... ê¸°íƒ€ í•„ë“œë“¤
    },
    "source": {
      "version": "3.2.0.Final",
      "connector": "mysql",
      "name": "mysql_sink",
      "ts_ms": 1755138551000,
      "snapshot": "false",  // ì‹¤ì‹œê°„ CDC (trueë©´ ì´ˆê¸° ìŠ¤ëƒ…ìƒ·)
      "db": "gyumin",
      "table": "users",
      "server_id": 1,
      "gtid": null,
      "file": "binlog.000002",
      "pos": 7114433,
      "row": 0,
      "thread": 385,
      "query": null  // DMLì—ì„œëŠ” null (DDLì—ì„œë§Œ ê°’ ì¡´ì¬)
    },
    "transaction": null,
    "op": "c",  // c(insert), u(update), d(delete), r(read), t(truncate)
    "ts_ms": 1755138551799,
    "ts_us": 1755138551799549,
    "ts_ns": 1755138551799549000
  }
}
```
        

### Source ë©”íƒ€ë°ì´í„° ìƒì„¸ ì„¤ëª…

```json
"source": {
  "version": "3.2.0.Final",         // 2025.08.17 ê¸°ì¤€ stable ìµœì‹  ë²„ì „
  "connector": "mysql",              
  "name": "mysql_sink",              // ì»¤ë„¥í„° ì¸ìŠ¤í„´ìŠ¤ ì´ë¦„
  "ts_ms": 1755138551000,            // ì†ŒìŠ¤ ì´ë²¤íŠ¸ ì‹œê°(ms), MySQL binlog íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜
  "snapshot": "false",               // ìŠ¤ëƒ…ìƒ· ì—¬ë¶€: true(ì´ˆê¸° DB ë¡œë“œ), false(ì‹¤ì‹œê°„ CDC)
  "db": "gyumin",                    // ë°ì´í„°ë² ì´ìŠ¤ëª…
  "sequence": null,                  
  "ts_us": 1755138551000000,         // binlog ì´ë²¤íŠ¸ ì‹œê°„ (ë§ˆì´í¬ë¡œì´ˆ)
  "ts_ns": 1755138551000000000,      // binlog ì´ë²¤íŠ¸ ì‹œê°„ (ë‚˜ë…¸ì´ˆ)
  "table": "users",                  // CDC ëŒ€ìƒ í…Œì´ë¸”ëª…
  "server_id": 1,                    // MySQL ì„œë²„ ID (ì„¤ì • ê°€ëŠ¥)
  "gtid": null,                      // GTID ëª¨ë“œ ì‚¬ìš© ì‹œ íŠ¸ëœì­ì…˜ GTID (ë¹„í™œì„±í™”ì‹œ null)
  "file": "binlog.000002",           // ì´ë²¤íŠ¸ê°€ ë‹´ê¸´ binlog íŒŒì¼ëª…
  "pos": 7114433,                    // binlog íŒŒì¼ ë‚´ ì˜¤í”„ì…‹ (ì¬ì‹œì‘ ì‹œ ì´ ìœ„ì¹˜ë¶€í„° CDC ì¬ê°œ)
  "row": 0,                          // ë‹¤ì¤‘ INSERT ì‹œ row ìˆœì„œ (INSERT VALUES 2ê°œë©´ row 0, 1)
  "thread": 385,                     // MySQL DB ì„¸ì…˜ ID
  "query": null                      // DDL ì¿¼ë¦¬ ë‚´ìš© (DMLì—ì„œëŠ” null)
}
```
    

### UPDATE ì‘ì—… í˜ì´ë¡œë“œ

> **ì¤‘ìš”**: MySQLì—ì„œ `binlog_row_image=FULL` ì„¤ì • ì‹œ ì „ì²´ row ë³€ê²½ì‚¬í•­ì´ ê¸°ë¡ë©ë‹ˆë‹¤. 
> ë³€ê²½ëœ ë¶€ë¶„ë§Œì´ ì•„ë‹Œ ì „ì²´ row ë°ì´í„°ê°€ before/afterì— í¬í•¨ë˜ì–´ MongoDB upsertì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
> (PostgreSQLì˜ `wal_level=logical`ê³¼ ìœ ì‚¬)

```json
{
  "payload": {
    "before": {
      "id": 30000,
      "name": "í…ŒìŠ¤íŠ¸ìš©",
      // ... ì „ì²´ í•„ë“œ (ë³€ê²½ ì „ ìƒíƒœ)
    },
    "after": {
      "id": 30000,
      "name": "í…ŒìŠ¤íŠ¸ìš© ë³€ê²½",
      // ... ì „ì²´ í•„ë“œ (ë³€ê²½ í›„ ìƒíƒœ)
    },
    "op": "u"  // update ì‘ì—…
  }
}
```

### ì˜¤í”„ì…‹ ê´€ë¦¬ ë° ëª¨ë‹ˆí„°ë§

#### í˜„ì¬ ì²˜ë¦¬ ìœ„ì¹˜ í™•ì¸
```bash
# Redisì—ì„œ Debezium ì˜¤í”„ì…‹ í™•ì¸
$ redis-cli HGETALL metadata:debezium:offsets
{
  "ts_sec": 1755155084,
  "file": "binlog.000002",
  "pos": 7117146
}
```
    

## 2.5. ì™„ì „í•œ Debezium Server ì„¤ì •

> **ì°¸ê³ **: [Redis Write-Behind ê³µì‹ ê°€ì´ë“œ](https://redis.io/docs/latest/integrate/write-behind/reference/debezium/mysql/)

### í•„ìˆ˜ ì„¤ì • íŒŒì¼ (application.properties)

```properties
# ==========================================
# SINK ì„¤ì • (Redis Stream)
# ==========================================
debezium.sink.type=redis
debezium.sink.redis.address=localhost:6379
debezium.sink.redis.db.index=0

# Redis ë©”ëª¨ë¦¬ ì œí•œ ë° ìœ ëŸ‰ ì œì–´
debezium.sink.redis.memory.limit.mb=512
debezium.sink.redis.memory.threshold.percentage=85

# ==========================================
# SOURCE ì„¤ì • (MySQL)
# ==========================================
debezium.source.connector.class=io.debezium.connector.mysql.MySqlConnector

# MySQL ì—°ê²° ì •ë³´
debezium.source.database.hostname=localhost
debezium.source.database.port=3306
debezium.source.database.user=root
debezium.source.database.password=${MYSQL_PASSWORD}
debezium.source.database.dbname=gyumin
debezium.source.database.server.id=111

# ìŠ¤ëƒ…ìƒ· ëª¨ë“œ
debezium.source.snapshot.mode=initial

# í…Œì´ë¸” ì„ íƒ (ì£¼ì˜: ë¼ì¸ ë ì£¼ì„ ê¸ˆì§€ - Regex ì˜¤ë¥˜ ë°œìƒ)
debezium.source.table.include.list=gyumin.orders,gyumin.users

# ==========================================
# ì„±ëŠ¥ ë° ìµœì í™” ì„¤ì •
# ==========================================
# ë³€ê²½ì‚¬í•­ ì—†ëŠ” ë©”ì‹œì§€ ìŠ¤í‚µ
debezium.source.skip.messages.without.change=true

# binlog ì½ê¸° ì£¼ê¸° (0=ì¦‰ì‹œ, ë‹¨ìœ„: ms)
debezium.source.offset.flush.interval.ms=1000

# BigDecimal ì²˜ë¦¬ ë°©ì‹ (ì •í™•í•œ ìˆ«ì ì²˜ë¦¬)
debezium.source.decimal.handling.mode=string

# ì‹œê°„ ì •ë°€ë„ ëª¨ë“œ
debezium.source.time.precision.mode=adaptive_time_microseconds

# ==========================================
# ìŠ¤í† ë¦¬ì§€ ì„¤ì •
# ==========================================
# ì˜¤í”„ì…‹ ì €ì¥ì†Œ (Redis ì‚¬ìš©)
debezium.source.offset.storage=io.debezium.storage.redis.offset.RedisOffsetBackingStore

# ìŠ¤í‚¤ë§ˆ íˆìŠ¤í† ë¦¬ ì €ì¥ì†Œ (DDL ë³€ê²½ ì´ë ¥)
debezium.source.schema.history.internal=io.debezium.storage.redis.history.RedisSchemaHistory

# Stream Key í˜•ì‹: <prefix>.<dbName>.<tableName>
debezium.source.topic.prefix=cdc
```

### ì¤‘ìš” ì„¤ì • ì˜µì…˜ ìƒì„¸ ì„¤ëª…

#### ë©”ëª¨ë¦¬ ê´€ë¦¬
- `debezium.sink.redis.memory.limit.mb`: Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì œí•œ
- `debezium.sink.redis.memory.threshold.percentage`: ìœ ëŸ‰ì œì–´ ì‹œì‘ ì„ê³„ê°’
- **ì£¼ì˜ì‚¬í•­**: Redis ì„œë²„ì— `maxmemory` ì„¤ì • í•„ìš”
  ```bash
  redis-cli CONFIG SET maxmemory 4096mb
  redis-cli CONFIG SET maxmemory-policy noeviction
  ```

#### í…Œì´ë¸” ë° ì»¬ëŸ¼ ì„ íƒ
- `table.include.list`: `<DB_NAME>.<TABLE_NAME>` í˜•ì‹ìœ¼ë¡œ ì§€ì •
- `column.include.list`: íŠ¹ì • ì»¬ëŸ¼ë§Œ CDCí•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš© (í˜„ì¬ëŠ” í…Œì´ë¸” ì „ì²´ CDC)

#### ë°ì´í„° íƒ€ì… ì²˜ë¦¬
- `decimal.handling.mode=string`: BigDecimalì„ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•˜ì—¬ ì •ë°€ë„ ë³´ì¥
- `time.precision.mode`: ì‹œê°„ ë°ì´í„° ì •ë°€ë„ ì„¤ì •

#### MySQL Datetime ì²˜ë¦¬ ê°€ì´ë“œ

> **ì°¸ê³ **: [MySQL Temporal Types ê³µì‹ ë¬¸ì„œ](https://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-temporal-types)

**ë³€í™˜ ì˜ˆì‹œ**: `DATETIME` ê°’ `2018-06-20 06:37:03` â†’ `1529476623000` (ë°€ë¦¬ì´ˆ)

**ë‹¤ì–‘í•œ ì‹œê°„ íƒ€ì… í†µí•© ì²˜ë¦¬**:
```properties
# ê¶Œì¥: ëª¨ë“  ì‹œê°„ ì»¬ëŸ¼ì„ ë°€ë¦¬ì´ˆë¡œ í†µì¼
debezium.source.time.precision.mode=connect
```

**ìë¦¿ìˆ˜ë³„ ì‹œê°„ ë‹¨ìœ„ êµ¬ë¶„ë²•** (2286ë…„ê¹Œì§€ ìœ íš¨):
- 1~10ìë¦¬: ì´ˆ ë‹¨ìœ„
- 11~13ìë¦¬: ë°€ë¦¬ì´ˆ ë‹¨ìœ„  
- 14~16ìë¦¬: ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„

## 2.6. ëª¨ë‹ˆí„°ë§ ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
```bash
# Redis ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸
redis-cli INFO memory

# íŠ¹ì • Stream í¬ê¸° í™•ì¸
redis-cli XLEN cdc.gyumin.users

# ëª¨ë“  CDC Stream ëª©ë¡
redis-cli KEYS "cdc.*"
```

### ì¼ë°˜ì ì¸ ë¬¸ì œ í•´ê²°

#### 1. OOM (Out of Memory) ë°œìƒ
**ì¦ìƒ**: Redis ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ CDC ì¤‘ë‹¨
**ì›ì¸**: Sink ì²˜ë¦¬ ì†ë„ < Binlog ì ì¬ ì†ë„
**í•´ê²°ë°©ë²•**:
```bash
# 1. Redis ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •
redis-cli CONFIG SET maxmemory 4096mb
redis-cli CONFIG SET maxmemory-policy noeviction

# 2. Debezium ìœ ëŸ‰ì œì–´ ì„¤ì • (application.properties)
debezium.sink.redis.memory.limit.mb=512
debezium.sink.redis.memory.threshold.percentage=85
```

#### 2. Binlog ìœ„ì¹˜ ì†ì‹¤
**ì¦ìƒ**: Debezium ì¬ì‹œì‘ ì‹œ ì¤‘ë³µ ë°ì´í„° ë˜ëŠ” ëˆ„ë½
**ì›ì¸**: Redis offset ì •ë³´ ì†ì‹¤
**í•´ê²°ë°©ë²•**:
```bash
# í˜„ì¬ offset í™•ì¸
redis-cli HGETALL metadata:debezium:offsets

# í•„ìš”ì‹œ ìŠ¤ëƒ…ìƒ· ì¬ì‹¤í–‰
debezium.source.snapshot.mode=recovery
```

#### 3. íŠ¹ì • í…Œì´ë¸” CDC ì¤‘ë‹¨
**ì¦ìƒ**: ì¼ë¶€ í…Œì´ë¸”ë§Œ CDC ë™ì‘ ì•ˆí•¨
**ì›ì¸**: DDL ë³€ê²½ ë˜ëŠ” ê¶Œí•œ ë¬¸ì œ
**í•´ê²°ë°©ë²•**:
```sql
-- MySQL ê¶Œí•œ í™•ì¸
SHOW GRANTS FOR 'debezium_user'@'%';

-- binlog ìƒíƒœ í™•ì¸
SHOW VARIABLES LIKE 'log_bin';
SHOW VARIABLES LIKE 'binlog_format';
SHOW VARIABLES LIKE 'binlog_row_image';
```

# 3. ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ë° ë™ì  í…Œì´ë¸” ì¶”ê°€

## 3.1. ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ê°œë…

ìš´ì˜ ì¤‘ì¸ CDC í™˜ê²½ì—ì„œ ìƒˆë¡œìš´ í…Œì´ë¸”ì„ ì¶”ê°€í•˜ê±°ë‚˜, íŠ¹ì • í…Œì´ë¸”ë§Œ ì´ˆê¸° ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ì•¼ í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### ì¥ì 
- ì „ì²´ CDC ì¤‘ë‹¨ ì—†ì´ íŠ¹ì • í…Œì´ë¸”ë§Œ ìŠ¤ëƒ…ìƒ· ê°€ëŠ¥
- ì²­í¬ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ì²˜ë¦¬ ì‹œ ë¶€í•˜ ë¶„ì‚°
- ê¸°ì¡´ CDC ì‘ì—…ì— ì˜í–¥ ìµœì†Œí™”

### ì°¸ê³  ìë£Œ
- [Debezium Incremental Snapshots ë¸”ë¡œê·¸](https://debezium.io/blog/2021/10/07/incremental-snapshots/)
- [MySQL Connector ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ê°€ì´ë“œ](https://debezium.io/documentation/reference/stable/connectors/mysql.html#debezium-mysql-incremental-snapshots)

## 3.2. ì‹œê·¸ë„ í…Œì´ë¸” ì„¤ì •

### 1. ì‹œê·¸ë„ í…Œì´ë¸” ìƒì„±
```sql
-- ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ëª…ë ¹ìš© í…Œì´ë¸” ìƒì„±
CREATE TABLE gyumin.dbz_signal (
  id    VARCHAR(64) PRIMARY KEY,
  type  VARCHAR(32) NOT NULL,
  data  VARCHAR(2048) NULL
);
```

### 2. Debezium ì„¤ì • ì—…ë°ì´íŠ¸
```properties
# ê¸°ì¡´ í…Œì´ë¸” ëª©ë¡ì— ì‹œê·¸ë„ í…Œì´ë¸”ê³¼ ìƒˆ í…Œì´ë¸” ì¶”ê°€
debezium.source.table.include.list=gyumin.orders,gyumin.users,gyumin.dbz_signal,gyumin.new_table

# ì‹œê·¸ë„ í…Œì´ë¸” ì§€ì •
debezium.source.signal.data.collection=gyumin.dbz_signal
```

### 3. ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ì‹¤í–‰
```sql
-- ìƒˆ í…Œì´ë¸”(new_table)ì˜ ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ì‹¤í–‰
INSERT INTO gyumin.dbz_signal (id, type, data)
VALUES (
   'snapshot-new-table-001',
   'execute-snapshot',
   '{"data-collections":["gyumin.new_table"],"type":"incremental","additional-conditions":{}}'
);
```

## 3.3. ìŠ¤ëƒ…ìƒ· ì§„í–‰ ìƒí™© í™•ì¸

### Redis Stream ìƒì„± í™•ì¸
```bash
# ìƒˆ í…Œì´ë¸”ì˜ Streamì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
redis-cli KEYS "cdc.gyumin.new_table"

# Stream ë‚´ ë°ì´í„° ê°œìˆ˜ í™•ì¸
redis-cli XLEN cdc.gyumin.new_table

# ìƒ˜í”Œ ë°ì´í„° í™•ì¸
redis-cli XRANGE cdc.gyumin.new_table - + COUNT 5
```

### ìŠ¤ëƒ…ìƒ· ì™„ë£Œ í™•ì¸
```bash
# ìŠ¤ëƒ…ìƒ· ì™„ë£Œ ì‹œê·¸ë„ í™•ì¸ (type: snapshot-completed)
redis-cli XREVRANGE cdc.gyumin.dbz_signal + - COUNT 10
```

### Mysql datetime to millis ì•Œê³ ìˆì–´ì•¼í•¨.

> reference : https://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-temporal-types
`DATETIME`Â with a value ofÂ `2018-06-20 06:37:03`Â becomesÂ `1529476623000`.

ì •ìƒë™ì‘ í™•ì¸ë˜ì—ˆìœ¼ë‹ˆ í•´ë‹¹ ê±´ ë„ì»¤ë¼ì´ì§• í›„ ì™¸ë¶€ í™˜ê²½ë³€ìˆ˜ secret ì„¸íŒ…ê³¼ pod ë¡œ ë¡œë“œí•˜ëŠ” cicd íŒŒì´í”„ë¼ì¸ ë° ëª¨ë‹ˆí„°ë§ ì„¤ì • í•„ìš”!

## 3.5. CDC ì•ˆì •í™” ë° ì„±ëŠ¥ ìµœì í™”

### í•„ìˆ˜ ì•ˆì •í™” ì„¤ì •

#### 1. Redis Connection Timeout ì„¤ì •
```properties
# Redis ëª…ë ¹ íƒ€ì„ì•„ì›ƒ > XGROUPREAD pollTimeout ì„¤ì • í•„ìˆ˜
debezium.sink.redis.connection.timeout.ms=30000
debezium.sink.redis.socket.timeout.ms=30000

# Stream ì½ê¸° íƒ€ì„ì•„ì›ƒ (ìœ„ ê°’ë³´ë‹¤ ì‘ê²Œ ì„¤ì •)
redis.stream.poll.timeout.ms=25000
```

#### 2. ì¥ì•  ë³µêµ¬ ì „ëµ
**ë¬¸ì œ**: Sink ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ ì¬ì²˜ë¦¬ ì¤‘ ë°ì´í„° ìˆœì„œ ë¬¸ì œ
- A â†’ B â†’ C ìˆœì„œë¡œ ì—…ë°ì´íŠ¸ë˜ì–´ì•¼ í•˜ëŠ”ë°
- A ì‹¤íŒ¨ â†’ B ì„±ê³µ â†’ C ì„±ê³µ í›„ A ì¬ì²˜ë¦¬ ì‹œ ìµœì‹  ë°ì´í„° ë®ì–´ì“°ê¸° ìœ„í—˜

**í•´ê²° ë°©ì•ˆ**:
```kotlin
// ì¬ì²˜ë¦¬ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ë¹„êµë¡œ ìˆœì„œ ë³´ì¥
fun shouldProcessPendingMessage(pendingMsg: DebeziumMessage, currentRow: SinkDocument?): Boolean {
    if (currentRow == null) return true
    
    val pendingTimestamp = pendingMsg.payload.ts_ms
    val currentTimestamp = currentRow.sinkInfo.sinkedAt
    
    // ì¬ì²˜ë¦¬ ë©”ì‹œì§€ê°€ í˜„ì¬ ì €ì¥ëœ ë°ì´í„°ë³´ë‹¤ ì˜¤ë˜ëœ ê²½ìš° ë¬´ì‹œ
    return pendingTimestamp > currentTimestamp
}
```

#### 3. ì†Œí”„íŠ¸ ì‚­ì œ ì •ì±… í™œìš©
- í”„ë¡œì íŠ¸ ê¸°ë³¸ ì •ì±…: ì†Œí”„íŠ¸ ì‚­ì œ (Hard Delete ì—†ìŒ)
- ì‚­ì œ ì‹œì  ì¶”ì ìœ¼ë¡œ ì¬ì²˜ë¦¬ ìˆœì„œ ë³´ì¥ ê°€ëŠ¥

# 4. Sink (CDC + ETL) ë°ì´í„° ì ì¬ ëª¨ë“ˆ

## 4.1. ì „ì²´ ì•„í‚¤í…ì²˜

### ë°ì´í„° í”Œë¡œìš°
```mermaid
graph TD
    A[MySQL Binlog] --> B[Debezium Server]
    B --> C[Redis Stream]
    C --> D[Order Hub Sink]
    D --> E[SinkConnectorFinder]
    E --> F[í…Œì´ë¸”ë³„ SinkConnector]
    F --> G[MongoDB Collection]
    
    H[CI/CD Pipeline] --> I[Debezium Pod]
    H --> J[Sink Pod]
```

### ëª¨ë“ˆ êµ¬ì„± ìš”ì†Œ
1. **CDC ëª¨ë“ˆ** (Debezium Server): MySQL â†’ Redis Stream
2. **ETL ëª¨ë“ˆ** (Order Hub Sink): Redis Stream â†’ MongoDB
3. **CI/CD íŒŒì´í”„ë¼ì¸**: ëª¨ë“ˆë³„ ë…ë¦½ ë°°í¬

## 4.2. ìƒì„¸ êµ¬í˜„ ê°€ì´ë“œ

### 1) CI/CD ë° ë°°í¬ ì „ëµ

**ë°°í¬ ì•„í‚¤í…ì²˜**:
- ê¸°ì¡´ í”„ë Œì°¨ì´ì¦ˆë³„ ìˆ˜ë™ ë°°í¬ì— ê³µí†µ ëª¨ë“ˆ ë°°í¬ ì¶”ê°€
- Debezium, Sink ëª¨ë“ˆ ê°ê° ë…ë¦½ì ì¸ CI/CD íŒŒì´í”„ë¼ì¸
- í™˜ê²½ë³€ìˆ˜ëŠ” `deploy.yaml`ì˜ envsetìœ¼ë¡œ Linux í™˜ê²½ë³€ìˆ˜ ì£¼ì…

**ì£¼ìš” íŒŒë¼ë¯¸í„°**:
- Database ì—°ê²° ì •ë³´ (MySQL, MongoDB, Redis)
- Quarkus ëŸ°íƒ€ì„ ì„¤ì •
- ë©”ëª¨ë¦¬ ë° ì„±ëŠ¥ íŠœë‹ íŒŒë¼ë¯¸í„°

### 2) Debezium Server CDC
- **ì—­í• **: MySQL Binlog â†’ Redis Stream JSON ë³€í™˜
- **ë°°í¬**: ë…ë¦½ì ì¸ Podë¡œ ì‹¤í–‰
- **ëª¨ë‹ˆí„°ë§**: Redis Stream ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰, Binlog ì§€ì—° ì‹œê°„

### 3) ETL ëª¨ë“ˆ (Sink) ìƒì„¸ êµ¬í˜„

#### Row ë°ì´í„° í´ë˜ìŠ¤ (MySQL ìŠ¤í‚¤ë§ˆ ë§¤í•‘)
```kotlin
// ìœ„ì¹˜: order-hub-sink/src/main/kotlin/.../connector/<domain>/
@JsonIgnoreProperties(ignoreUnknown = true)
data class OrderRow(
    val id: Long?,
    val franchiseCode: String?,
    val orderStatus: String?,
    val createdAt: String?,  // Debezium íƒ€ì„ìŠ¤íƒ¬í”„ ë¬¸ìì—´
    val updatedAt: String?,
    // ... ê°€ëŠ¥í•œ ëª¨ë“  í•„ë“œ null í—ˆìš© (DDL ë³€ê²½ ëŒ€ì‘)
)
```

#### MongoDB ë„ë©”ì¸ ë¬¸ì„œ í´ë˜ìŠ¤
```kotlin
// ìœ„ì¹˜: order-hub/src/main/kotlin/.../domain/sink/<domain>/
@Document(collection = "sink_orders")
data class SinkOrder(
    @Id val mongoId: String = ObjectId().toString(),
    val orderId: Long,
    val franchiseCode: String,
    val orderStatus: String,
    val items: List<SinkOrderItem> = emptyList(),  // ë¹„ì •ê·œí™”
    val sinkInfo: SinkInfo,  // ë©”íƒ€ë°ì´í„°
    val createdAt: OffsetDateTime,
    val updatedAt: OffsetDateTime
) : SinkClass

data class SinkInfo(
    val mysqlId: Long,           // MySQL PK
    val franchiseCode: String,   // ë©€í‹° í”„ë Œì°¨ì´ì¦ˆ ê²©ë¦¬
    val sinkedAt: OffsetDateTime // CDC ì²˜ë¦¬ ì‹œì 
)
```

#### SinkConnector êµ¬í˜„
```kotlin
@Component
class OrderSinkConnector(
    private val mongoTemplate: MongoTemplate
) : SinkConnector<OrderRow, SinkOrder>() {
    
    override val typeRef = object : TypeReference<DebeziumMessage<OrderRow>>() {}
    override val mysqlTableName = "orders"
    override val collectionName = "sink_orders"
    
    override fun toEntity(row: OrderRow, franchise: String): SinkOrder {
        return SinkOrder(
            orderId = row.id!!,
            franchiseCode = franchise,
            orderStatus = row.orderStatus!!,
            sinkInfo = SinkInfo(
                mysqlId = row.id!!,
                franchiseCode = franchise,
                sinkedAt = OffsetDateTime.now()
            ),
            createdAt = parseDebeziumTimestamp(row.createdAt!!),
            updatedAt = parseDebeziumTimestamp(row.updatedAt!!)
        )
    }
    
    override fun keyQuery(row: OrderRow, franchise: String): Query {
        return Query(
            Criteria.where("sinkInfo.mysqlId").`is`(row.id)
                .and("sinkInfo.franchiseCode").`is`(franchise)
        )
    }
}
```

#### SinkConnector ë² ì´ìŠ¤ í´ë˜ìŠ¤
```kotlin
abstract class SinkConnector<T, E : SinkClass>(
    protected val mongoTemplate: MongoTemplate
) {
    abstract val typeRef: TypeReference<DebeziumMessage<T>>
    abstract val mysqlTableName: String
    abstract val collectionName: String
    
    // ë‹¨ê±´ ì²˜ë¦¬
    fun handle(message: DebeziumMessage<T>) {
        when (message.payload.op) {
            "c", "r", "u" -> upsertDocument(message)
            "d" -> deleteDocument(message)
        }
    }
    
    // ë²Œí¬ ì²˜ë¦¬ (ì„±ëŠ¥ ìµœì í™”)
    fun bulkHandle(messages: List<DebeziumMessage<T>>) {
        val operations = messages.map { createBulkOperation(it) }
        mongoTemplate.bulkOps(BulkOperations.BulkMode.UNORDERED, collectionName)
            .apply { operations.forEach { execute() } }
    }
    
    abstract fun toEntity(row: T, franchise: String): E
    abstract fun keyQuery(row: T, franchise: String): Query
}
```

### 4) ìë™ ë¼ìš°íŒ… ë° í…ŒìŠ¤íŠ¸

#### SinkConnectorFinder (ìë™ ë¼ìš°íŒ…)
```kotlin
@Component
class SinkConnectorFinder(connectors: List<SinkConnector<*, *>>) {
    private val connectorMap = connectors.associateBy { it.mysqlTableName }
    
    fun findConnector(tableName: String): SinkConnector<*, *>? {
        return connectorMap[tableName]
    }
}
```

#### ì¢…í•© í…ŒìŠ¤íŠ¸ (Kotest + Testcontainers)
```kotlin
class OrderSinkConnectorTest : StringSpec({
    
    "CDC INSERT ë©”ì‹œì§€ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸" {
        // Given
        val debeziumMessage = DebeziumMessage(
            payload = Payload(
                op = "c",
                after = OrderRow(id = 1L, franchiseCode = "TEST"),
                before = null
            )
        )
        
        // When
        connector.handle(debeziumMessage)
        
        // Then
        val result = mongoTemplate.findOne(
            Query(Criteria.where("sinkInfo.mysqlId").`is`(1L)),
            SinkOrder::class.java
        )
        result shouldNotBe null
        result!!.franchiseCode shouldBe "TEST"
    }
    
    "ë©€í‹° í”„ëœì°¨ì´ì¦ˆ ê²©ë¦¬ í…ŒìŠ¤íŠ¸" {
        // ë™ì¼í•œ MySQL IDë¼ë„ í”„ëœì°¨ì´ì¦ˆë³„ ë³„ë„ ì €ì¥ í™•ì¸
    }
    
    "ë²Œí¬ ì²˜ë¦¬ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸" {
        // 100ê°œ ë©”ì‹œì§€ ë²Œí¬ ì²˜ë¦¬ vs ë‹¨ê±´ ì²˜ë¦¬ ì„±ëŠ¥ ë¹„êµ
    }
})
```

### 5) ì‹¤ì œ ìš´ì˜ í”Œë¡œìš°
1. **Stream êµ¬ë…**: SinkBindingsConfigì—ì„œ `cdc.*` prefix ë™ì  ê°ì§€
2. **ë©”ì‹œì§€ ë¼ìš°íŒ…**: í…Œì´ë¸”ëª… ê¸°ë°˜ ìë™ ì»¤ë„¥í„° ì„ íƒ  
3. **ë³€í™˜ ë° ì €ì¥**: Row â†’ ë„ë©”ì¸ ë¬¸ì„œ ë§¤í•‘ í›„ MongoDB upsert/remove
4. **ë©€í‹° í”„ëœì°¨ì´ì¦ˆ**: `franchiseCode + mysqlId` ì¡°í•©ìœ¼ë¡œ ê²©ë¦¬ ì €ì¥

# 5. ìš´ì˜ ì¤‘ ë°œìƒí•œ í•µì‹¬ ì´ìŠˆ ë° í•´ê²°ë°©ì•ˆ

## 5.1. Redis OOM ë¬¸ì œ ë° ìœ ëŸ‰ì œì–´

### ë¬¸ì œ ìƒí™©
- **ì¦ìƒ**: Redis ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ CDC ì „ì²´ ì¤‘ë‹¨
- **ì›ì¸**: Sink ì²˜ë¦¬ ì†ë„ << Binlog ì ì¬ ì†ë„
- **ì˜í–¥ë„**: ì „ì²´ CDC íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨

### í•´ê²° ê³¼ì •
```bash
# 1ë‹¨ê³„: Redis ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •
redis-cli CONFIG SET maxmemory 4096mb
redis-cli CONFIG SET maxmemory-policy noeviction

# 2ë‹¨ê³„: Debezium ìœ ëŸ‰ì œì–´ (application.properties)
debezium.sink.redis.memory.limit.mb=512
debezium.sink.redis.memory.threshold.percentage=85
```

### ê²°ê³¼ ëª¨ë‹ˆí„°ë§
![ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°œì„ ](../2025-09-26-02-48-29.png)
- **ê°œì„  ì „**: 4GB ë©”ëª¨ë¦¬ ì‚¬ìš© â†’ í‚¤ ì œê±° ë°œìƒ
- **ê°œì„  í›„**: 400MB ëŒ€ ì•ˆì •ì  ìœ ì§€

### ì¤‘ìš” í¬ì¸íŠ¸
- Redis `maxmemory=0` (unlimited) ìƒíƒœì—ì„œëŠ” Debezium ìœ ëŸ‰ì œì–´ ì˜µì…˜ì´ ë¬´ì‹œë©ë‹ˆë‹¤.
- ë°˜ë“œì‹œ Redis ë©”ëª¨ë¦¬ ì œí•œì„ ë¨¼ì € ì„¤ì •í•œ í›„ Debezium ì˜µì…˜ ì ìš© í•„ìš”

## 5.2. ë™ì  Stream ê´€ë¦¬

### ê¸°ì¡´ ë¬¸ì œì 
- í•˜ë“œì½”ë”©ëœ Stream ëª©ë¡ìœ¼ë¡œ ì‹ ê·œ í…Œì´ë¸” ì¶”ê°€ ì‹œ ë°°í¬ í•„ìš”
- ìš´ì˜ ì¤‘ í…Œì´ë¸” ì¶”ê°€/ì œê±°ì˜ ìœ ì—°ì„± ë¶€ì¡±

### ê°œì„  ë°©ì•ˆ
```kotlin
@Scheduled(fixedRate = 1000) // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰
fun discoverNewStreams() {
    val existingStreams = redisTemplate.keys("cdc.*")
    val activeConnections = inMemoryStreamConnections
    
    // ì‹ ê·œ Stream ê°ì§€ ë° ì—°ê²°
    existingStreams.subtract(activeConnections).forEach { streamKey ->
        connectToStream(streamKey)
        log.info("ìƒˆë¡œìš´ CDC Stream ì—°ê²°: $streamKey")
    }
}
```

### ìš´ì˜ íš¨ê³¼
- ë°°í¬ ì—†ì´ ì‹¤ì‹œê°„ í…Œì´ë¸” ì¶”ê°€ ê°€ëŠ¥
- ì¸ë©”ëª¨ë¦¬ ì—°ê²° ê´€ë¦¬ë¡œ ì„±ëŠ¥ ìµœì í™”
- ì¥ì•  ì‹œ ìë™ ë³µêµ¬ ê°€ëŠ¥

## 5.3. ì„±ëŠ¥ ìµœì í™”: ë‹¨ê±´ â†’ ë²Œí¬ ì²˜ë¦¬

### ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼
- **ê¸°ì¡´**: ë‹¨ê±´ ì²˜ë¦¬ í‰ê·  1.3~1.5ms
- **ê°œì„ **: ë²Œí¬ ì²˜ë¦¬ 100ê±´ë‹¹ í‰ê·  27ms (ê±´ë‹¹ 0.27ms)
- **ì„±ëŠ¥ í–¥ìƒ**: **ì•½ 5ë°° ê°œì„ **

### ë²Œí¬ ì²˜ë¦¬ êµ¬í˜„
```kotlin
@Component
class BulkSinkProcessor {
    private val messageBuffer = mutableListOf<DebeziumMessage<*>>()
    private val bufferSize = 100
    
    fun addMessage(message: DebeziumMessage<*>) {
        messageBuffer.add(message)
        
        if (messageBuffer.size >= bufferSize) {
            flushBuffer()
        }
    }
    
    @Scheduled(fixedRate = 1000) // 1ì´ˆë§ˆë‹¤ ê°•ì œ flush
    fun scheduledFlush() {
        if (messageBuffer.isNotEmpty()) {
            flushBuffer()
        }
    }
    
    private fun flushBuffer() {
        val messages = messageBuffer.toList()
        messageBuffer.clear()
        
        // í…Œì´ë¸”ë³„ ê·¸ë£¹í•‘ í›„ ë²Œí¬ ì²˜ë¦¬
        messages.groupBy { it.payload.source.table }
            .forEach { (table, msgs) ->
                sinkConnectorFinder.findConnector(table)
                    ?.bulkHandle(msgs)
            }
            
        // Redis Streamì—ì„œ ë²Œí¬ ACK & DELETE
        redisTemplate.execute { connection ->
            connection.xAck(streamKey, consumerGroup, *messageIds)
            connection.xDel(streamKey, *messageIds)
        }
    }
}
```

### ì‹¤ì œ ì„±ëŠ¥ ë¡œê·¸
```
2025-09-26T02:48:01.890+09:00  INFO [fooddash-domain] [virtual-246] 
SinkConnector: bulkHandle called with 100 records for table menus
SinkConnector.bulkHandle(..) ì‹¤í–‰ ì‹œê°„: 26.672 ms

2025-09-26T02:48:01.926+09:00  INFO [fooddash-domain] [MessageBroker-2]
SinkConnector: bulkHandle called with 12 records for table menus  
SinkConnector.bulkHandle(..) ì‹¤í–‰ ì‹œê°„: 4.947 ms
```

### ìµœì í™” í¬ì¸íŠ¸
1. **ë„¤íŠ¸ì›Œí¬ ë¼ìš´ë“œíŠ¸ë¦½ ê°ì†Œ**: 100ê°œ â†’ 1ë²ˆì˜ MongoDB ì—°ê²°
2. **Redis ìš´ì˜ ìµœì í™”**: ë²Œí¬ ACK/DELETEë¡œ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„± í–¥ìƒ
3. **ë²„í¼ë§ ì „ëµ**: í¬ê¸° ê¸°ë°˜ + ì‹œê°„ ê¸°ë°˜ ì´ì¤‘ flush ì „ëµ

## 5.4. ë°ì´í„° ì •í•©ì„± ë° ì•ˆì •ì„± ë³´ì¥

### ë°ì´í„° ìœ ì‹¤ ë°©ì§€ ì „ëµ
- **Redis ì •ì±…**: `noeviction` ì„¤ì •ìœ¼ë¡œ ë°ì´í„° ë³´í˜¸
- **ìœ ëŸ‰ì œì–´**: MySQL â†’ Redis ì ì¬ ì†ë„ ì¡°ì ˆ
- **ì˜¤í”„ì…‹ ê´€ë¦¬**: Redisì— binlog position ì§€ì†ì  ì €ì¥
- **ë©±ë“±ì„±**: ì¬ì²˜ë¦¬ ì‹œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

### ì¬ì‹œì‘ ì‹œ ë³µêµ¬ ì „ëµ
```bash
# Debezium Server ì¬ì‹œì‘ ì‹œ
# 1. Redisì—ì„œ ë§ˆì§€ë§‰ ì²˜ë¦¬ ì˜¤í”„ì…‹ í™•ì¸
redis-cli HGETALL metadata:debezium:offsets

# 2. í•´ë‹¹ binlog positionë¶€í„° CDC ì¬ê°œ
# 3. ë©±ë“±ì„± ë³´ì¥ìœ¼ë¡œ ì¤‘ë³µ ì²˜ë¦¬ ì•ˆì „
```

### ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤ ëŒ€ì‘
```properties
# binlog offset ì™„ì „ ì†ì‹¤ ì‹œ ì „ì²´ ìŠ¤ëƒ…ìƒ· ì¬ì‹¤í–‰
debezium.source.snapshot.mode=initial

# ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
debezium.source.snapshot.include.collection.list=gyumin.critical_tables
```

# 6. Best Practices ë° ìš´ì˜ ê°€ì´ë“œ

## 6.1. ìƒˆë¡œìš´ í…Œì´ë¸” ì¶”ê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ê°œë°œ ë‹¨ê³„
- [ ] **1. Row ë°ì´í„° í´ë˜ìŠ¤ ìƒì„±**
  ```kotlin
  // snake_case, ëª¨ë“  í•„ë“œ null í—ˆìš©, BigDecimal/OffsetDateTime ì ì ˆíˆ ì‚¬ìš©
  data class NewTableRow(
      val id: Long?,
      val name: String?,
      val created_at: String?  // Debezium í˜•ì‹
  )
  ```

- [ ] **2. MongoDB ë„ë©”ì¸ ë¬¸ì„œ í´ë˜ìŠ¤**
  ```kotlin
  @Document(collection = "sink_new_table")
  data class SinkNewTable(...) : SinkClass
  ```

- [ ] **3. SinkConnector êµ¬í˜„**
  ```kotlin
  @Component
  class NewTableSinkConnector : SinkConnector<NewTableRow, SinkNewTable>
  ```

### ìš´ì˜ ë‹¨ê³„  
- [ ] **4. ì¦ë¶„ ìŠ¤ëƒ…ìƒ· ê³ ë ¤ì‚¬í•­**
  - ê¸°ì¡´ ë°ì´í„° ë¡œë“œ í•„ìš” ì—¬ë¶€ íŒë‹¨
  - ëŒ€ìš©ëŸ‰ í…Œì´ë¸”ì¸ ê²½ìš° ì²­í¬ í¬ê¸° ì¡°ì ˆ
  
- [ ] **5. í…ŒìŠ¤íŠ¸ ì‘ì„±**
  ```kotlin
  // Kotest + Testcontainers
  // c/u/d ëª¨ë“  ì¼€ì´ìŠ¤, ë©€í‹° í”„ë Œì°¨ì´ì¦ˆ, ì—£ì§€ ì¼€ì´ìŠ¤ ê²€ì¦
  ```

- [ ] **6. ëª¨ë‹ˆí„°ë§ ì„¤ì •**
  - Stream í¬ê¸° ëª¨ë‹ˆí„°ë§
  - ì²˜ë¦¬ ì§€ì—° ì‹œê°„ í™•ì¸
  - ì—ëŸ¬ìœ¨ ì¶”ì 

### ë¹„ì •ê·œí™” í…Œì´ë¸” íŠ¹ë³„ ê³ ë ¤ì‚¬í•­
```kotlin
// OrderItemì²˜ëŸ¼ ë¶€ëª¨ ë¬¸ì„œ ë‚´ ë°°ì—´ë¡œ ì €ì¥ë˜ëŠ” ê²½ìš°
override fun bulkHandle(messages: List<DebeziumMessage<OrderItemRow>>) {
    // ê°œë³„ upsert í•„ìš” (ì•ˆì „í•œ í•„ë“œ ë‹¨ìœ„ .set ì‚¬ìš©)
    messages.forEach { msg ->
        val updateOps = Update()
            .set("items.$.itemName", msg.payload.after.itemName)
            .set("items.$.updatedAt", OffsetDateTime.now())
            
        mongoTemplate.updateFirst(
            Query(Criteria.where("items.itemId").`is`(msg.payload.after.id)),
            updateOps,
            collectionName
        )
    }
}
```

## 6.2. ìš´ì˜ ì¤‘ í•„ìˆ˜ ëª¨ë‹ˆí„°ë§ ì§€í‘œ

### Redis ë©”íŠ¸ë¦­
```bash
# ì£¼ìš” ëª¨ë‹ˆí„°ë§ ëª…ë ¹ì–´
redis-cli INFO memory | grep used_memory_human
redis-cli XLEN cdc.gyumin.orders
redis-cli XINFO GROUPS cdc.gyumin.orders
```

### ì„±ëŠ¥ ì§€í‘œ
- **Stream ì ì¬ ì†ë„**: messages/sec
- **Sink ì²˜ë¦¬ ì†ë„**: documents/sec  
- **ì§€ì—° ì‹œê°„**: binlog timestamp vs processed timestamp
- **ì—ëŸ¬ìœ¨**: failed messages / total messages

### ì•Œë¦¼ ì„¤ì • ê¶Œì¥ì‚¬í•­
```yaml
# ì˜ˆì‹œ: Prometheus + Grafana ì•Œë¦¼
- alert: RedisStreamLag
  expr: redis_stream_length > 10000
  for: 5m
  
- alert: SinkProcessingDelay  
  expr: cdc_processing_delay_seconds > 300
  for: 2m
```

## 6.3. application.properties ì„¤ì • ê·œì¹™

### í•„ìˆ˜ ì¤€ìˆ˜ ì‚¬í•­
```properties
# âŒ ë¼ì¸ ë ì£¼ì„ ê¸ˆì§€ (Regex íŒŒì‹± ì˜¤ë¥˜)
debezium.source.table.include.list=gyumin.orders,gyumin.users # ì´ë ‡ê²Œ í•˜ë©´ ì•ˆë¨

# âœ… ì˜¬ë°”ë¥¸ í˜•ì‹
debezium.source.table.include.list=gyumin.orders,gyumin.users

# âœ… BigDecimal ì •í™•ë„ ë³´ì¥
debezium.source.decimal.handling.mode=string

# âœ… í…Œì´ë¸” ì§€ì • í˜•ì‹
# <SCHEMA_NAME>.<TABLE_NAME> í˜•ì‹ ì¤€ìˆ˜
```

### í™˜ê²½ë³„ ì„¤ì • ë¶„ë¦¬
```properties
# Base: application.properties
debezium.source.database.hostname=${MYSQL_HOST:localhost}
debezium.source.database.password=${MYSQL_PASSWORD}

# í™˜ê²½ë³„ ì˜¤ë²„ë¼ì´ë“œ
# application-dev.properties, application-prod.properties
```

# 7. Datetime ì²˜ë¦¬ ë° ë°ì´í„° íƒ€ì… ìµœì í™”

## 7.1. Debezium ì‹œê°„ íƒ€ì… ë³€í™˜ ìƒì„¸

### MySQL ì‹œê°„ ì»¬ëŸ¼ë³„ Debezium ë³€í™˜ ê²°ê³¼

![datetime ë³€í™˜ ì°¨íŠ¸](../2025-09-13-18-14-25.png)

íŒ€ì—ì„œ `datetime(2)`, `datetime`, `timestamp` ë“± ë‹¤ì–‘í•œ ì‹œê°„ íƒ€ì…ì„ ì‚¬ìš©í•˜ê³  ìˆì–´, ì´ë¥¼ í†µí•© ì²˜ë¦¬í•˜ëŠ” ì „ëµì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤.

### í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì ì‘í˜• ë³€í™˜ ë¡œì§
```kotlin
fun parseDebeziumTimestamp(value: Long): OffsetDateTime {
    val absValue = kotlin.math.abs(value)
    
    return when {
        absValue <= 9999999999L -> {
            // 1~10ìë¦¬: ì´ˆ ë‹¨ìœ„ (1653ë…„~2286ë…„)
            Instant.ofEpochSecond(value).atOffset(ZoneOffset.UTC)
        }
        absValue <= 9999999999999L -> {
            // 11~13ìë¦¬: ë°€ë¦¬ì´ˆ ë‹¨ìœ„
            Instant.ofEpochMilli(value).atOffset(ZoneOffset.UTC)
        }
        else -> {
            // 14~16ìë¦¬: ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„  
            val seconds = value / 1_000_000
            val nanos = (value % 1_000_000) * 1000
            Instant.ofEpochSecond(seconds, nanos).atOffset(ZoneOffset.UTC)
        }
    }
}
```

### í•œê³„ì  ë° ê·¹ë‹¨ê°’ ì²˜ë¦¬
- **2280ë…„ ë¬¸ì œ**: ìë¦¿ìˆ˜ êµ¬ë¶„ë²•ì˜ ìœ íš¨ ê¸°ê°„
- **9999ë…„ 12ì›” 31ì¼**: ì‹¤ì œ ì‚¬ìš© ì¤‘ì¸ ê·¹ë‹¨ê°’
- **1970ë…„ ì´ì „ ë°ì´í„°**: ìŒìˆ˜ íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬

### ê¶Œì¥ í•´ê²°ì±…: ì‹œê°„ íƒ€ì… í‘œì¤€í™”
```properties
# ëª¨ë“  ì‹œê°„ ì»¬ëŸ¼ì„ ë°€ë¦¬ì´ˆë¡œ í†µì¼
debezium.source.time.precision.mode=connect

# MySQL DDL í‘œì¤€í™”
ALTER TABLE orders MODIFY created_at DATETIME(3);
ALTER TABLE orders MODIFY updated_at DATETIME(3);
```

ì´ë ‡ê²Œ í•˜ë©´ ëª¨ë“  ì‹œê°„ ë°ì´í„°ê°€ ë°€ë¦¬ì´ˆ ë‹¨ìœ„ë¡œ í†µì¼ë˜ì–´ ë³€í™˜ ë¡œì§ì´ ë‹¨ìˆœí•´ì§‘ë‹ˆë‹¤.

# 8. ìš´ì˜ ê·œì¹™ ë° ì •ì±…

## 8.1. ë°ì´í„° Sink ì •ì±…

### sinkedAt ê¸°ì¤€ ì²˜ë¦¬ ê·œì¹™
```kotlin
/**
 * sinkedAtì€ binlog event ë°œìƒ ì‹œì ì„ ì˜ë¯¸
 * ê¸°ì¡´ ë¬¸ì„œë³´ë‹¤ ì´ì „ ì‹œì ì˜ ë°ì´í„°ê°€ ë„ì°©í•´ë„ ê·¸ëŒ€ë¡œ sink ìˆ˜í–‰
 * ì´ìœ : SELECT ì¿¼ë¦¬ ë„¤íŠ¸ì›Œí¬ ë¹„ìš© ì ˆì•½
 */
override fun shouldSkipOldData(newData: DebeziumMessage<T>): Boolean {
    // í˜„ì¬ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ ë¹„êµ ì—†ì´ ëª¨ë“  ë°ì´í„° ì²˜ë¦¬
    return false
}
```

### ì¬ì‹œë„ ì •ì±…
- **1íšŒ ì¬ì‹œë„**: Sink ì‹¤íŒ¨ ì‹œ 1íšŒì— í•œí•´ ì¬ì‹œë„
- **ìµœì¢… ì²˜ë¦¬**: ì¬ì‹œë„ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ Pending & Streamì—ì„œ ì œê±°
- **ë°ì´í„° ì •ì •**: ì •í™•í•œ ë°ì´í„° í•„ìš” ì‹œ ë³„ë„ ì¬ì²˜ë¦¬ ì „ëµ ìˆ˜ë¦½ í•„ìš”

### ë©”ëª¨ë¦¬ ê´€ë¦¬
- **Stream ì •ë¦¬**: Sink ì„±ê³µ ì‹œ ì¦‰ì‹œ Streamì—ì„œ ì œê±°í•˜ì—¬ ë©”ëª¨ë¦¬ í™•ë³´
- **Pending ê´€ë¦¬**: ì‹¤íŒ¨ ë©”ì‹œì§€ëŠ” PEL(Pending Entries List)ì—ì„œ ê´€ë¦¬

## 8.2. ë¹„ì •ê·œí™” ì „ëµ

### Order â†” OrderItem ê´€ê³„ ì²˜ë¦¬
```kotlin
/**
 * Order ë¬¸ì„œì— OrderItemì„ ë°°ì—´ë¡œ í¬í•¨í•˜ëŠ” ë¹„ì •ê·œí™” êµ¬ì¡°
 * ì£¼ì˜ì‚¬í•­: OrderItemì´ Orderë³´ë‹¤ ë¨¼ì € ìƒì„±ë  ìˆ˜ ìˆìŒ
 */
@Document(collection = "sink_orders")
data class SinkOrder(
    val orderId: Long,
    val items: List<SinkOrderItem> = emptyList(),  // ë¹„ì •ê·œí™”ëœ ì£¼ë¬¸ ì•„ì´í…œë“¤
    // ...
)

// OrderItem CDC ì²˜ë¦¬ ì‹œ ë¶€ëª¨ Order ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”
```

### ì²˜ë¦¬ ìˆœì„œ ê³ ë ¤ì‚¬í•­
1. **OrderItem ë¨¼ì € ë„ì°©**: ì„ì‹œ Order ë¬¸ì„œ ìƒì„± í›„ Item ì¶”ê°€
2. **Order ë‚˜ì¤‘ ë„ì°©**: ê¸°ì¡´ Order ë¬¸ì„œ ì—…ë°ì´íŠ¸ ë° Item ë³‘í•©
3. **ë™ì‹œ ì²˜ë¦¬**: íŠ¸ëœì­ì…˜ ë˜ëŠ” Lockì„ í†µí•œ ì¼ê´€ì„± ë³´ì¥

## 8.3. ìŠ¤í‚¤ë§ˆ ì§„í™” ëŒ€ì‘

### Row ë°ì´í„° í´ë˜ìŠ¤ ì„¤ê³„ ì›ì¹™
```kotlin
/**
 * RDBMS DDL ë³€ê²½ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•˜ê¸° ìœ„í•œ ì„¤ê³„
 * ëª¨ë“  í•„ë“œë¥¼ null í—ˆìš©ìœ¼ë¡œ ì„ ì–¸
 */
@JsonIgnoreProperties(ignoreUnknown = true)  // ì‹ ê·œ í•„ë“œ ë¬´ì‹œ
data class FlexibleRow(
    val id: Long?,                    // PKë„ null í—ˆìš© (DDL ë³€ê²½ ëŒ€ë¹„)
    val name: String?,                // ëª¨ë“  í•„ë“œ nullable
    val newField: String? = null,     // ì‹ ê·œ í•„ë“œëŠ” ê¸°ë³¸ê°’ê³¼ í•¨ê»˜
    val deprecatedField: String?      // ì œê±° ì˜ˆì • í•„ë“œë„ ìœ ì§€
)
```

### DDL ë³€ê²½ ì‹œ ëŒ€ì‘ ì ˆì°¨
1. **Row í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸**: ì‹ ê·œ í•„ë“œ ì¶”ê°€ (nullable)
2. **Entity í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸**: MongoDB ìŠ¤í‚¤ë§ˆ ë°˜ì˜  
3. **SinkConnector ë¡œì§ ìˆ˜ì •**: ë³€í™˜ ë¡œì§ ì—…ë°ì´íŠ¸
4. **í…ŒìŠ¤íŠ¸ ì¶”ê°€**: ì‹ ê·œ í•„ë“œ ì²˜ë¦¬ ê²€ì¦
5. **ì ì§„ì  ë°°í¬**: Canary ë°°í¬ë¡œ ì•ˆì „ì„± í™•ì¸

# 9. ë§ˆë¬´ë¦¬ ë° ë‹¤ìŒ ë‹¨ê³„

## 9.1. í˜„ì¬ êµ¬í˜„ ì™„ë£Œ ì‚¬í•­
- âœ… **CDC íŒŒì´í”„ë¼ì¸**: MySQL â†’ Debezium â†’ Redis Stream â†’ MongoDB
- âœ… **ì„±ëŠ¥ ìµœì í™”**: ë²Œí¬ ì²˜ë¦¬ë¡œ 5ë°° ì„±ëŠ¥ í–¥ìƒ  
- âœ… **ë©”ëª¨ë¦¬ ê´€ë¦¬**: Redis OOM ë°©ì§€ ë° ìœ ëŸ‰ì œì–´
- âœ… **ë™ì  ìŠ¤ì¼€ì¼ë§**: ì‹¤ì‹œê°„ í…Œì´ë¸” ì¶”ê°€ ì§€ì›
- âœ… **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: Kotest + Testcontainers ì¢…í•© í…ŒìŠ¤íŠ¸
- âœ… **ëª¨ë‹ˆí„°ë§**: ìš´ì˜ ì§€í‘œ ë° ì•Œë¦¼ ì²´ê³„

## 9.2. í–¥í›„ ê°œì„  ê³¼ì œ

### ê³ ê°€ìš©ì„± (High Availability)
- [ ] Debezium Server ë‹¤ì¤‘í™” (Active-Standby)
- [ ] Redis Cluster êµ¬ì„±ìœ¼ë¡œ SPOF ì œê±°
- [ ] MongoDB Replica Set ì—°ë™

### ìŠ¤ì¼€ì¼ë§ ëŒ€ì‘
- [ ] Sink Pod ìˆ˜í‰ í™•ì¥ (Stream íŒŒí‹°ì…”ë‹)
- [ ] í…Œì´ë¸”ë³„ ë…ë¦½ì ì¸ CDC íŒŒì´í”„ë¼ì¸
- [ ] ëŒ€ìš©ëŸ‰ í…Œì´ë¸” ì²­í¬ ë¶„í•  ì²˜ë¦¬

### ìš´ì˜ ìë™í™”
- [ ] ì¥ì•  ìë™ ë³µêµ¬ ì‹œìŠ¤í…œ
- [ ] ë°ì´í„° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§
- [ ] ì„±ëŠ¥ íŠœë‹ ìë™í™”

### ë°ì´í„° ê±°ë²„ë„ŒìŠ¤
- [ ] ë°ì´í„° ê³„ë³´ ì¶”ì  (Data Lineage)
- [ ] GDPR ëŒ€ì‘ (ê°œì¸ì •ë³´ ë§ˆìŠ¤í‚¹)
- [ ] ê°ì‚¬ ë¡œê·¸ ì²´ê³„

## 9.3. ìš´ì˜íŒ€ ì¸ìˆ˜ì¸ê³„ ì‚¬í•­

### ì¼ìƒ ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] **ë§¤ì¼**: Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
- [ ] **ë§¤ì¼**: Stream ì§€ì—° ì‹œê°„ ëª¨ë‹ˆí„°ë§  
- [ ] **ì£¼ê°„**: Sink ì—ëŸ¬ìœ¨ ë¶„ì„
- [ ] **ì›”ê°„**: ì„±ëŠ¥ íŠ¸ë Œë“œ ë¦¬ë·°

### ì¥ì•  ëŒ€ì‘ ì ˆì°¨ì„œ
1. **CDC ì¤‘ë‹¨ ì‹œ**: binlog position í™•ì¸ â†’ Debezium ì¬ì‹œì‘
2. **Redis OOM ì‹œ**: ë©”ëª¨ë¦¬ ì •ì±… í™•ì¸ â†’ ìœ ëŸ‰ì œì–´ ì¡°ì •
3. **Sink ì§€ì—° ì‹œ**: ë²Œí¬ ì²˜ë¦¬ í¬ê¸° ì¡°ì • â†’ Pod ìŠ¤ì¼€ì¼ë§

### ë¬¸ì˜ ì—°ë½ì²˜ ë° ë¬¸ì„œ
- **ê¸°ìˆ  ë¬¸ì˜**: [ë‹´ë‹¹ì Slack ì±„ë„]
- **ì¥ì•  ëŒ€ì‘**: [On-call ìˆœë²ˆí‘œ]
- **ìƒì„¸ ë¬¸ì„œ**: [Confluence ë§í¬]

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-09-26  
**ë¬¸ì„œ ë²„ì „**: v2.0  
**ì‘ì„±ì**: [Your Name]

