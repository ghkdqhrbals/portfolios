---
layout: default
title: Mock vs Stub vs Spy ì •ë¦¬
date: 2024-02-11
parent: ğŸ“Œ Server
nav_order: 14
---

created at 2024-02-11
{: .label .label-yellow }

{: .no_toc .text-delta }

1. TOC
{:toc}

í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì§œë‹¤ë³´ë©´ í”íˆ Mock, Stub, í…ŒìŠ¤íŠ¸ ë”ë¸” ë“±ë“± ì—¬ëŸ¬ê°€ì§€ ìš©ì–´ë¥¼ ë“£ê²Œ ë©ë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ì´ëŸ¬í•œ ìš©ì–´ë“¤ì„ ì •ë¦¬í•´ë³´ë©´ì„œ ë¹„êµí•´ë³´ê² ìŠµë‹ˆë‹¤. 
ì˜ˆì‹œì™€ í•¨ê»˜ ë§ì´ì£ !
> ë³¸ í¬ìŠ¤íŒ…ì—ì„œ ì‚¬ìš©ë˜ëŠ” ìš©ì–´ì™€ ê·¸ ì˜ë¯¸, ì˜ˆì‹œë“¤ì€ ë§ˆí‹´ íŒŒìš¸ëŸ¬ì”¨ì˜ [Mocks Aren't Stubs](https://martinfowler.com/articles/mocksArentStubs.html) ë¥¼ ì°¸ê³ í•˜ì—¬ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!

## ìš©ì–´ ì •ë¦¬

### í…ŒìŠ¤íŠ¸ ëŒ€ì—­(Test Double)
í…ŒìŠ¤íŠ¸ ë”ë¸”ì€ ì†Œí”„íŠ¸ì›¨ì–´ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹¤ì œ ê°ì²´ë¥¼ ëŒ€ì‹ í•˜ì—¬ ì‚¬ìš©ë˜ëŠ” ê°€ìƒì˜ ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ëŠ” ì¼ë°˜ì ì¸ ìš©ì–´ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì‹¤ì²´ ê°ì²´ì˜ "ëŒ€ì—­" ì´ì£ . 
ì´ëŸ¬í•œ í…ŒìŠ¤íŠ¸ ë”ë¸”ì€ ì£¼ë¡œ ì˜ì¡´ì„±ì„ ì œê±°í•˜ê±°ë‚˜ íŠ¹ì •í•œ ë™ì‘ì„ ê°€ìƒìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° ìœ„í•´ í…ŒìŠ¤íŠ¸ ì‹œì— ì‚¬ìš©ë©ë‹ˆë‹¤.
Test double ìš©ì–´ë¥¼ ë§Œë“  Meszaros ëŠ” stunt double(ìŠ¤í„´íŠ¸ ëŒ€ì—­) ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ê°€ì ¸ì™”ë‹¤ê³  í•©ë‹ˆë‹¤. 
í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì—ëŠ” ëª‡ ê°€ì§€ ëŒ€í‘œì ì¸ í…ŒìŠ¤íŠ¸ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

### **Mock**:
Mock ì€ ì‚¬ì „ì— ê¸°ëŒ€ì¹˜ë¥¼ ê°€ì§€ê³  ìˆì–´ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œì— ëŒ€í•œ ê²€ì¦ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ë©”ì†Œë“œ ë‚´ì—ì„œ when ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œì— ëŒ€í•œ ë°˜í™˜ê°’ì„ ì§€ì •í•˜ê³ , verify ë¡œ ê²€ì¦í•  ìˆ˜ ìˆë‹µë‹ˆë‹¤.

```java
class OrderInteractionTester {
  public void testOrderSendsMailIfUnfilled() {
    Order order = new Order(TALISKER, 51);
    Mock warehouse = mock(Warehouse.class);
    Mock mailer = mock(MailService.class);
    order.setMailer((MailService) mailer.proxy());

    mailer.expects(once()).method("send");
    warehouse.expects(once()).method("hasInventory")
      .withAnyArguments()
      .will(returnValue(false));

    order.fill((Warehouse) warehouse.proxy());
  }
}
```

reference : [https://martinfowler.com/articles/mocksArentStubs.html](https://martinfowler.com/articles/mocksArentStubs.html)

### **Stub**:
ì‹¤ì œë¡œ ì¤€ë¹„ëœ ê°€ì§œ ë°˜í™˜ ê°’ì„ í˜¸ì¶œí•©ë‹ˆë‹¤. `ex) StubUserRepository Overriding`
í…ŒìŠ¤íŠ¸ ì¤‘ì— í˜¸ì¶œëœ ë©”ì„œë“œì— ëŒ€í•´ **ì¤€ë¹„ëœ ë°˜í™˜ê°’**ì„ ì œê³µí•©ë‹ˆë‹¤.

```java
class OrderStateTester {
    public void testOrderSendsMailIfUnfilled() {
        Order order = new Order(TALISKER, 51);
        MailServiceStub mailer = new MailServiceStub();
        order.setMailer(mailer);
        order.fill(warehouse);
        assertEquals(1, mailer.numberSent());
}
```

Mock ê³¼ ë¹„ìŠ·í•˜ì£ ? í•˜ì§€ë§Œ ë‹¤ë¥´ë‹µë‹ˆë‹¤. ë§ˆí‹´ íŒŒìš¸ëŸ¬ì”¨ê°€ ë§í•˜ê¸¸ Stub ì€ **ìƒíƒœ ê²€ì¦**, Mock ì€ **í–‰ìœ„ ê²€ì¦**ì´ë¼ê³  í•©ë‹ˆë‹¤.

> In both cases I'm using a test double instead of the real mail service. There is a difference in that the stub uses **state verification** while the mock uses **behavior verification**.
> 
> In order to use state verification on the stub, I need to make some extra methods on the stub to help with verification. As a result the stub implements MailService but adds extra test methods.
>
> Mock objects always use behavior verification, a stub can go either way. Meszaros refers to stubs that use behavior verification as a Test Spy. The difference is in how exactly the double runs and verifies and I'll leave that for you to explore on your own.
> 
> reference : [https://martinfowler.com/articles/mocksArentStubs.html](https://martinfowler.com/articles/mocksArentStubs.html)

ì¢…í•©í•´ë³´ë©´ **Mock ì€ ë©”ì†Œë“œ ì‹¤í–‰ íšŸìˆ˜, ì…ë ¥ë˜ëŠ” íŒŒë¼ë¯¸í„°** ë¥¼ ê²€ì¦í•˜ê³ , Stub ì€ **ë°˜í™˜ê°’** ì„ ê²€ì¦í•©ë‹ˆë‹¤.

ê·¸ë˜ì„œ ìš°ë¦¬ê°€ í”íˆ í•˜ëŠ” ì•„ë˜ í…ŒìŠ¤íŠ¸ì˜ ê²½ìš°, Mock & Stub í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ìˆëŠ”ê²ƒì´ì£ .

```java
@ExtendWith(MockitoExtension.class)
class UserContextInterceptorTest {
    @Mock
    private JwtTokenValidator jwtTokenValidator;
    @Mock
    private UserRedisSessionRepository userRedisSessionRepository;
    @InjectMocks
    private UserContextInterceptor interceptor;
    @Test
    @DisplayName("preHandle ì€ ìœ íš¨í•œ refresh token ì´ ì¿ í‚¤ì— ìˆì„ ë•Œ true ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤")
    void testPreHandle_WithValidRefreshToken_ShouldReturnTrue() throws Exception {

        // given
        MockHttpServletRequest request = new MockHttpServletRequest();
        MockHttpServletResponse response = new MockHttpServletResponse();
        request.setCookies(new Cookie("refreshToken", "valid_token"));
        request.setRequestURI("/some-path");
        request.setMethod("GET");

        // when
        when(jwtTokenValidator.validateToken("valid_token")).thenReturn("user123"); // Mock ê°ì²´ì— ë°˜í™˜ ê°’ì„ ì •ì˜í•˜ëŠ” Stub
        boolean result = interceptor.preHandle(request, response, null);

        // then
        assertTrue(result); 
        assertThat(UserContext.getUserId()).isEqualTo("user123"); // ìƒíƒœ ê²€ì¦
        verify(userRedisSessionRepository, never()).findById(anyString()); // í–‰ìœ„ ê²€ì¦
    }
}
```

### **Spy**:
ì¼ë¶€ë§Œ Stubbing(ë°˜í™˜ ê°’ì„ ì •ì˜í•˜ëŠ” Stub ê³¼ì •) ë˜ì–´ ìˆëŠ” ì‹¤ì œ ê°ì²´ì…ë‹ˆë‹¤. 
ì´ Spy ëŠ” ì‹¤ì œ ê°ì²´ë¥¼ ê°ì‹œí•˜ê±°ë‚˜ ëª¨ë‹ˆí„°ë§í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ê°ì²´ë¡œ, ì‹¤ì œ ê°ì²´ì˜ íŠ¹ì • ë©”ì„œë“œ í˜¸ì¶œì„ ì¶”ì í•˜ê³ , í˜¸ì¶œëœ íšŸìˆ˜ë¥¼ ì„¸ê±°ë‚˜ í˜¸ì¶œëœ ì¸ìë¥¼ ê¸°ë¡í•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. 
ìŠ¤íŒŒì´ëŠ” ê°ì²´ì˜ ìƒíƒœë‚˜ ë™ì‘ì„ í™•ì¸í•˜ê³  ê²€ì¦í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

