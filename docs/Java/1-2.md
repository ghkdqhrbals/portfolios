---
layout: default
title: KafkaMQ ì˜ ì•„í‚¤í…ì²˜ì™€ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹
date: 2022-12-02
parent: ğŸ“Œ Server
---


{: .no_toc .text-delta }

{:toc}

# Kafka
## ì•„í‚¤í…ì²˜

![kafka](../../../assets/img/kafka/image.png)

## ìš©ì–´ ì„¤ëª…
* **Producer** : ì´ë²¤íŠ¸ë¥¼ ë³´ë‚´ëŠ” ì£¼ì²´
* **Consumer**: í† í”½ì˜ íŒŒí‹°ì…˜ì— ì €ì¥ë˜ì–´ ìˆëŠ” ë©”ì‹œì§€ë¥¼ ì†Œë¹„(consume)í•˜ëŠ” ì—­í• .
* **Consumer Group** : í•˜ë‚˜ì˜ Topicì˜ ëª¨ë“  íŒŒí‹°ì…˜ë“¤ì„ êµ¬ë…í•˜ëŠ” consumer ê·¸ë£¹.
* **Partition** : Producerë¡œë¶€í„° ì „ë‹¬ë°›ì€ ë©”ì„¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ê³µê°„
  * Leader Partition : ì‹¤ì§ˆì ìœ¼ë¡œ Producer/Consumerì™€ í†µì‹ í•˜ëŠ” íŒŒí‹°ì…˜
  * Follower Partition : Leader Partitionì˜ ë°ì´í„°ë¥¼ ë³µì œí•˜ì—¬ ì €ì¥í•˜ëŠ” íŒŒí‹°ì…˜. ê·¸ë˜ì„œ Leader Partitionì— ì¥ì• ê°€ ìƒê²¼ì„ ë•Œ, Follower Partitionì´ ë¦¬ë”ë¡œ ìŠ¹ê²©ê°€ëŠ¥.
* **Broker** = ì¹´í”„ì¹´ ì„œë²„ : í† í”½ê³¼ íŒŒí‹°ì…˜ë“¤ì„ ê´€ë¦¬í•˜ëŠ” ì—­í• .
  * Controller : í•˜ë‚˜ì˜ ë¸Œë¡œì»¤ê°€ ì´ ì—­í• ì„ ë§¡ëŠ”ë‹¤. ë¦¬ë” íŒŒí‹°ì…˜ì´ ë¬¸ì œ ìˆì„ ë•Œ, Follow Partitionì„ Leaderë¡œ ìŠ¹ê²©ì‹œì¼œì£¼ëŠ” ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.
  * Coordinator : í•˜ë‚˜ì˜ ë¸Œë¡œì»¤ê°€ ì´ ì—­í• ì„ ë§¡ëŠ”ë‹¤. ì¥ì• ë¡œ ì¸í•´ íŠ¹ì • íŒŒí‹°ì…˜ì˜ ë©”ì„¸ì§€ê°€ ì†Œë¹„ë˜ì§€ ì•Šì„ ë•Œ, ë‹¤ë¥¸ Consumerì— ë§¤ì¹­ì‹œí‚¤ëŠ” ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.
* **Topic** : ë©”ì„¸ì§€ì˜ ì£¼ì œ
* **Offset** : íŒŒí‹°ì…˜ ë‚´ ë©”ì„¸ì§€ ìœ„ì¹˜.
* **Kafka Cluster** : = Kafka ì„œë²„(Broker)ì˜ ëª¨ì„
* **Event** : = Message
* **Zookeeper** : ì¹´í”„ì¹´ ë©”íƒ€ë°ì´í„° ì €ì¥ ë° **ê´€ë¦¬** ì„œë²„. [[How Kafka and ZooKeeper Work Together]](https://www.openlogic.com/blog/using-kafka-zookeeper)
  * Broker ê´€ë¦¬
    * Broker ìƒì„±/ì‚­ì œ/ì¥ì• ê°ì§€
    * Broker Controller/Coordinator ì„ ì •
  * Topic ê´€ë¦¬
    * Topic ë³„ ê¶Œí•œ ì„¤ì •
    * ìš”ì²­ ì¿¼í„° ê´€ë¦¬

* **Replication Factor** : Topicë³„ë¡œ ì²˜ë¦¬í•˜ëŠ” Broker ê°œìˆ˜ë¥¼ ì •í•˜ëŠ” ê³„ìˆ˜.
> 3ëŒ€ì˜ Brokerë¡œ ì²˜ë¦¬í•˜ë„ë¡ í•˜ë©´, Brokerì´ ì¥ì•  ì‹œ ë‹¤ë¥¸ Brokerê°€ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ë„ì™€ì¤€ë‹¤. Topicì˜ ì¤‘ìš”ë„ì— ë”°ë¼ Broker ì„¤ì •í•´ì•¼í•¨.

## ë™ì‘ ë°©ì‹
1. í´ë¼ì´ì–¸íŠ¸ê°€ ë©”ì„¸ì§€ë¥¼ Producerì—ê²Œ ì „ì†¡
2. Producerê°€ ë©”ì„¸ì§€ë¥¼ batch size ë§Œí¼ í† í”½ì˜ íŠ¹ì • íŒŒí‹°ì…˜ì˜ ë¦¬ë”ì— ì €ì¥í•œë‹¤.
   * ì´ ë•Œ, íŒŒí‹°ì…˜ì˜ ë¦¬ë”/íŒ”ë¡œìš° ë“¤ì€ ISR(In Sync Replica)ë¡œ  ë¬¶ì—¬ ìˆìœ¼ë©°, ì„œë¡œ ë°ì´í„° ì‹±í¬ë¥¼ ë§ì¶”ê²Œ ëœë‹¤.
3. ê°ê°ì˜ ë¸Œë¡œì»¤ì™€ ì—°ê²°ëœ Consumerê°€ ì´ë¥¼ í•„ìš”í•  ë•Œ ì½ìœ¼ë©´ì„œ ì´ë²¤íŠ¸ë¥¼ í•¸ë“¤ë§í•œë‹¤. ì´ ë•Œ, Brokerì€ ì „ë‹¬ëœ ì´ë²¤íŠ¸ì˜ ë©”íƒ€ ë°ì´í„°ë¥¼ ê¸°ë¡í•œë‹¤.

## ê¸°íƒ€ ìš©ì–´
* **batching** : Producer/Consumerì´ ì—¬ëŸ¬ê°œì˜ ë©”ì„¸ì§€ë¥¼ ë¬¶ì–´ì„œ Kafkaì— ì „ì†¡/ìˆ˜ì‹ í•˜ëŠ” ê¸°ëŠ¥.
  * ì´ë¥¼ ì´ìš©í•˜ë©´ ìš”ì²­ë³„ë¡œ ë°œìƒí•˜ëŠ” ì˜¤ë²„í—¤ë“œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.
* **request quota**(ìš”ì²­ ì¿¼í„°) : Brokerë³„ë¡œ íŠ¹ì • í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡/ìˆ˜ì‹ ë°›ì„ ìˆ˜ ìˆëŠ” ìì›ì–‘ì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥. **í•˜ë‚˜ì˜ ì‚¬ìš©ìë¡œ ì¸í•œ ì„œë²„ ë¶€í•˜ ë°©ì§€ ê°€ëŠ¥.**
* **ë°ì´í„° ì˜ì†ì„± ë³´ì¥** : ë©”ì‹œì§€ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ì— ì €ì¥í•˜ëŠ” ê¸°ë³¸ ë©”ì‹œì§• ì‹œìŠ¤í…œê³¼ëŠ” ë‹¬ë¦¬ ë©”ì‹œì§€ë¥¼ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥í•œë‹¤. ê·¸ë˜ì„œ ë°ì´í„° ì˜ì†ì„±ì´ ë³´ì¥ëœë‹¤.
* **Consumer pull ë°©ì‹** : ê¸°ì¡´ì˜ ë©”ì‹œì§• ì‹œìŠ¤í…œì—ì„œëŠ” Brokerê°€ Consumerì—ê²Œ ë©”ì‹œì§€ë¥¼ Pushí•´ì£¼ëŠ” ë°©ì‹ì¸ë° ë°˜í•´, KafkaëŠ” **Consumerê°€ Brokerë¡œë¶€í„° ì§ì ‘ ë©”ì‹œì§€ë¥¼ ê°€ì§€ê³  ê°€ëŠ” pullë°©ì‹ìœ¼ë¡œ ë™ì‘**í•œë‹¤.
  * ì´ë¥¼ ì´ìš©í•˜ë©´ Consumerì€ ìì‹ ì˜ ë©”ì„¸ì§€ ì²˜ë¦¬ ì„±ëŠ¥ì— ë”°ë¼ ìµœì ìœ¼ë¡œ ë©”ì„¸ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œëœë‹¤.

## ì¥ì 
* Leader/Follow ë•ì— ì•ˆì •ì ìœ¼ë¡œ ì„œë²„ ìš´ì˜ ê°€ëŠ¥. SPOF ë°©ì§€.
> ì˜ˆì‹œ ì‹œë‚˜ë¦¬ì˜¤ - ë§Œì•½ íŒŒí‹°ì…˜ì´ë‚˜ Controller ë¸Œë¡œì»¤ê°€ ë‹¤ìš´ëœë‹¤ë©´?!
> 1. Zookeeperì—ì„œ Controller Broker ì¥ì•  ê°ì§€. ìƒˆë¡œìš´ Controller Broker ì„ ì¶œ.
> 2. ì„ ì¶œ ëœ Controller Brokerì€ Zookeeperë‚´ stateë³€í™”(ì¥ì• ë°œìƒ Brokerì— í• ë‹¹ëœ Leader Partition ìƒíƒœ ë³€í™”) ê°ì§€.
> 3. ë‹¤ë¥¸ Brokerë“¤ì—ê²Œ ì¥ì• ë°œìƒëœ Leader Partitionì˜ Follow Partitionë“¤ì„ ë°›ì•„ì™€ì„œ ì´ ì¤‘ í•˜ë‚˜ë¥¼ Leaderë¡œ ìŠ¹ê²©. [[Controller Broker]](https://jaceklaskowski.gitbooks.io/apache-kafka/content/kafka-controller.html)

* Topic ë³„ ë°ì´í„°ë¥¼ ë¬¶ì–´ì„œ ì²˜ë¦¬í•˜ê¸°ì— ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŒ.
> ì˜ˆì‹œ : ì˜¨ë¼ì¸ ìƒí’ˆ êµ¬ë§¤ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì¬ê³  ìˆ˜ëŸ‰ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë˜ë‚˜(Producer `Remain`.batch_size = 0), êµ¬ë§¤ ë¡œê·¸(Producer `Remain`.batch_size = 50)ëŠ” ì‹¤ì‹œê°„ ì²˜ë¦¬ ë³´ë‹¤ëŠ” ë°°ì¹˜ ì²˜ë¦¬í•œë‹¤.

## ë©”ì„¸ì§€ ì²˜ë¦¬ ì „ëµ 3ê°€ì§€
![img.png](../img.png)
[reference](https://blog.bytebytego.com/p/at-most-once-at-least-once-exactly)

* Exaclty Once : ë©”ì„¸ì§€ê°€ ì •í™•íˆ í•œë²ˆ ì „ë‹¬ë˜ê³  ì²˜ë¦¬ë˜ëŠ” ì „ëµ.
  * ì˜¤ë²„í—¤ë“œê°€ ë§¤ìš° í¬ë‹¤. ì€í–‰ê³¼ ê°™ì´ ì •í™•í•œ ë°ì´í„° ì²˜ë¦¬ê°€ í•„ìš”í•œ ê³³ì—ì„œ ì‚¬ìš©. 
* At Least Once : ë©”ì„¸ì§€ê°€ ìµœì†Œ í•œë²ˆ ì „ë‹¬/ì²˜ë¦¬ ë˜ëŠ” ì „ëµ.
  * Producer/Consumer ë‘˜ ë‹¤ ë©”ì„¸ì§€ë¥¼ ì—¬ëŸ¬ë²ˆ ì½ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ë©±ë“±ì„±ì„ ê³ ë ¤í•´ì•¼í•œë‹¤.
* At Most Once : ë©”ì„¸ì§€ê°€ ìµœëŒ€ í•œë²ˆ ì „ë‹¬/ì²˜ë¦¬ ë˜ëŠ” ì „ëµ.
  * ë©”ì„¸ì§€ ì†ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆìŒ. ëª¨ë‹ˆí„°ë§ ë°ì´í„° ì²˜ë¦¬ì— ì¢‹ìŒ.


## ì£¼ì˜ì‚¬í•­
* Consumerì€ ë¸Œë¡œì»¤ì˜ ë©”ì„¸ì§€ë¥¼ ì—¬ëŸ¬ë²ˆ ì½ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ë©±ë“±ì„±ì„ ê³ ë ¤í•´ì•¼í•œë‹¤. Producer ë˜í•œ ë§ˆì°¬ê°€ì§€.


# Reference
* [https://velog.io/@jwpark06/Kafka-ì‹œìŠ¤í…œ-êµ¬ì¡°-ì•Œì•„ë³´ê¸°](https://velog.io/@jwpark06/Kafka-ì‹œìŠ¤í…œ-êµ¬ì¡°-ì•Œì•„ë³´ê¸°)
* [Setting client quotas - IBM Event Streams](https://ibm.github.io/event-streams/administering/quotas/)
* [https://jhleed.tistory.com/180](https://jhleed.tistory.com/180)
* [https://engineering.linecorp.com/ko/blog/how-to-use-kafka-in-line-1/](https://engineering.linecorp.com/ko/blog/how-to-use-kafka-in-line-1/)
* [https://galid1.tistory.com/793](https://galid1.tistory.com/793)
* [https://goyunji.tistory.com/125](https://goyunji.tistory.com/125)
* [https://jaceklaskowski.gitbooks.io/apache-kafka/content/kafka-brokers.html](https://jaceklaskowski.gitbooks.io/apache-kafka/content/kafka-brokers.html)